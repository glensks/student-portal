<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Password - Student Portal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Crimson+Pro:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
    --forest-900: #1b4332;
    --forest-800: #2d6a4f;
    --forest-700: #40916c;
    --forest-600: #52b788;
    --forest-100: #f1faee;
    --forest-200: #d8f3dc;
    --forest-300: #b7e4c7;
    --neutral-900: #1a1a1a;
    --neutral-700: #404040;
    --neutral-600: #666666;
    --neutral-400: #b3b3b3;
    --neutral-300: #d9d9d9;
    --neutral-200: #ededed;
    --neutral-100: #f7f7f7;
    --error: #dc2626;
    --success: #16a34a;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'DM Sans', sans-serif;
    background: var(--neutral-100);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    -webkit-font-smoothing: antialiased;
}

/* ---- Header ---- */
.portal-header {
    background: linear-gradient(135deg, var(--forest-900) 0%, var(--forest-800) 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.header-top {
    background: rgba(0,0,0,0.2);
    padding: 8px 0;
    font-size: 13px;
}
.header-top-content {
    max-width: 1200px; margin: 0 auto; padding: 0 24px;
    display: flex; justify-content: space-between; align-items: center;
}
.header-links { display: flex; gap: 20px; }
.header-links a { color: rgba(255,255,255,0.9); text-decoration: none; transition: color 0.2s; }
.header-links a:hover { color: white; }
.header-main {
    max-width: 1200px; margin: 0 auto; padding: 20px 24px;
    display: flex; align-items: center; gap: 16px;
}
.university-seal {
    width: 60px; height: 60px; background: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    flex-shrink: 0;
}
.university-info h1 {
    font-family: 'Crimson Pro', serif;
    font-size: 26px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 2px;
}
.university-info p { font-size: 13px; opacity: 0.9; font-weight: 500; }

/* ---- Page body ---- */
.page-body {
    flex: 1;
    display: flex; align-items: center; justify-content: center;
    padding: 48px 24px;
}

/* ---- Card ---- */
.card {
    background: white;
    border-radius: 16px;
    padding: 44px 40px;
    width: 100%; max-width: 460px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
}

/* ---- Card states ---- */
.state { display: none; animation: fadeUp 0.3s ease; }
.state.active { display: block; }
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* ---- Icon ---- */
.card-icon {
    width: 80px; height: 80px;
    background: linear-gradient(135deg, var(--forest-700), var(--forest-600));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px; margin: 0 auto 20px;
    box-shadow: 0 4px 16px rgba(64,145,108,0.3);
}
.card-title {
    font-family: 'Crimson Pro', serif;
    font-size: 26px; font-weight: 700;
    color: var(--forest-900); text-align: center; margin-bottom: 8px;
}
.card-subtitle { color: var(--neutral-600); font-size: 14px; text-align: center; margin-bottom: 32px; line-height: 1.6; }

/* ---- Form ---- */
.form-group { display: flex; flex-direction: column; margin-bottom: 20px; }
.form-label {
    font-size: 14px; font-weight: 600;
    color: var(--neutral-700); margin-bottom: 8px;
    display: flex; align-items: center; gap: 4px;
}
.required-mark { color: var(--error); }
.form-control {
    padding: 12px 14px;
    border: 1.5px solid var(--neutral-300);
    border-radius: 8px;
    font-family: inherit; font-size: 14px;
    transition: all 0.2s; background: white;
    width: 100%;
}
.form-control:hover { border-color: var(--forest-400, #95d5b2); }
.form-control:focus { outline: none; border-color: var(--forest-700); box-shadow: 0 0 0 3px rgba(64,145,108,0.1); }
.form-control::placeholder { color: var(--neutral-400); }

/* ---- Password strength ---- */
.strength-wrap { margin-top: 8px; }
.strength-bar {
    height: 5px; background: var(--neutral-200);
    border-radius: 10px; overflow: hidden; margin-bottom: 5px;
}
.strength-fill { height: 100%; width: 0; border-radius: 10px; transition: width 0.35s ease, background 0.35s ease; }
.strength-text { font-size: 12px; font-weight: 600; }

/* ---- Match hint ---- */
.match-hint { font-size: 13px; margin-top: 6px; min-height: 18px; }

/* ---- Button ---- */
.btn {
    width: 100%; padding: 14px;
    border: none; border-radius: 8px;
    font-family: inherit; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    margin-top: 8px;
}
.btn-primary {
    background: linear-gradient(135deg, var(--forest-700), var(--forest-600));
    color: white;
    box-shadow: 0 2px 8px rgba(64,145,108,0.25);
}
.btn-primary:hover { background: linear-gradient(135deg, var(--forest-800), var(--forest-700)); box-shadow: 0 4px 12px rgba(64,145,108,0.35); transform: translateY(-1px); }
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

/* ---- Message ---- */
.msg-box {
    padding: 13px 16px; border-radius: 8px;
    font-size: 14px; margin-top: 16px;
    display: none; align-items: center; gap: 10px;
    animation: fadeUp 0.3s ease;
}
.msg-box.error  { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; display: flex; }
.msg-box.success { background: #dcfce7; color: #15803d; border: 1px solid #86efac; display: flex; }

/* ---- Spinner ---- */
.spinner {
    width: 18px; height: 18px;
    border: 2.5px solid rgba(255,255,255,0.35);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ---- Success / Invalid screens ---- */
.big-icon { font-size: 56px; text-align: center; margin-bottom: 16px; }
.back-link {
    display: block; text-align: center;
    margin-top: 20px; font-size: 14px;
    color: var(--forest-700); text-decoration: none; font-weight: 600;
}
.back-link:hover { color: var(--forest-800); text-decoration: underline; }

/* ---- Footer ---- */
.portal-footer {
    max-width: 1200px; margin: 0 auto 20px; padding: 24px;
    text-align: center; color: var(--neutral-600); font-size: 13px;
    border-top: 1px solid var(--neutral-300);
}
.footer-links { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
.footer-links a { color: var(--forest-700); text-decoration: none; }
.footer-links a:hover { text-decoration: underline; }

@media (max-width: 520px) {
    .card { padding: 32px 22px; }
    .header-main { gap: 12px; }
    .university-info h1 { font-size: 20px; }
}

/* ---- Show/hide password ---- */
.input-wrap {
    position: relative;
    display: flex;
    align-items: center;
}
.input-wrap .form-control {
    padding-right: 44px;
    width: 100%;
}
.toggle-pw {
    position: absolute;
    right: 12px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: var(--neutral-400);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
    border-radius: 4px;
}
.toggle-pw:hover { color: var(--forest-700); }
.toggle-pw svg { width: 18px; height: 18px; }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="portal-header">
    <div class="header-top">
        <div class="header-top-content">
            <div class="header-links">
                <a href="#">University Website</a>
                <a href="#">Library</a>
                <a href="#">Support</a>
            </div>
            <div id="currentDate"></div>
        </div>
    </div>
    <div class="header-main">
        <div class="university-seal">ðŸŽ“</div>
        <div class="university-info">
            <h1>Student Information System</h1>
            <p>Academic Portal</p>
        </div>
    </div>
</header>

<!-- ===== MAIN ===== -->
<main class="page-body">
    <div class="card">

        <!-- STATE 1: Reset form -->
        <div class="state active" id="stateForm">
            <div class="card-icon">ðŸ”’</div>
            <h2 class="card-title">Create New Password</h2>
            <p class="card-subtitle">Enter your new password below. Make sure it's at least 8 characters long.</p>

            <div class="form-group">
                <label class="form-label" for="new_password">
                    New Password <span class="required-mark">*</span>
                </label>
                <div class="input-wrap">
                    <input type="password" id="new_password" class="form-control" placeholder="Minimum 8 characters" oninput="checkStrength()" autocomplete="new-password">
                    <button type="button" class="toggle-pw" onclick="togglePw('new_password', this)" tabindex="-1" title="Show/hide password">
                        <svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        <svg class="eye-hide" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                    </button>
                </div>
                <div class="strength-wrap" id="strengthWrap" style="display:none;">
                    <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
                    <span class="strength-text" id="strengthText"></span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="confirm_password">
                    Confirm Password <span class="required-mark">*</span>
                </label>
                <div class="input-wrap">
                    <input type="password" id="confirm_password" class="form-control" placeholder="Re-enter your new password" oninput="checkMatch()" autocomplete="new-password">
                    <button type="button" class="toggle-pw" onclick="togglePw('confirm_password', this)" tabindex="-1" title="Show/hide password">
                        <svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        <svg class="eye-hide" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                    </button>
                </div>
                <div class="match-hint" id="matchHint"></div>
            </div>

            <button class="btn btn-primary" id="submitBtn" onclick="submitReset()">
                Reset Password
            </button>
            <div class="msg-box" id="formMsg"></div>
        </div>

        <!-- STATE 2: Success -->
        <div class="state" id="stateSuccess">
            <div class="big-icon">âœ…</div>
            <h2 class="card-title">Password Reset!</h2>
            <p class="card-subtitle">
                Your password has been updated successfully.<br>
                You can now log in with your new password.
            </p>
            <a href="/login" class="btn btn-primary" style="text-decoration:none; margin-top:8px;">
                Go to Login
            </a>
        </div>

        <!-- STATE 3: Invalid / expired token -->
        <div class="state" id="stateInvalid">
            <div class="big-icon">â›”</div>
            <h2 class="card-title">Link Expired</h2>
            <p class="card-subtitle">
                This password reset link is invalid or has already expired.<br>
                Reset links are only valid for <strong>1 hour</strong>.
            </p>
            <a href="/login" class="btn btn-primary" style="text-decoration:none; margin-top:8px;">
                Request a New Link
            </a>
        </div>

    </div>
</main>

<!-- ===== FOOTER ===== -->
<footer class="portal-footer">
    <div class="footer-links">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
        <a href="#">Contact Support</a>
    </div>
    <p>&copy; 2024 University Student Information System. All rights reserved.</p>
</footer>

<script>
const API = "";

// ---- Date ----
const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', opts);

// ---- Show a state ----
function showState(id) {
    document.querySelectorAll('.state').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// ---- Verify token on load ----
const token = new URLSearchParams(window.location.search).get('token');

// Only block if there's literally no token in the URL.
// Don't pre-verify â€” just show the form and let the submit catch expired/invalid tokens.
if (!token) {
    showState('stateInvalid');
}
// stateForm is already active by default, so nothing else needed here.

// ---- Password strength ----
function checkStrength() {
    const pw = document.getElementById('new_password').value;
    const wrap = document.getElementById('strengthWrap');
    const fill = document.getElementById('strengthFill');
    const text = document.getElementById('strengthText');

    if (!pw) { wrap.style.display = 'none'; return; }
    wrap.style.display = 'block';

    let score = 0;
    if (pw.length >= 8)  score++;
    if (pw.length >= 12) score++;
    if (/[A-Z]/.test(pw)) score++;
    if (/[0-9]/.test(pw)) score++;
    if (/[^A-Za-z0-9]/.test(pw)) score++;

    const levels = [
        { pct:'20%', color:'#ef4444', label:'Very Weak' },
        { pct:'40%', color:'#f97316', label:'Weak' },
        { pct:'60%', color:'#eab308', label:'Fair' },
        { pct:'80%', color:'#22c55e', label:'Strong' },
        { pct:'100%',color:'#16a34a', label:'Very Strong' },
    ];
    const lvl = levels[Math.min(score - 1, 4)] || levels[0];
    fill.style.width    = lvl.pct;
    fill.style.background = lvl.color;
    text.textContent   = lvl.label;
    text.style.color   = lvl.color;

    // also re-check match if confirm has value
    if (document.getElementById('confirm_password').value) checkMatch();
}

// ---- Password match ----
function checkMatch() {
    const pw  = document.getElementById('new_password').value;
    const cfw = document.getElementById('confirm_password').value;
    const hint = document.getElementById('matchHint');
    if (!cfw) { hint.innerHTML = ''; return; }
    if (pw === cfw) {
        hint.innerHTML = '<span style="color:#16a34a;">âœ“ Passwords match</span>';
    } else {
        hint.innerHTML = '<span style="color:#dc2626;">âœ— Passwords do not match</span>';
    }
}

// ---- Submit ----
async function submitReset() {
    const btn   = document.getElementById('submitBtn');
    const msgEl = document.getElementById('formMsg');
    const pw    = document.getElementById('new_password').value;
    const cfw   = document.getElementById('confirm_password').value;

    // reset msg
    msgEl.className = 'msg-box';
    msgEl.innerHTML = '';

    if (!pw || pw.length < 8) {
        msgEl.className = 'msg-box error';
        msgEl.innerHTML = 'âš ï¸ Password must be at least 8 characters.';
        return;
    }
    if (pw !== cfw) {
        msgEl.className = 'msg-box error';
        msgEl.innerHTML = 'âš ï¸ Passwords do not match.';
        return;
    }

    const orig = btn.innerHTML;
    btn.innerHTML = '<span class="spinner"></span> Resetting...';
    btn.disabled = true;

    try {
        const res = await fetch(API + '/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, new_password: pw })
        });
        const data = await res.json();

        if (res.ok) {
            showState('stateSuccess');
        } else {
            // If token is invalid/expired, show the expired screen instead of an inline error
            if (data.error && (data.error.includes('expired') || data.error.includes('Invalid') || data.error.includes('already been used'))) {
                showState('stateInvalid');
            } else {
                msgEl.className = 'msg-box error';
                msgEl.innerHTML = 'âœ— ' + (data.error || 'Something went wrong. Please try again.');
            }
        }
    } catch (err) {
        msgEl.className = 'msg-box error';
        msgEl.innerHTML = 'âš ï¸ Unable to connect. Please check your connection.';
    } finally {
        btn.innerHTML = orig;
        btn.disabled  = false;
    }
}

// ---- Enter key ----
document.addEventListener('keypress', e => {
    if (e.key === 'Enter') submitReset();
});

// ---- Toggle show/hide password ----
function togglePw(fieldId, btn) {
    const input = document.getElementById(fieldId);
    const isHidden = input.type === 'password';
    input.type = isHidden ? 'text' : 'password';
    btn.querySelector('.eye-show').style.display = isHidden ? 'none' : '';
    btn.querySelector('.eye-hide').style.display = isHidden ? '' : 'none';
    btn.style.color = isHidden ? 'var(--forest-700)' : '';
}
</script>

</body>
</html>