<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Information System - Portal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Crimson+Pro:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
    --forest-900: #1b4332;
    --forest-800: #2d6a4f;
    --forest-700: #40916c;
    --forest-600: #52b788;
    --forest-500: #74c69d;
    --forest-400: #95d5b2;
    --forest-300: #b7e4c7;
    --forest-200: #d8f3dc;
    --forest-100: #f1faee;
    --neutral-900: #1a1a1a;
    --neutral-800: #2d2d2d;
    --neutral-700: #404040;
    --neutral-600: #666666;
    --neutral-500: #808080;
    --neutral-400: #b3b3b3;
    --neutral-300: #d9d9d9;
    --neutral-200: #ededed;
    --neutral-100: #f7f7f7;
    --accent-gold: #d4af37;
    --error: #dc2626;
    --success: #16a34a;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--neutral-100);
    color: var(--neutral-900);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
}
.portal-header {
    background: linear-gradient(135deg, var(--forest-900) 0%, var(--forest-800) 100%);
    color: white;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 100;
}
.header-top {
    background: rgba(0,0,0,0.2);
    padding: 8px 0;
    font-size: 13px;
}
.header-top-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.header-links { display: flex; gap: 20px; }
.header-links a { color: rgba(255,255,255,0.9); text-decoration: none; transition: color 0.2s; }
.header-links a:hover { color: white; }
.header-main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.university-brand { display: flex; align-items: center; gap: 16px; }
.university-seal {
    width: 60px; height: 60px;
    background: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.university-info h1 {
    font-family: 'Crimson Pro', serif;
    font-size: 26px; font-weight: 700;
    letter-spacing: -0.5px; margin-bottom: 2px;
}
.university-info p { font-size: 13px; opacity: 0.9; font-weight: 500; }
.header-actions { display: flex; gap: 12px; align-items: center; }
.help-link { color: white; text-decoration: none; font-size: 14px; opacity: 0.9; transition: opacity 0.2s; }
.help-link:hover { opacity: 1; }
.main-container { max-width: 1200px; margin: 32px auto; padding: 0 24px; }
.breadcrumb { font-size: 13px; color: var(--neutral-600); margin-bottom: 20px; }
.breadcrumb a { color: var(--forest-700); text-decoration: none; }
.portal-nav {
    background: white;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    display: flex;
    border-bottom: 2px solid var(--neutral-200);
}
.nav-tab {
    flex: 1; padding: 18px 24px;
    background: none; border: none;
    font-family: inherit; font-size: 15px; font-weight: 600;
    color: var(--neutral-600); cursor: pointer;
    position: relative; transition: all 0.2s;
    border-bottom: 3px solid transparent;
}
.nav-tab:hover { color: var(--forest-700); background: var(--forest-100); }
.nav-tab.active { color: var(--forest-800); border-bottom-color: var(--forest-700); background: white; }
.portal-content {
    background: white;
    padding: 40px;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    min-height: 600px;
}
.content-section { display: none; animation: fadeInUp 0.3s ease; }
.content-section.active { display: block; }
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.section-header { margin-bottom: 32px; }
.section-title { font-family: 'Crimson Pro', serif; font-size: 28px; font-weight: 700; color: var(--forest-900); margin-bottom: 8px; }
.section-description { color: var(--neutral-600); font-size: 15px; }
.alert-box {
    background: linear-gradient(135deg, var(--forest-100) 0%, var(--forest-200) 100%);
    border-left: 4px solid var(--forest-700);
    padding: 16px 20px; border-radius: 8px; margin-bottom: 28px;
    display: flex; gap: 12px; align-items: start;
}
.alert-icon { font-size: 20px; color: var(--forest-800); margin-top: 2px; }
.alert-content { flex: 1; }
.alert-title { font-weight: 600; color: var(--forest-900); margin-bottom: 4px; }
.alert-text { font-size: 14px; color: var(--neutral-700); }
.form-card {
    background: var(--neutral-100); border: 1px solid var(--neutral-200);
    border-radius: 10px; padding: 28px; margin-bottom: 24px;
}
.form-card-header {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 24px; padding-bottom: 16px;
    border-bottom: 2px solid var(--neutral-200);
}
.form-card-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--forest-700), var(--forest-600));
    border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 20px; color: white;
}
.form-card-title { font-size: 18px; font-weight: 700; color: var(--forest-900); }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
.form-group { display: flex; flex-direction: column; }
.form-label { font-size: 14px; font-weight: 600; color: var(--neutral-800); margin-bottom: 8px; display: flex; align-items: center; gap: 4px; }
.required-mark { color: var(--error); font-weight: 700; }
.form-control {
    padding: 12px 14px; border: 1.5px solid var(--neutral-300);
    border-radius: 8px; font-family: inherit; font-size: 14px;
    transition: all 0.2s; background: white;
}
.form-control:hover { border-color: var(--forest-400); }
.form-control:focus { outline: none; border-color: var(--forest-700); box-shadow: 0 0 0 3px rgba(64,145,108,0.1); }
.form-control::placeholder { color: var(--neutral-400); }
textarea.form-control { resize: vertical; min-height: 90px; font-family: inherit; }
select.form-control {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
    padding-right: 36px; appearance: none;
}
select[multiple] { background-image: none; padding: 8px; min-height: 200px; appearance: none; }
select[multiple] option { padding: 12px 14px; margin: 4px 0; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; border: 1px solid var(--neutral-200); }
select[multiple] option:checked { background: linear-gradient(135deg, var(--forest-700), var(--forest-600)) !important; color: white !important; font-weight: 600; border-color: var(--forest-700); }
.form-hint { font-size: 13px; color: var(--neutral-600); margin-top: 6px; display: flex; align-items: center; gap: 4px; }
.login-container { max-width: 480px; margin: 0 auto; }
.login-card { background: var(--neutral-100); border: 1px solid var(--neutral-200); border-radius: 12px; padding: 40px; }
.login-header { text-align: center; margin-bottom: 32px; }
.login-icon {
    width: 80px; height: 80px;
    background: linear-gradient(135deg, var(--forest-700), var(--forest-600));
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 36px; margin: 0 auto 16px;
    box-shadow: 0 4px 12px rgba(64,145,108,0.3);
}
.login-title { font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 700; color: var(--forest-900); margin-bottom: 6px; }
.login-subtitle { color: var(--neutral-600); font-size: 14px; }
.btn {
    padding: 14px 28px; border: none; border-radius: 8px;
    font-family: inherit; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-primary {
    background: linear-gradient(135deg, var(--forest-700), var(--forest-600));
    color: white;
    box-shadow: 0 2px 8px rgba(64,145,108,0.25);
}
.btn-primary:hover { background: linear-gradient(135deg, var(--forest-800), var(--forest-700)); box-shadow: 0 4px 12px rgba(64,145,108,0.35); transform: translateY(-1px); }
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
.btn-block { width: 100%; }
.btn-link {
    background: none; border: none; padding: 0;
    color: var(--forest-700); font-family: inherit; font-size: 14px;
    font-weight: 600; cursor: pointer; text-decoration: underline;
    text-decoration-color: transparent;
    transition: all 0.2s;
}
.btn-link:hover { color: var(--forest-800); text-decoration-color: var(--forest-800); }
.message-box {
    padding: 14px 18px; border-radius: 8px; margin-top: 20px;
    display: none; font-size: 14px; animation: slideDown 0.3s ease;
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
.message-box.success { background: #dcfce7; color: #15803d; border: 1px solid #86efac; display: flex; align-items: center; gap: 10px; }
.message-box.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; display: flex; align-items: center; gap: 10px; }
.spinner {
    width: 18px; height: 18px;
    border: 2.5px solid rgba(255,255,255,0.3);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.progress-indicator { background: white; border: 1px solid var(--neutral-200); border-radius: 8px; padding: 16px; margin-bottom: 24px; }
.progress-label { font-size: 13px; font-weight: 600; color: var(--neutral-700); margin-bottom: 8px; display: flex; justify-content: space-between; }
.progress-bar { height: 8px; background: var(--neutral-200); border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--forest-700), var(--forest-600)); border-radius: 10px; transition: width 0.4s ease; }
.selected-subjects { margin-top: 12px; padding: 12px; background: var(--forest-100); border-radius: 8px; border: 1px solid var(--forest-300); display: none; }
.selected-subjects.show { display: block; }
.selected-subjects-title { font-size: 13px; font-weight: 600; color: var(--forest-900); margin-bottom: 8px; }
.selected-subjects-list { display: flex; flex-wrap: wrap; gap: 8px; }
.subject-tag { background: linear-gradient(135deg, var(--forest-700), var(--forest-600)); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
.subject-tag-remove { cursor: pointer; font-weight: bold; opacity: 0.8; transition: opacity 0.2s; }
.subject-tag-remove:hover { opacity: 1; }

/* ---- Subject loading state ---- */
.subjects-loading { text-align: center; padding: 20px; color: var(--neutral-500); font-size: 14px; }
.subjects-prompt {
    text-align: center; padding: 20px;
    color: var(--neutral-500); font-size: 14px;
    border: 2px dashed var(--neutral-300);
    border-radius: 8px; background: var(--neutral-100);
}
.subjects-prompt .prompt-icon { font-size: 28px; margin-bottom: 8px; }

/* ---- Semester badge hint ---- */
.semester-hint {
    display: inline-block;
    font-size: 12px; font-weight: 600;
    padding: 2px 10px; border-radius: 20px;
    margin-left: 8px; vertical-align: middle;
}
.semester-hint.first { background: #dbeafe; color: #1d4ed8; }
.semester-hint.second { background: #ede9fe; color: #6d28d9; }

/* ==================== FORGOT PASSWORD LINK ==================== */
.forgot-password-row {
    display: flex;
    justify-content: flex-end;
    margin-top: 8px;
    margin-bottom: 20px;
}

/* ==================== MODAL ==================== */
.modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(4px);
    z-index: 999;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s ease;
}
.modal-overlay.open {
    opacity: 1; pointer-events: all;
}
.modal {
    background: white;
    border-radius: 16px;
    padding: 40px;
    width: 100%;
    max-width: 440px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    transform: translateY(20px) scale(0.97);
    transition: transform 0.25s ease;
    position: relative;
}
.modal-overlay.open .modal {
    transform: translateY(0) scale(1);
}
.modal-close {
    position: absolute;
    top: 16px; right: 16px;
    background: var(--neutral-200); border: none;
    width: 32px; height: 32px; border-radius: 50%;
    font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--neutral-700);
    transition: background 0.2s;
}
.modal-close:hover { background: var(--neutral-300); }
.modal-icon {
    width: 64px; height: 64px;
    background: linear-gradient(135deg, var(--forest-700), var(--forest-600));
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 28px; margin: 0 auto 16px;
    box-shadow: 0 4px 12px rgba(64,145,108,0.3);
}
.modal-title {
    font-family: 'Crimson Pro', serif;
    font-size: 22px; font-weight: 700;
    color: var(--forest-900);
    text-align: center; margin-bottom: 6px;
}
.modal-subtitle { color: var(--neutral-600); font-size: 14px; text-align: center; margin-bottom: 28px; }
.modal-step { display: none; }
.modal-step.active { display: block; animation: fadeInUp 0.3s ease; }

/* ==================== RESET PASSWORD PAGE ==================== */
.reset-page {
    display: none;
    max-width: 480px;
    margin: 60px auto;
    padding: 0 24px;
}
.reset-page.visible { display: block; }
.reset-card {
    background: white;
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
.reset-icon {
    width: 80px; height: 80px;
    background: linear-gradient(135deg, var(--forest-700), var(--forest-600));
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 36px; margin: 0 auto 20px;
    box-shadow: 0 4px 16px rgba(64,145,108,0.3);
}
.reset-title {
    font-family: 'Crimson Pro', serif;
    font-size: 28px; font-weight: 700;
    color: var(--forest-900); text-align: center; margin-bottom: 8px;
}
.reset-subtitle { color: var(--neutral-600); font-size: 15px; text-align: center; margin-bottom: 28px; }

/* Password strength */
.password-strength { margin-top: 8px; }
.strength-bar { height: 4px; border-radius: 4px; background: var(--neutral-200); margin-bottom: 4px; overflow: hidden; }
.strength-fill { height: 100%; width: 0; border-radius: 4px; transition: width 0.3s ease, background 0.3s ease; }
.strength-label { font-size: 12px; color: var(--neutral-600); }

/* Footer */
.portal-footer { max-width: 1200px; margin: 40px auto 20px; padding: 24px; text-align: center; color: var(--neutral-600); font-size: 13px; border-top: 1px solid var(--neutral-300); }
.footer-links { display: flex; justify-content: center; gap: 20px; margin-bottom: 12px; }
.footer-links a { color: var(--forest-700); text-decoration: none; }
.footer-links a:hover { color: var(--forest-800); text-decoration: underline; }

@media (max-width: 768px) {
    .header-main { flex-direction: column; gap: 16px; text-align: center; }
    .university-brand { flex-direction: column; }
    .portal-nav { flex-direction: column; }
    .nav-tab { border-bottom: 1px solid var(--neutral-200); border-left: 3px solid transparent; }
    .nav-tab.active { border-bottom-color: var(--neutral-200); border-left-color: var(--forest-700); }
    .portal-content { padding: 24px 20px; }
    .form-grid { grid-template-columns: 1fr; }
    .header-top-content { flex-direction: column; gap: 8px; text-align: center; }
    .modal { padding: 28px 24px; margin: 16px; }
}

/* ---- Show/hide password ---- */
.input-wrap { position: relative; display: flex; align-items: center; }
.input-wrap .form-control { padding-right: 44px; width: 100%; }
.toggle-pw {
    position: absolute; right: 12px;
    background: none; border: none; cursor: pointer; padding: 4px;
    color: var(--neutral-400); display: flex; align-items: center; justify-content: center;
    transition: color 0.2s; border-radius: 4px;
}
.toggle-pw:hover { color: var(--forest-700); }
.toggle-pw svg { width: 18px; height: 18px; display: block; }
</style>
</head>
<body>

<!-- ======================== FORGOT PASSWORD MODAL ======================== -->
<div class="modal-overlay" id="forgotModal" onclick="closeForgotModalOnOverlay(event)">
    <div class="modal">
        <button class="modal-close" onclick="closeForgotModal()" title="Close">‚úï</button>
        <div style="text-align:center;">
            <div class="modal-icon">üîë</div>
            <h2 class="modal-title">Forgot Password</h2>
            <p class="modal-subtitle" id="modalSubtitle">Enter your registered email address and we'll send you a link to reset your password.</p>
        </div>

        <!-- Step 1: Email input -->
        <div class="modal-step active" id="modalStep1">
            <div class="form-group" style="margin-bottom:20px;">
                <label class="form-label" for="forgot_email">
                    Email Address <span class="required-mark">*</span>
                </label>
                <input type="email" id="forgot_email" class="form-control" placeholder="your.email@example.com" autocomplete="email">
            </div>
            <button class="btn btn-primary btn-block" onclick="submitForgotPassword()" id="forgotBtn">
                Send Reset Link
            </button>
            <div id="forgotMsg" class="message-box" style="margin-top:16px;"></div>
        </div>

        <!-- Step 2: Success screen -->
        <div class="modal-step" id="modalStep2">
            <div style="text-align:center;padding:16px 0;">
                <div style="font-size:48px;margin-bottom:16px;">üì¨</div>
                <p style="color:var(--neutral-700);font-size:15px;line-height:1.7;margin-bottom:20px;">
                    We've sent a password reset link to <strong id="sentToEmail"></strong>.<br>
                    Check your inbox and follow the instructions.
                </p>
                <p style="color:var(--neutral-500);font-size:13px;margin-bottom:20px;">
                    Didn't receive it? Check your spam folder, or 
                    <button class="btn-link" onclick="resendReset()" style="font-size:13px;">resend the email</button>.
                </p>
                <button class="btn btn-primary btn-block" onclick="closeForgotModal()">Back to Login</button>
            </div>
        </div>
    </div>
</div>

<!-- ======================== HEADER ======================== -->
<header class="portal-header">
    <div class="header-top">
        <div class="header-top-content">
            <div class="header-links">
                <a href="#">University Website</a>
                <a href="#">Library</a>
                <a href="#">Support</a>
            </div>
            <div class="header-date" id="currentDate"></div>
        </div>
    </div>
    <div class="header-main">
        <div class="university-brand">
            <div class="university-seal">üéì</div>
            <div class="university-info">
                <h1>Student Information System</h1>
                <p>Academic Portal</p>
            </div>
        </div>
        <div class="header-actions">
            <a href="#" class="help-link">Need Help?</a>
        </div>
    </div>
</header>

<!-- ======================== MAIN ======================== -->
<main>

    <!-- ====== RESET PASSWORD PAGE ====== -->
    <div class="reset-page" id="resetPage">
        <div class="reset-card">
            <div style="text-align:center;">
                <div class="reset-icon">üîí</div>
                <h2 class="reset-title">Create New Password</h2>
                <p class="reset-subtitle">Enter your new password below. Make sure it's strong and memorable.</p>
            </div>
            <div id="resetFormArea">
                <div class="form-group" style="margin-bottom:20px;">
                    <label class="form-label" for="new_password">New Password <span class="required-mark">*</span></label>
                    <div class="input-wrap"><input type="password" id="new_password" class="form-control" placeholder="Minimum 8 characters" oninput="checkPasswordStrength()"><button type="button" class="toggle-pw" onclick="togglePw('new_password', this)" tabindex="-1"><svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><svg class="eye-hide" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg></button></div>
                    <div class="password-strength" id="strengthIndicator" style="display:none;"><div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div><div class="strength-label" id="strengthLabel"></div></div>
                </div>
                <div class="form-group" style="margin-bottom:24px;">
                    <label class="form-label" for="confirm_password">Confirm Password <span class="required-mark">*</span></label>
                    <div class="input-wrap"><input type="password" id="confirm_password" class="form-control" placeholder="Re-enter your new password" oninput="checkPasswordMatch()"><button type="button" class="toggle-pw" onclick="togglePw('confirm_password', this)" tabindex="-1"><svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><svg class="eye-hide" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg></button></div>
                    <div id="matchMsg" style="font-size:13px;margin-top:6px;"></div>
                </div>
                <button class="btn btn-primary btn-block" onclick="submitResetPassword()" id="resetBtn">Reset Password</button>
                <div id="resetMsg" class="message-box" style="margin-top:16px;"></div>
            </div>
            <div id="resetSuccess" style="display:none;text-align:center;padding:16px 0;">
                <div style="font-size:48px;margin-bottom:16px;">‚úÖ</div>
                <p style="color:var(--neutral-700);font-size:15px;line-height:1.7;margin-bottom:20px;">Your password has been reset successfully!</p>
                <a href="/" class="btn btn-primary btn-block">Go to Login</a>
            </div>
            <div id="invalidToken" style="display:none;text-align:center;padding:16px 0;">
                <div style="font-size:48px;margin-bottom:16px;">‚õî</div>
                <p style="font-weight:600;color:var(--forest-900);margin-bottom:8px;">Link Expired or Invalid</p>
                <p style="color:var(--neutral-600);font-size:14px;margin-bottom:20px;">This password reset link is no longer valid. Links expire after 1 hour.</p>
                <button class="btn btn-primary btn-block" onclick="openForgotModal()">Request a New Link</button>
            </div>
        </div>
    </div>

    <!-- ====== NORMAL PORTAL ====== -->
    <div class="main-container" id="portalContainer">
        <div class="breadcrumb"><a href="#">Home</a> / Student Portal</div>

        <nav class="portal-nav">
            <button class="nav-tab active" onclick="switchTab('login')">Student Login</button>
            <button class="nav-tab" onclick="switchTab('register')">New Student Registration</button>
        </nav>

        <div class="portal-content">

            <!-- LOGIN SECTION -->
            <section id="loginSection" class="content-section active">
                <div class="login-container">
                    <div class="alert-box">
                        <div class="alert-icon">‚ÑπÔ∏è</div>
                        <div class="alert-content">
                            <div class="alert-title">Welcome to the Student Portal</div>
                            <div class="alert-text">Please enter your credentials to access your account. If you're a new student, please use the registration tab.</div>
                        </div>
                    </div>
                    <div class="login-card">
                        <div class="login-header">
                            <div class="login-icon">üë§</div>
                            <h2 class="login-title">Student Login</h2>
                            <p class="login-subtitle">Access your academic records and information</p>
                        </div>
                        <form onsubmit="return false;">
                            <div class="form-group">
                                <label class="form-label" for="login_id">Student ID Number <span class="required-mark">*</span></label>
                                <input type="text" id="login_id" class="form-control" placeholder="Enter your student ID (e.g., 2024-00001)" autocomplete="username">
                            </div>
                            <div class="form-group" style="margin-bottom:4px;">
                                <label class="form-label" for="login_password">Password <span class="required-mark">*</span></label>
                                <div class="input-wrap"><input type="password" id="login_password" class="form-control" placeholder="Enter your password" autocomplete="current-password"><button type="button" class="toggle-pw" onclick="togglePw('login_password', this)" tabindex="-1"><svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><svg class="eye-hide" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg></button></div>
                            </div>
                            <div class="forgot-password-row">
                                <button class="btn-link" type="button" onclick="openForgotModal()">Forgot Password?</button>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block" onclick="login()">Sign In</button>
                            <div id="loginMsg" class="message-box"></div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- REGISTRATION SECTION -->
            <section id="registerSection" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">New Student Registration</h2>
                    <p class="section-description">Please complete all required fields to submit your application.</p>
                </div>
                <div class="alert-box">
                    <div class="alert-icon">üìã</div>
                    <div class="alert-content">
                        <div class="alert-title">Application Guidelines</div>
                        <div class="alert-text">All fields marked with <span class="required-mark">*</span> are required. Please ensure all information is accurate before submission.</div>
                    </div>
                </div>
                <div class="progress-indicator" id="progressIndicator" style="display: none;">
                    <div class="progress-label">
                        <span>Application Progress</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                </div>

                <form onsubmit="return false;">
                    <!-- Personal Info -->
                    <div class="form-card">
                        <div class="form-card-header">
                            <div class="form-card-icon">üë§</div>
                            <h3 class="form-card-title">Personal Information</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="student_id">Student ID Number <span class="required-mark">*</span></label>
                                <input type="text" id="student_id" class="form-control" placeholder="e.g., 2024-00001" oninput="updateProgress()">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="password">Password <span class="required-mark">*</span></label>
                                <div class="input-wrap"><input type="password" id="password" class="form-control" placeholder="Create a secure password" oninput="updateProgress()"><button type="button" class="toggle-pw" onclick="togglePw('password', this)" tabindex="-1"><svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><svg class="eye-hide" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg></button></div>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="first_name">First Name <span class="required-mark">*</span></label>
                                <input type="text" id="first_name" class="form-control" placeholder="First name" oninput="updateProgress()">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="middle_name">Middle Name</label>
                                <input type="text" id="middle_name" class="form-control" placeholder="Middle name (optional)">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="last_name">Last Name <span class="required-mark">*</span></label>
                                <input type="text" id="last_name" class="form-control" placeholder="Last name" oninput="updateProgress()">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="age">Age <span class="required-mark">*</span></label>
                                <input type="number" id="age" class="form-control" placeholder="Age" min="15" max="100" oninput="updateProgress()">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="contact_number">Contact Number <span class="required-mark">*</span></label>
                                <input type="tel" id="contact_number" class="form-control" placeholder="09XX XXX XXXX" oninput="updateProgress()">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="email">Email Address <span class="required-mark">*</span></label>
                                <input type="email" id="email" class="form-control" placeholder="student@email.com" oninput="updateProgress()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="address">Complete Address <span class="required-mark">*</span></label>
                            <textarea id="address" class="form-control" placeholder="House/Unit No., Street, Barangay, City/Municipality, Province" oninput="updateProgress()"></textarea>
                        </div>
                    </div>

                    <!-- Father -->
                    <div class="form-card">
                        <div class="form-card-header">
                            <div class="form-card-icon">üë®</div>
                            <h3 class="form-card-title">Father's Information</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">First Name</label><input type="text" id="father_first_name" class="form-control" placeholder="First name"></div>
                            <div class="form-group"><label class="form-label">Middle Name</label><input type="text" id="father_middle_name" class="form-control" placeholder="Middle name"></div>
                            <div class="form-group"><label class="form-label">Last Name</label><input type="text" id="father_last_name" class="form-control" placeholder="Last name"></div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Occupation</label><input type="text" id="father_occupation" class="form-control" placeholder="Occupation"></div>
                            <div class="form-group"><label class="form-label">Contact Number</label><input type="tel" id="father_contact_number" class="form-control" placeholder="Contact number"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Address</label><textarea id="father_address" class="form-control" placeholder="Complete address"></textarea></div>
                    </div>

                    <!-- Mother -->
                    <div class="form-card">
                        <div class="form-card-header">
                            <div class="form-card-icon">üë©</div>
                            <h3 class="form-card-title">Mother's Information</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">First Name</label><input type="text" id="mother_first_name" class="form-control" placeholder="First name"></div>
                            <div class="form-group"><label class="form-label">Middle Name</label><input type="text" id="mother_middle_name" class="form-control" placeholder="Middle name"></div>
                            <div class="form-group"><label class="form-label">Last Name</label><input type="text" id="mother_last_name" class="form-control" placeholder="Last name"></div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Occupation</label><input type="text" id="mother_occupation" class="form-control" placeholder="Occupation"></div>
                            <div class="form-group"><label class="form-label">Contact Number</label><input type="tel" id="mother_contact_number" class="form-control" placeholder="Contact number"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Address</label><textarea id="mother_address" class="form-control" placeholder="Complete address"></textarea></div>
                    </div>

                    <!-- Academic Info -->
                    <div class="form-card">
                        <div class="form-card-header">
                            <div class="form-card-icon">üéì</div>
                            <h3 class="form-card-title">Academic Information</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="last_school_attended">Last School Attended <span class="required-mark">*</span></label>
                                <input type="text" id="last_school_attended" class="form-control" placeholder="Name of previous school" oninput="updateProgress()">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="last_school_year">School Year <span class="required-mark">*</span></label>
                                <input type="text" id="last_school_year" class="form-control" placeholder="e.g., 2022-2023" oninput="updateProgress()">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="course">Course/Program <span class="required-mark">*</span></label>
                                <select id="course" class="form-control" onchange="updateProgress()">
                                    <option value="">Select a course</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="year_level">Year Level <span class="required-mark">*</span></label>
                                <select id="year_level" class="form-control" onchange="updateProgress()">
                                    <option value="">Select year level</option>
                                    <option value="1">First Year</option>
                                    <option value="2">Second Year</option>
                                    <option value="3">Third Year</option>
                                    <option value="4">Fourth Year</option>
                                </select>
                            </div>
                        </div>

                        <!-- ‚úÖ SEMESTER MOVED BEFORE SUBJECTS -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label" for="semester">
                                Semester <span class="required-mark">*</span>
                            </label>
                            <select id="semester" class="form-control" onchange="updateProgress()">
                                <option value="">Select semester</option>
                                <option value="1st">1st Semester</option>
                                <option value="2nd">2nd Semester</option>
                                <option value="summer">Summer</option>
                            </select>
                            <div class="form-hint">üìÖ Subjects below will update based on your selected semester.</div>
                        </div>

                        <!-- SUBJECTS ‚Äî loads after course + year + semester are all chosen -->
                        <div class="form-group">
                            <label class="form-label" for="subjects">
                                Select Subjects <span class="required-mark">*</span>
                            </label>

                            <!-- Prompt shown before selections are made -->
                            <div id="subjectsPrompt" class="subjects-prompt">
                                <div class="prompt-icon">üìö</div>
                                <div>Please select your <strong>Course</strong>, <strong>Year Level</strong>, and <strong>Semester</strong> first to load available subjects.</div>
                            </div>

                            <!-- The actual multi-select (hidden until ready) -->
                            <select id="subjects" class="form-control" multiple onchange="updateSelectedSubjects()" style="display:none;"></select>

                            <div class="form-hint">üí° Click to select/deselect. You can choose multiple subjects.</div>
                            <div id="selectedSubjectsDisplay" class="selected-subjects">
                                <div class="selected-subjects-title">Selected Subjects (<span id="selectedCount">0</span>):</div>
                                <div class="selected-subjects-list" id="selectedSubjectsList"></div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" onclick="register()">
                        Submit Application
                    </button>
                    <div id="registerMsg" class="message-box"></div>
                </form>
            </section>

        </div>
    </div>

</main>

<footer class="portal-footer">
    <div class="footer-links">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
        <a href="#">Contact Support</a>
        <a href="#">Help Center</a>
    </div>
    <p>&copy; 2024 University Student Information System. All rights reserved.</p>
</footer>

<script>
const API = "";

// ======================== DATE ========================
function displayDate() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', options);
}

// ======================== TABS ========================
function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    if (tab === 'login') {
        document.querySelectorAll('.nav-tab')[0].classList.add('active');
        document.getElementById('loginSection').classList.add('active');
    } else {
        document.querySelectorAll('.nav-tab')[1].classList.add('active');
        document.getElementById('registerSection').classList.add('active');
    }
}

// ======================== PAGE INIT ========================
function initPage() {
    displayDate();
    loadCourses();

    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    if (token) {
        document.getElementById('portalContainer').style.display = 'none';
        document.getElementById('resetPage').classList.add('visible');
        verifyToken(token);
    }
}

// ======================== FORGOT PASSWORD MODAL ========================
function openForgotModal() {
    document.getElementById('forgotModal').classList.add('open');
    document.getElementById('forgotMsg').className = 'message-box';
    document.getElementById('forgot_email').value = '';
    showModalStep(1);
    setTimeout(() => document.getElementById('forgot_email').focus(), 300);
}
function closeForgotModal() {
    document.getElementById('forgotModal').classList.remove('open');
    setTimeout(() => showModalStep(1), 300);
}
function closeForgotModalOnOverlay(e) {
    if (e.target === document.getElementById('forgotModal')) closeForgotModal();
}
function showModalStep(step) {
    document.querySelectorAll('.modal-step').forEach(s => s.classList.remove('active'));
    document.getElementById('modalStep' + step).classList.add('active');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeForgotModal(); });

async function submitForgotPassword() {
    const btn = document.getElementById('forgotBtn');
    const msgEl = document.getElementById('forgotMsg');
    const email = document.getElementById('forgot_email').value.trim();
    msgEl.className = 'message-box';
    msgEl.innerHTML = '';
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        msgEl.className = 'message-box error';
        msgEl.innerHTML = '‚ö†Ô∏è Please enter a valid email address.';
        return;
    }
    const original = btn.innerHTML;
    btn.innerHTML = '<span class="spinner"></span> Sending...';
    btn.disabled = true;
    try {
        const res = await fetch(API + '/forgot-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
        const data = await res.json();
        if (res.ok) {
            document.getElementById('sentToEmail').textContent = email;
            document.getElementById('modalSubtitle').textContent = 'Reset email sent!';
            showModalStep(2);
        } else {
            msgEl.className = 'message-box error';
            msgEl.innerHTML = '‚úó ' + (data.error || 'Something went wrong.');
        }
    } catch (err) {
        msgEl.className = 'message-box error';
        msgEl.innerHTML = '‚ö†Ô∏è Unable to connect.';
    } finally {
        btn.innerHTML = original;
        btn.disabled = false;
    }
}
function resendReset() { showModalStep(1); }
document.addEventListener('DOMContentLoaded', () => {
    const emailInput = document.getElementById('forgot_email');
    if (emailInput) emailInput.addEventListener('keypress', e => { if (e.key === 'Enter') submitForgotPassword(); });
});

// ======================== RESET PASSWORD ========================
async function verifyToken(token) {
    try {
        const res = await fetch(API + '/verify-reset-token?token=' + encodeURIComponent(token));
        const data = await res.json();
        if (!data.valid) {
            document.getElementById('resetFormArea').style.display = 'none';
            document.getElementById('invalidToken').style.display = 'block';
        }
    } catch (err) {}
}
function checkPasswordStrength() {
    const pw = document.getElementById('new_password').value;
    const indicator = document.getElementById('strengthIndicator');
    const fill = document.getElementById('strengthFill');
    const label = document.getElementById('strengthLabel');
    if (pw.length === 0) { indicator.style.display = 'none'; return; }
    indicator.style.display = 'block';
    let score = 0;
    if (pw.length >= 8) score++;
    if (pw.length >= 12) score++;
    if (/[A-Z]/.test(pw)) score++;
    if (/[0-9]/.test(pw)) score++;
    if (/[^A-Za-z0-9]/.test(pw)) score++;
    const configs = [
        { width: '20%', color: '#ef4444', text: 'Very Weak' },
        { width: '40%', color: '#f97316', text: 'Weak' },
        { width: '60%', color: '#eab308', text: 'Fair' },
        { width: '80%', color: '#22c55e', text: 'Strong' },
        { width: '100%', color: '#16a34a', text: 'Very Strong' },
    ];
    const cfg = configs[Math.min(score - 1, 4)] || configs[0];
    fill.style.width = cfg.width;
    fill.style.background = cfg.color;
    label.textContent = cfg.text;
    label.style.color = cfg.color;
}
function checkPasswordMatch() {
    const pw = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;
    const msg = document.getElementById('matchMsg');
    if (confirm.length === 0) { msg.innerHTML = ''; return; }
    msg.innerHTML = pw === confirm
        ? '<span style="color:#16a34a;">‚úì Passwords match</span>'
        : '<span style="color:#dc2626;">‚úó Passwords do not match</span>';
}
async function submitResetPassword() {
    const btn = document.getElementById('resetBtn');
    const msgEl = document.getElementById('resetMsg');
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    msgEl.className = 'message-box';
    msgEl.innerHTML = '';
    if (!newPassword || newPassword.length < 8) { msgEl.className = 'message-box error'; msgEl.innerHTML = '‚ö†Ô∏è Password must be at least 8 characters.'; return; }
    if (newPassword !== confirmPassword) { msgEl.className = 'message-box error'; msgEl.innerHTML = '‚ö†Ô∏è Passwords do not match.'; return; }
    const original = btn.innerHTML;
    btn.innerHTML = '<span class="spinner"></span> Resetting...';
    btn.disabled = true;
    try {
        const res = await fetch(API + '/reset-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, new_password: newPassword }) });
        const data = await res.json();
        if (res.ok) {
            document.getElementById('resetFormArea').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'block';
        } else {
            msgEl.className = 'message-box error';
            msgEl.innerHTML = '‚úó ' + (data.error || 'Reset failed. The link may have expired.');
        }
    } catch (err) {
        msgEl.className = 'message-box error';
        msgEl.innerHTML = '‚ö†Ô∏è Unable to connect. Please try again.';
    } finally {
        btn.innerHTML = original;
        btn.disabled = false;
    }
}

// ======================== LOGIN ========================
async function login() {
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    const msgEl = document.getElementById('loginMsg');
    msgEl.className = 'message-box';
    msgEl.innerHTML = '';
    const loginId = document.getElementById('login_id').value;
    const password = document.getElementById('login_password').value;
    if (!loginId || !password) { msgEl.className = 'message-box error'; msgEl.innerHTML = '‚ö†Ô∏è Please enter both student ID and password.'; return; }
    btn.innerHTML = '<span class="spinner"></span> Authenticating...';
    btn.disabled = true;
    try {
        const res = await fetch(API + '/login', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login_id: loginId, password }) });
        const data = await res.json();
        if (res.ok) {
            localStorage.setItem('jwt', data.token);
            if (data.role === 'student' && data.student_id) localStorage.setItem('student_id', data.student_id);
            msgEl.className = 'message-box success';
            msgEl.innerHTML = '‚úì Login successful. Redirecting...';
            setTimeout(() => { window.location.href = data.redirect; }, 1200);
        } else {
            msgEl.className = 'message-box error';
            msgEl.innerHTML = '‚úó ' + (data.error || 'Invalid credentials.');
        }
    } catch (err) {
        msgEl.className = 'message-box error';
        msgEl.innerHTML = '‚ö†Ô∏è Unable to connect to the server.';
    } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }
}
document.getElementById('login_password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });

// ======================== REGISTER ========================
let subjectsData = [];

function updateSelectedSubjects() {
    const sel = document.getElementById('subjects');
    const selected = Array.from(sel.selectedOptions);
    const display = document.getElementById('selectedSubjectsDisplay');
    const list = document.getElementById('selectedSubjectsList');
    const count = document.getElementById('selectedCount');
    if (selected.length > 0) {
        display.classList.add('show');
        count.textContent = selected.length;
        list.innerHTML = '';
        selected.forEach(opt => {
            const tag = document.createElement('span');
            tag.className = 'subject-tag';
            tag.innerHTML = `${opt.textContent}<span class="subject-tag-remove" onclick="removeSubject('${opt.value}')">‚úï</span>`;
            list.appendChild(tag);
        });
    } else {
        display.classList.remove('show');
    }
    updateProgress();
}

function removeSubject(id) {
    const opt = Array.from(document.getElementById('subjects').options).find(o => o.value === id);
    if (opt) { opt.selected = false; updateSelectedSubjects(); }
}

function updateProgress() {
    const fields = ['student_id','password','first_name','last_name','age','contact_number','email','address','last_school_attended','last_school_year','course','year_level','semester'];
    let filled = fields.filter(f => { const el = document.getElementById(f); return el && el.value.trim(); }).length;
    if (Array.from(document.getElementById('subjects').selectedOptions).length > 0) filled++;
    const total = fields.length + 1;
    const pct = Math.round((filled / total) * 100);
    const indicator = document.getElementById('progressIndicator');
    if (filled > 0) {
        indicator.style.display = 'block';
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressPercent').textContent = pct + '%';
    }
}

async function loadCourses() {
    try {
        const res = await fetch(API + '/public/courses');
        const courses = await res.json();
        const sel = document.getElementById('course');
        sel.innerHTML = "<option value=''>Select a course</option>";
        courses.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.course_name;
            sel.appendChild(opt);
        });
    } catch (err) { console.error('Error loading courses:', err); }
}

// ‚úÖ FIXED: Now reads course, year_level, AND semester ‚Äî all three must be selected
async function loadSubjects() {
    const course = document.getElementById('course').value;
    const yearLevel = document.getElementById('year_level').value;
    const semester = document.getElementById('semester').value;

    const prompt = document.getElementById('subjectsPrompt');
    const sel = document.getElementById('subjects');

    // If not all three are chosen, show the prompt and hide the select
    if (!course || !yearLevel || !semester) {
        prompt.style.display = 'block';
        sel.style.display = 'none';
        sel.innerHTML = '';
        document.getElementById('selectedSubjectsDisplay').classList.remove('show');
        return;
    }

    // Show loading state
    prompt.style.display = 'block';
    prompt.innerHTML = '<div class="subjects-loading">‚è≥ Loading subjects...</div>';
    sel.style.display = 'none';

    try {
        // ‚úÖ Pass semester to the API
        const res = await fetch(`${API}/public/subjects?course_id=${course}&year_level=${yearLevel}&semester=${encodeURIComponent(semester)}`);
        const contentType = res.headers.get('content-type') || '';
        if (!res.ok || !contentType.includes('application/json')) throw new Error(`Server returned ${res.status}`);

        const subjects = await res.json();
        subjectsData = subjects;

        prompt.style.display = 'none';
        sel.style.display = 'block';
        sel.innerHTML = '';

        if (subjects.length === 0) {
            // Show friendly message inside the prompt if no subjects found
            prompt.style.display = 'block';
            prompt.innerHTML = `<div class="prompt-icon">üòï</div><div>No subjects found for <strong>${semester} Semester</strong> of your selected course and year level.</div>`;
            sel.style.display = 'none';
        } else {
            subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.code ? s.code + ' ‚Äî ' : ''}${s.subject_name || s.name || ''}`;
                sel.appendChild(opt);
            });
        }
        // Reset selected display
        document.getElementById('selectedSubjectsDisplay').classList.remove('show');
        updateProgress();
    } catch (err) {
        prompt.style.display = 'block';
        prompt.innerHTML = '<div class="prompt-icon">‚ö†Ô∏è</div><div>Error loading subjects. Please try again.</div>';
        sel.style.display = 'none';
        console.error(err);
    }
}

// ‚úÖ All three dropdowns now trigger loadSubjects
document.getElementById('course').addEventListener('change', loadSubjects);
document.getElementById('year_level').addEventListener('change', loadSubjects);
document.getElementById('semester').addEventListener('change', loadSubjects); // ‚úÖ NEW

async function register() {
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    const msgEl = document.getElementById('registerMsg');
    msgEl.className = 'message-box';
    msgEl.innerHTML = '';

    const fields = {
        student_id: document.getElementById('student_id').value,
        password: document.getElementById('password').value,
        first_name: document.getElementById('first_name').value,
        middle_name: document.getElementById('middle_name').value,
        last_name: document.getElementById('last_name').value,
        age: document.getElementById('age').value,
        contact_number: document.getElementById('contact_number').value,
        email: document.getElementById('email').value,
        address: document.getElementById('address').value,
        last_school_attended: document.getElementById('last_school_attended').value,
        last_school_year: document.getElementById('last_school_year').value,
        course: document.getElementById('course').value,
        year_level: document.getElementById('year_level').value,
        semester: document.getElementById('semester').value
    };

    if (!fields.student_id || !fields.password || !fields.first_name || !fields.last_name ||
        !fields.age || !fields.contact_number || !fields.email || !fields.address ||
        !fields.last_school_attended || !fields.last_school_year || !fields.course ||
        !fields.year_level || !fields.semester) {
        msgEl.className = 'message-box error';
        msgEl.innerHTML = '‚ö†Ô∏è Please complete all required fields marked with *.';
        msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }

    const selectedSubjects = Array.from(document.getElementById('subjects').selectedOptions).map(o => o.value);
    if (selectedSubjects.length === 0) {
        msgEl.className = 'message-box error';
        msgEl.innerHTML = '‚ö†Ô∏è Please select at least one subject.';
        msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }

    const payload = {
        ...fields,
        age: parseInt(fields.age) || 18,
        father_first_name: document.getElementById('father_first_name').value,
        father_middle_name: document.getElementById('father_middle_name').value,
        father_last_name: document.getElementById('father_last_name').value,
        father_occupation: document.getElementById('father_occupation').value,
        father_contact_number: document.getElementById('father_contact_number').value,
        father_address: document.getElementById('father_address').value,
        mother_first_name: document.getElementById('mother_first_name').value,
        mother_middle_name: document.getElementById('mother_middle_name').value,
        mother_last_name: document.getElementById('mother_last_name').value,
        mother_occupation: document.getElementById('mother_occupation').value,
        mother_contact_number: document.getElementById('mother_contact_number').value,
        mother_address: document.getElementById('mother_address').value,
        subjects: selectedSubjects
    };

    btn.innerHTML = '<span class="spinner"></span> Submitting Application...';
    btn.disabled = true;

    try {
        const res = await fetch(API + '/register-student', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (res.ok) {
            msgEl.className = 'message-box success';
            msgEl.innerHTML = '‚úì Application submitted successfully! Your registration is now pending review.';
            msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                document.querySelectorAll('.form-control').forEach(el => el.value = '');
                document.getElementById('progressIndicator').style.display = 'none';
                document.getElementById('selectedSubjectsDisplay').classList.remove('show');
                document.getElementById('subjects').style.display = 'none';
                document.getElementById('subjectsPrompt').style.display = 'block';
                document.getElementById('subjectsPrompt').innerHTML = `<div class="prompt-icon">üìö</div><div>Please select your <strong>Course</strong>, <strong>Year Level</strong>, and <strong>Semester</strong> first to load available subjects.</div>`;
            }, 3000);
        } else {
            msgEl.className = 'message-box error';
            msgEl.innerHTML = '‚úó ' + (data.error || 'Registration failed. Please try again.');
            msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } catch (err) {
        msgEl.className = 'message-box error';
        msgEl.innerHTML = '‚ö†Ô∏è Unable to submit application. Please check your connection.';
        msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }
}

function togglePw(id, btn) {
    const el = document.getElementById(id);
    const show = el.type === 'password';
    el.type = show ? 'text' : 'password';
    btn.querySelector('.eye-show').style.display = show ? 'none' : '';
    btn.querySelector('.eye-hide').style.display = show ? '' : 'none';
    btn.style.color = show ? 'var(--forest-700)' : '';
}

initPage();
</script>
</body>
</html>