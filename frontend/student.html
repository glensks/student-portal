<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Portal - The University of Manila</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body { 
      display: flex;
      flex-direction: column;
      min-height: 100vh; 
      background: #f5f5f5;
      font-family: 'Source Sans Pro', sans-serif;
      color: #333;
      font-size: 13px;
    }

    /* University Header */
    .university-header {
      background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
      color: white;
      padding: 12px 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .university-branding {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .university-logo {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: #165a28;
      border: 3px solid #d4af37;
    }

    .university-name {
      display: flex;
      flex-direction: column;
    }

    .university-title {
      font-family: 'Crimson Text', serif;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .university-subtitle {
      font-size: 9px;
      opacity: 0.9;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    

    .header-user-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .header-user-id {
      font-size: 9px;
      opacity: 0.8;
    }

   .notification-container {
  position: relative;
  display: inline-block;
}

.notification-bell {
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notification-bell:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}

.notification-bell:active {
  transform: scale(0.95);
}

.notification-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  background: #dc3545;
  color: white;
  border-radius: 10px;
  padding: 2px 6px;
  font-size: 10px;
  font-weight: 700;
  border: 2px solid #165a28;
  min-width: 20px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.notification-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 50px;
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  width: 380px;
  max-height: 500px;
  overflow: hidden;
  z-index: 1000;
}

.notification-dropdown.show {
  display: flex;
  flex-direction: column;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.notification-header {
  padding: 16px 20px;
  border-bottom: 1px solid #e0e0e0;
  font-weight: 700;
  background: #f8f9fa;
  border-radius: 12px 12px 0 0;
  font-size: 14px;
  color: #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-header::before {
  content: 'üì¨';
  margin-right: 8px;
  font-size: 18px;
}

/* Scrollable notification list */
.notification-dropdown > #notificationList {
  overflow-y: auto;
  max-height: 440px;
  scroll-behavior: smooth;
}

/* Custom scrollbar for notifications */
.notification-dropdown > #notificationList::-webkit-scrollbar {
  width: 6px;
}

.notification-dropdown > #notificationList::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.notification-dropdown > #notificationList::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 3px;
}

.notification-dropdown > #notificationList::-webkit-scrollbar-thumb:hover {
  background: #555;
}

.notification-item {
  padding: 16px 20px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: all 0.2s ease;
  background: white;
}

.notification-item:hover {
  background: #f8f9fa;
}

.notification-item:last-child {
  border-bottom: none;
}

.notification-item.unread {
  background: #e8f5e9;
  border-left: 4px solid #165a28;
}

.notification-item.unread:hover {
  background: #d4edda;
}

.notification-title {
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
  font-size: 13px;
  line-height: 1.4;
}

.notification-message {
  font-size: 12px;
  color: #666;
  line-height: 1.5;
  margin-bottom: 8px;
}

.notification-time {
  font-size: 11px;
  color: #999;
  display: flex;
  align-items: center;
  gap: 4px;
}

.notification-empty {
  padding: 60px 20px;
  text-align: center;
  color: #999;
}

/* Notification icon animations */
@keyframes bellRing {
  0%, 100% { transform: rotate(0deg); }
  10%, 30% { transform: rotate(-10deg); }
  20%, 40% { transform: rotate(10deg); }
}

.notification-bell.has-notifications {
  animation: bellRing 2s ease-in-out infinite;
}

/* Mark all as read button (optional) */
.notification-actions {
  padding: 12px 20px;
  border-top: 1px solid #e0e0e0;
  background: #fafafa;
  border-radius: 0 0 12px 12px;
  text-align: center;
}

.notification-mark-read-btn {
  background: none;
  border: none;
  color: #165a28;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.notification-mark-read-btn:hover {
  background: #e8f5e9;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .notification-dropdown {
    width: 320px;
    right: -10px;
  }
  
  .notification-item {
    padding: 14px 16px;
  }
  
  .notification-header {
    padding: 14px 16px;
  }
}

    /* Main Container */
    .main-container {
      display: flex;
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    /* Sidebar Styling */
    .sidebar {
      width: 220px;
      background: white;
      border-right: 1px solid #e0e0e0;
      padding: 15px 0;
      overflow-y: auto;
      position: sticky;
      top: 70px;
      height: calc(100vh - 70px);
      align-self: flex-start;
    }

    .profile-section {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 8px;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .profile-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border: 2px solid #d4af37;
      flex-shrink: 0;
    }

    .profile-info {
      flex: 1;
      min-width: 0;
    }

    .profile-name {
      font-size: 12px;
      font-weight: 700;
      color: #165a28;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-id {
      font-size: 9px;
      color: #666;
      margin-bottom: 1px;
    }

    .profile-status {
      font-size: 9px;
      color: #666;
    }

    .nav-section {
      padding: 8px 0;
    }

    .nav-section-title {
      padding: 6px 15px;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: #999;
      margin-top: 4px;
    }

    .sidebar a {
      color: #333;
      text-decoration: none;
      padding: 10px 15px;
      margin: 2px 8px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-size: 12px;
      font-weight: 400;
    }

    .sidebar a .icon {
      font-size: 14px;
      width: 18px;
      text-align: center;
    }

    .sidebar a.active {
      background: #165a28;
      color: white;
      font-weight: 600;
    }

    .sidebar a:hover:not(.active) {
      background: #f0f0f0;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Page Header */
    .page-header {
      background: white;
      border-bottom: 1px solid #e0e0e0;
      padding: 15px 25px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .page-header h1 {
      font-family: 'Crimson Text', serif;
      font-size: 24px;
      font-weight: 700;
      color: #165a28;
      margin-bottom: 4px;
    }

    .breadcrumb {
      font-size: 11px;
      color: #666;
    }

    .breadcrumb a {
      color: #165a28;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    /* Content Area */
    .content-wrapper {
      flex: 1;
      padding: 20px 25px;
      overflow-y: auto;
      background: #f5f5f5;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #165a28;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .stat-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 9px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #165a28;
      font-family: 'Crimson Text', serif;
    }

    /* Announcements Section */
    .announcements-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 15px;
    }
    
    .announcement-modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  animation: fadeIn 0.3s ease;
}

.announcement-modal-content {
  background-color: white;
  margin: 5% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 700px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease;
}

.announcement-modal-header {
  padding: 20px 25px;
  background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
  color: white;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: start;
}

.announcement-modal-header.registrar {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.announcement-modal-header.records {
  background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
}

.announcement-modal-title {
  font-family: 'Crimson Text', serif;
  font-size: 22px;
  margin: 0;
  flex: 1;
  padding-right: 15px;
}

.announcement-modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 32px;
  cursor: pointer;
  line-height: 1;
  transition: all 0.3s ease;
  padding: 0;
  width: 40px;
  height: 40px;
}

.announcement-modal-close:hover {
  color: #d4af37;
  transform: rotate(90deg);
}

.announcement-modal-body {
  padding: 25px;
}

.announcement-modal-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 20px;
  font-size: 13px;
}

.announcement-modal-meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.announcement-modal-content-text {
  font-size: 15px;
  line-height: 1.8;
  color: #333;
  margin-bottom: 20px;
}

.announcement-modal-image {
  width: 100%;
  border-radius: 8px;
  margin-top: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #165a28;
    }

    .section-header h2 {
      font-family: 'Crimson Text', serif;
      font-size: 20px;
      font-weight: 700;
      color: #165a28;
    }

    /* Announcement Filter Dropdown */
/* Announcement Filter Dropdown */
.filter-dropdown-container {
  position: relative;
  display: inline-block;
}

.filter-dropdown-btn {
  color: #333;
  background: white;
  text-decoration: none;
  font-size: 13px;
  font-weight: 600;
  padding: 8px 16px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  transition: all 0.3s ease;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.filter-dropdown-btn:hover {
  border-color: #165a28;
  background: #f8f9fa;
}

.filter-dropdown-menu {
  display: none;
  position: absolute;
  right: 0;   /* ‚Üê changed from left:0 to right:0 */
  top: 100%;
  margin-top: 5px;
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  min-width: 200px;
  z-index: 1000;
  overflow: hidden;
}

.filter-dropdown-menu.show {
  display: block;
  animation: slideDown 0.2s ease;
}

.filter-dropdown-item {
  padding: 12px 16px;
  font-size: 13px;
  color: #333;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #f0f0f0;
}

.filter-dropdown-item:last-child {
  border-bottom: none;
}

.filter-dropdown-item:hover {
  background: #f8f9fa;
  color: #165a28;
}

.filter-dropdown-item.active {
  background: #e8f5e9;
  color: #165a28;
  font-weight: 600;
}

@media (max-width: 768px) {
  .filter-dropdown-menu {
    left: 0;
    right: auto;
  }
}

    .view-all-btn {
      color: #165a28;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 12px;
      border: 1px solid #165a28;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .view-all-btn:hover {
      background: #165a28;
      color: white;
    }

    .announcement-card {
      padding: 12px;
      border-left: 4px solid #165a28;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .announcement-card:hover {
      background: #e8f5e9;
      transform: translateX(3px);
    }

    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 6px;
    }

    .announcement-title {
      font-size: 13px;
      font-weight: 700;
      color: #165a28;
      margin-bottom: 3px;
    }

    .announcement-meta {
      font-size: 9px;
      color: #666;
      display: flex;
      gap: 12px;
      margin-bottom: 6px;
    }

    .announcement-body {
      font-size: 11px;
      color: #555;
      line-height: 1.5;
    }

    .priority-badge {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .priority-high {
      background: #ffebee;
      color: #c62828;
    }

    .priority-medium {
      background: #fff3e0;
      color: #e65100;
    }

    .priority-normal {
      background: #e3f2fd;
      color: #1565c0;
    }

    /* University Footer */
    .university-footer {
      background: #2c2c2c;
      color: #ccc;
      padding: 25px 25px 15px;
      margin-top: auto;
    }

    .footer-content {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 30px;
      margin-bottom: 15px;
    }

    .footer-section h3 {
      color: #d4af37;
      font-family: 'Crimson Text', serif;
      font-size: 16px;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .footer-section p {
      font-size: 11px;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .footer-section ul {
      list-style: none;
    }

    .footer-section ul li {
      margin-bottom: 6px;
      font-size: 11px;
    }

    .footer-section ul li a {
      color: #ccc;
      text-decoration: none;
      transition: color 0.3s;
    }

    .footer-section ul li a:hover {
      color: #d4af37;
    }

    .footer-bottom {
      max-width: 1400px;
      margin: 0 auto;
      padding-top: 15px;
      border-top: 1px solid #444;
      text-align: center;
      font-size: 10px;
      color: #999;
    }

    /* Payment Card */
    .payment-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 15px;
      border: 1px solid #e0e0e0;
    }

    .payment-card h2 {
      font-family: 'Crimson Text', serif;
      color: #165a28;
      font-size: 16px;
      margin-bottom: 12px;
      padding-bottom: 10px;
    }
    .status {
      font-weight: 700;
      padding: 6px 14px;
      border-radius: 20px;
      color: white;
      display: inline-block;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .paid { background: #28a745; }
    .partial { background: #ffc107; color: #333; }
    .unpaid { background: #dc3545; }
    .pending { background: #17a2b8; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }

    table th, table td {
      border: 1px solid #e0e0e0;
      padding: 12px;
      text-align: left;
    }

    table th {
      background: #165a28;
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    table tr:hover {
      background: #f8f9fa;
    }

    /* Enhanced Billing Styles */
    .billing-header-card {
      background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
      color: white;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(22,90,40,0.3);
    }

    .billing-header-card h2 {
      font-family: 'Crimson Text', serif;
      font-size: 24px;
      margin-bottom: 8px;
      color: white;
    }

    .billing-semester-info {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .billing-info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .billing-info-label {
      font-size: 10px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .billing-info-value {
      font-size: 15px;
      font-weight: 700;
      color: #d4af37;
    }

    .billing-content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin-bottom: 25px;
    }

    .billing-main-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .billing-sidebar-card {
      background: white;
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .billing-section-title {
      font-family: 'Crimson Text', serif;
      font-size: 19px;
      font-weight: 700;
      color: #165a28;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    .subjects-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .subject-item {
      padding: 12px 15px;
      background: #f8f9fa;
      border-left: 3px solid #165a28;
      margin-bottom: 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .subject-item:hover {
      background: #e8f5e9;
      transform: translateX(5px);
    }

    .subject-name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .subject-units {
      background: #165a28;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    .financial-summary {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-item:last-child {
      border-bottom: none;
      margin-top: 10px;
      padding-top: 15px;
      border-top: 2px solid #165a28;
      font-size: 18px;
      font-weight: 700;
    }

    .summary-item.highlight {
      color: #165a28;
    }

    .summary-label {
      color: #666;
      font-size: 14px;
    }

    .summary-value {
      font-weight: 600;
      color: #333;
      font-size: 15px;
    }

    .summary-value.large {
      font-size: 20px;
      color: #165a28;
    }

    .payment-progress {
      margin: 25px 0;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .progress-bar-container {
      background: #e0e0e0;
      height: 30px;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      border-radius: 15px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 15px;
      color: white;
      font-weight: 700;
      font-size: 13px;
    }

    .fees-breakdown-table {
      width: 100%;
      margin-top: 15px;
    }

    .fees-breakdown-table th {
      background: #f8f9fa;
      color: #333;
      font-weight: 600;
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #165a28;
    }

    .fees-breakdown-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .fees-breakdown-table tr:hover {
      background: #f8f9fa;
    }

    .fee-amount {
      text-align: right;
      font-weight: 600;
      color: #165a28;
    }

    .quick-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .action-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .action-btn.primary {
      background: #165a28;
      color: white;
    }

    .action-btn.primary:hover {
      background: #0d3d1a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(22,90,40,0.3);
    }

    .action-btn.secondary {
      background: white;
      color: #165a28;
      border: 2px solid #165a28;
    }

    .action-btn.secondary:hover {
      background: #f8f9fa;
    }

    .action-btn:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      transform: none;
    }

    .payment-methods-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .payment-method-card {
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .payment-method-card:hover {
      border-color: #165a28;
      background: #f8f9fa;
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .payment-method-card.selected {
      border-color: #165a28;
      background: #e8f5e9;
      border-width: 3px;
    }

    .payment-method-icon {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .payment-method-name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .payment-form-enhanced {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      margin-top: 20px;
      border: 2px solid #e0e0e0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Source Sans Pro', sans-serif;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #165a28;
      box-shadow: 0 0 0 3px rgba(22,90,40,0.1);
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #1976d2;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
      font-size: 14px;
      color: #555;
    }

    .info-box.warning {
      background: #fff3e0;
      border-left-color: #f57c00;
    }

    .info-box.success {
      background: #e8f5e9;
      border-left-color: #28a745;
    }

    .scholarship-badge {
      display: inline-block;
      padding: 6px 14px;
      background: #d4af37;
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: white;
      margin: 3% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 25px 30px;
      background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
      color: white;
      border-radius: 12px 12px 0 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .modal-header h2 {
      font-family: 'Crimson Text', serif;
      font-size: 28px;
      margin: 0;
    }

    .modal-body {
      padding: 30px;
    }

    .close {
      color: white;
      float: right;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
      transition: all 0.3s ease;
    }

    .close:hover {
      color: #d4af37;
      transform: rotate(90deg);
    }

    .summary-card {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      border: 1px solid #e0e0e0;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #dee2e6;
    }

    .summary-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 20px;
      color: #165a28;
      margin-top: 10px;
      padding-top: 15px;
      border-top: 2px solid #165a28;
    }

    .label {
      color: #666;
      font-size: 15px;
    }

    .value {
      font-weight: 600;
      color: #333;
      font-size: 15px;
    }

    .installment-card {
      background: white;
      border: 2px solid #165a28;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .installment-card:hover {
      box-shadow: 0 4px 12px rgba(22,90,40,0.2);
      transform: translateY(-2px);
    }

    .installment-card.paid {
      border-color: #28a745;
      background: #f0fff4;
    }

    .installment-card.pending {
      border-color: #ffc107;
      background: #fffbf0;
    }

    .term-label {
      font-size: 20px;
      font-weight: 700;
      text-transform: uppercase;
      color: #165a28;
      font-family: 'Crimson Text', serif;
    }

    .term-amount {
      font-size: 24px;
      font-weight: 700;
      color: #165a28;
      font-family: 'Crimson Text', serif;
    }

    .status-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      margin-top: 8px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-paid {
      background: #28a745;
      color: white;
    }

    .status-pending {
      background: #ffc107;
      color: #333;
    }

    .downpayment-badge {
      background: #17a2b8;
      color: white;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
      font-weight: 600;
    }

    .alert {
      margin-top: 25px;
      padding: 20px;
      background: #fff3cd;
      border-radius: 10px;
      border-left: 4px solid #ffc107;
    }

    .alert strong {
      color: #856404;
    }

    .no-installments {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .no-installments h3 {
      color: #165a28;
      margin-bottom: 10px;
      font-family: 'Crimson Text', serif;
      font-size: 24px;
    }

    /* CALENDAR STYLES */
    .calendar-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #165a28;
    }

    .calendar-title {
      font-family: 'Crimson Text', serif;
      font-size: 24px;
      font-weight: 700;
      color: #165a28;
    }

    .view-toggle {
      display: flex;
      gap: 10px;
      background: #f8f9fa;
      padding: 5px;
      border-radius: 8px;
    }

    .view-toggle button {
      padding: 8px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .view-toggle button.active {
      background: #165a28;
      color: white;
    }

    .view-toggle button:hover:not(.active) {
      background: #e0e0e0;
    }

    /* Weekly Calendar Grid */
    .calendar-grid {
      display: grid;
      grid-template-columns: 80px repeat(6, 1fr);
      gap: 1px;
      background: #e0e0e0;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-day-header {
      background: #165a28;
      color: white;
      padding: 10px 8px;
      text-align: center;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .calendar-time-label {
      background: #f8f9fa;
      padding: 10px 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-cell {
      background: white;
      padding: 4px;
      min-height: 70px;
      position: relative;
    }

    .class-block {
      background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      line-height: 1.3;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .class-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(22,90,40,0.4);
    }

    .class-subject {
      font-weight: 700;
      margin-bottom: 3px;
      font-size: 13px;
    }

    .class-time {
      font-size: 10px;
      opacity: 0.9;
      margin-bottom: 3px;
    }

    .class-room {
      font-size: 10px;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .class-instructor {
      font-size: 10px;
      opacity: 0.8;
      margin-top: 3px;
      font-style: italic;
    }

    /* List View */
    .schedule-list {
      display: none;
    }

    .schedule-list.active {
      display: block;
    }

    .schedule-day-section {
      margin-bottom: 20px;
    }

    .day-section-header {
      background: #165a28;
      color: white;
      padding: 12px 18px;
      border-radius: 8px 8px 0 0;
      font-weight: 700;
      font-size: 16px;
      font-family: 'Crimson Text', serif;
    }

    .day-classes-list {
      background: white;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 8px 8px;
    }

    .class-list-item {
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
      transition: all 0.3s ease;
    }

    .class-list-item:last-child {
      border-bottom: none;
    }

    .class-list-item:hover {
      background: #f8f9fa;
    }

    .class-list-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }

    .class-list-subject {
      font-size: 17px;
      font-weight: 700;
      color: #165a28;
      font-family: 'Crimson Text', serif;
    }

    .class-list-time-badge {
      background: #165a28;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .class-list-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .class-detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
      font-size: 13px;
    }

    .class-detail-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    .empty-schedule {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-schedule h3 {
      font-family: 'Crimson Text', serif;
      font-size: 24px;
      color: #165a28;
      margin-bottom: 10px;
    }

    /* Document Request Styles */
    .document-request-form {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 25px;
    }

    .request-form-title {
      font-family: 'Crimson Text', serif;
      font-size: 22px;
      font-weight: 700;
      color: #165a28;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #165a28;
    }

    .document-type-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .document-type-option {
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .document-type-option:hover {
      border-color: #165a28;
      background: #f8f9fa;
      box-shadow: 0 2px 8px rgba(22,90,40,0.15);
    }

    .document-type-option.selected {
      border-color: #165a28;
      background: #e8f5e9;
      border-width: 3px;
      box-shadow: 0 4px 12px rgba(22,90,40,0.2);
    }

    .document-type-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .document-type-name {
      font-weight: 600;
      color: #333;
      font-size: 13px;
    }

    .requests-history {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .request-item {
      padding: 15px;
      border-left: 4px solid #165a28;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .request-item:hover {
      background: #e8f5e9;
      transform: translateX(3px);
    }

    .request-item-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }

    .request-item-title {
      font-size: 14px;
      font-weight: 700;
      color: #165a28;
      margin-bottom: 4px;
    }

    .request-item-meta {
      font-size: 11px;
      color: #666;
      display: flex;
      gap: 15px;
      margin-bottom: 6px;
    }

    .request-item-details {
      font-size: 12px;
      color: #555;
      line-height: 1.5;
    }

    .request-status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .status-pending {
      background: #fff3e0;
      color: #e65100;
    }

    .status-approved {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-rejected {
      background: #ffebee;
      color: #c62828;
    }

    .status-ready {
      background: #e3f2fd;
      color: #1565c0;
    }

    .copies-selector {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
    }

    .copies-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #165a28;
      background: white;
      border-radius: 50%;
      font-size: 20px;
      font-weight: 700;
      color: #165a28;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .copies-btn:hover {
      background: #165a28;
      color: white;
    }

    .copies-display {
      font-size: 24px;
      font-weight: 700;
      color: #165a28;
      min-width: 40px;
      text-align: center;
    }

    /* Document Viewer Modal */
    .document-viewer-modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      animation: fadeIn 0.3s ease;
    }

    .document-viewer-content {
      background-color: white;
      margin: 2% auto;
      border-radius: 12px;
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.3s ease;
    }

    .document-viewer-header {
      padding: 20px 25px;
      background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
      color: white;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .document-viewer-header h2 {
      margin: 0;
      font-family: 'Crimson Text', serif;
      font-size: 24px;
    }

    .document-viewer-close {
      background: none;
      border: none;
      color: white;
      font-size: 32px;
      cursor: pointer;
      line-height: 1;
      transition: all 0.3s ease;
      padding: 0;
      width: 40px;
      height: 40px;
    }

    .document-viewer-close:hover {
      color: #d4af37;
      transform: rotate(90deg);
    }

    .document-viewer-body {
      flex: 1;
      overflow: auto;
      padding: 20px;
      background: #f5f5f5;
    }

   .document-image-container {
  background: white;
  border-radius: 8px;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 600px;
}

    /* PDF Viewer Styles */

.document-image-container embed {
  width: 100%;
  height: 80vh;
  max-height: 800px;
  border: none;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.document-image-container embed::-webkit-scrollbar {
  display: none;
}

.document-viewer-body {
  background: #f5f5f5;
  padding: 20px;
  overflow: auto;
  max-height: calc(90vh - 180px);
}
.document-image-container {
  background: #f5f5f5;
  border-radius: 8px;
  padding: 10px;
}

    .document-image {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      background: white;
    }

    .document-actions {
      padding: 20px 25px;
      background: #f8f9fa;
      border-radius: 0 0 12px 12px;
      display: flex;
      gap: 15px;
      justify-content: center;
      border-top: 1px solid #e0e0e0;
    }

    .download-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: #165a28;
      color: white;
      text-decoration: none;
    }

    .download-btn:hover {
      background: #0d3d1a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(22, 90, 40, 0.3);
    }

    .grades-container {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    }

   .grades-header-card {
    background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
    color: white;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 25px;
    box-shadow: 0 4px 20px rgba(22,90,40,0.3);
    }

    .grades-header-card h2 {
      font-family: 'Crimson Text', serif;
      font-size: 26px;
      margin-bottom: 8px;
      color: white;
    }

    .grades-student-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .grades-info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .grades-info-label {
      font-size: 10px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .grades-info-value {
      font-size: 16px;
      font-weight: 700;
      color: #d4af37;
    }

    .gpa-card {
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      color: #333;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(212,175,55,0.3);
    }

    .gpa-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .gpa-value {
      font-size: 48px;
      font-weight: 700;
      font-family: 'Crimson Text', serif;
    }

    .gpa-total {
      font-size: 14px;
      margin-top: 5px;
      opacity: 0.8;
    }

    .grades-table-container {
      overflow-x: auto;
    }

    .grades-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .grades-table th {
      background: #165a28;
      color: white;
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .grades-table td {
      padding: 14px 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .grades-table tr:hover {
      background: #f8f9fa;
    }

    .grade-value {
      font-weight: 700;
      font-size: 15px;
      color: #165a28;
    }

    .grade-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      display: inline-block;
    }

    .grade-excellent {
      background: #28a745;
      color: white;
    }

    .grade-good {
      background: #17a2b8;
      color: white;
    }

    .grade-fair {
      background: #ffc107;
      color: #333;
    }

    .grade-poor {
      background: #dc3545;
      color: white;
    }

    .grade-incomplete {
      background: #6c757d;
      color: white;
    }

    .no-grades-message {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .no-grades-message h3 {
      font-family: 'Crimson Text', serif;
      font-size: 28px;
      color: #165a28;
      margin-bottom: 15px;
    }

    .no-grades-message p {
      font-size: 15px;
      line-height: 1.6;
    }

    .released-badge {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
    }

    .download-grades-btn {
      background: #165a28;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
    }

    .download-grades-btn:hover {
      background: #0d3d1a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(22,90,40,0.3);
    }

    .profile-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  border: 2px solid #d4af37;
  flex-shrink: 0;
  overflow: hidden;
  position: relative;
}

.profile-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}



/* ‚îÄ‚îÄ Semester Filter Bar ‚îÄ‚îÄ */
.semester-filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 14px 16px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 20px;
  align-items: center;
}

.sem-filter-btn {
  padding: 6px 14px;
  border: 2px solid #e0e0e0;
  background: white;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #555;
}

.sem-filter-btn:hover { border-color: #165a28; color: #165a28; }
.sem-filter-btn.active { background: #165a28; color: white; border-color: #165a28; }

/* ‚îÄ‚îÄ Semester Group ‚îÄ‚îÄ */
.semester-group { margin-bottom: 30px; }

.semester-group-header {
  background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
  color: white;
  padding: 14px 20px;
  border-radius: 8px 8px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.semester-group-title {
  font-family: 'Crimson Text', serif;
  font-size: 18px;
  font-weight: 700;
}

.semester-gwa-badge {
  background: #d4af37;
  color: #333;
  padding: 5px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
}

/* Profile Settings Modal */
.profile-modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  animation: fadeIn 0.3s ease;
}

.profile-modal-content {
  background-color: white;
  margin: 3% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease;
}

.profile-modal-header {
  padding: 25px 30px;
  background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
  color: white;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.profile-modal-header h2 {
  font-family: 'Crimson Text', serif;
  font-size: 24px;
  margin: 0;
}

.profile-modal-body {
  padding: 30px;
}

/* Profile Picture Upload Section */
.profile-picture-section {
  text-align: center;
  margin-bottom: 30px;
  padding: 25px;
  background: #f8f9fa;
  border-radius: 10px;
  border: 2px dashed #e0e0e0;
}

.profile-picture-preview {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  margin: 0 auto 20px;
  background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  border: 4px solid #d4af37;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  position: relative;
}

.profile-picture-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-picture-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.profile-picture-preview:hover .profile-picture-overlay {
  display: flex;
}

.upload-btn-wrapper {
  position: relative;
  display: inline-block;
  margin-top: 10px;
}



.upload-picture-btn {
  background: #165a28;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.upload-picture-btn:hover {
  background: #0d3d1a;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(22,90,40,0.3);
}

.remove-picture-btn {
  background: #dc3545;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  margin-left: 10px;
  transition: all 0.3s ease;
}

.remove-picture-btn:hover {
  background: #c82333;
}

.upload-hint {
  font-size: 11px;
  color: #666;
  margin-top: 10px;
}
   

    /* Responsive */
    @media (max-width: 1024px) {
      .calendar-grid {
        grid-template-columns: 60px repeat(6, 1fr);
      }

      .billing-content-grid {
        grid-template-columns: 1fr;
      }

      .billing-sidebar-card {
        position: static;
      }

      .payment-methods-grid {
        grid-template-columns: 1fr;
      }

      .footer-content {
        grid-template-columns: 1fr;
        gap: 25px;
      }
    }

    @media (max-width: 768px) {
      .university-header {
        padding: 12px 15px;
      }

      .university-logo {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }

      .university-title {
        font-size: 16px;
      }

      .university-subtitle {
        font-size: 9px;
      }

      .header-user-info {
        display: none;
      }

      .main-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        position: static;
        height: auto;
      }

      .page-header {
        padding: 15px 20px;
      }

      .content-wrapper {
        padding: 20px;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .billing-semester-info {
        gap: 15px;
      }

      .billing-header-card {
        padding: 20px;
      }

      .quick-actions {
        flex-direction: column;
      }

      .calendar-grid {
        display: none;
      }

      .schedule-list {
        display: block !important;
      }

      .view-toggle {
        display: none;
      }

      .university-footer {
        padding: 25px 20px 15px;
      }
    }
   
    .materials-card {
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 15px;
  border-left: 4px solid #165a28;
  transition: all 0.3s ease;
}

.materials-card:hover {
  background: #f8f9fa;
  transform: translateX(3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.materials-card.overdue {
  border-left-color: #dc3545;
}

.materials-card.submitted {
  border-left-color: #28a745;
}

/* Material Header */
.material-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 10px;
}

.material-title {
  font-size: 16px;
  font-weight: 700;
  color: #165a28;
  margin-bottom: 5px;
  font-family: 'Crimson Text', serif;
}

.material-meta {
  font-size: 11px;
  color: #666;
  display: flex;
  gap: 12px;
  margin-bottom: 8px;
  flex-wrap: wrap;
}

.material-description {
  font-size: 13px;
  color: #555;
  line-height: 1.5;
  margin-bottom: 10px;
}

/* Material Info Grid */
.material-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin: 10px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 6px;
}

.material-info-item {
  font-size: 11px;
  color: #666;
}

.material-info-item strong {
  color: #333;
  font-weight: 600;
}

/* Status Badges for Materials */
.status-on-time {
  background: #e8f5e9;
  color: #2e7d32;
}

.status-late {
  background: #ffebee;
  color: #c62828;
}

.status-not-submitted {
  background: #fff3e0;
  color: #e65100;
}

.status-submitted {
  background: #e8f5e9;
  color: #2e7d32;
}

/* Material Actions */
.material-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.material-download-btn,
.material-submit-btn {
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
}

.material-download-btn {
  background: white;
  color: #165a28;
  border: 2px solid #165a28;
}

.material-download-btn:hover {
  background: #f8f9fa;
  transform: translateY(-2px);
}

.material-submit-btn {
  background: #165a28;
  color: white;
  border: none;
}

.material-submit-btn:hover {
  background: #0d3d1a;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(22,90,40,0.3);
}

/* Submission Status Display */
.submission-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 10px;
}

.submission-status.success {
  background: #e8f5e9;
  color: #2e7d32;
}

.submission-status.late {
  background: #fff3e0;
  color: #e65100;
}

/* Submissions List Styles */
.submission-card {
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 12px;
  border-left: 4px solid #28a745;
  transition: all 0.3s ease;
}

.submission-card:hover {
  background: #f8f9fa;
  transform: translateX(3px);
}

.submission-card.late {
  border-left-color: #ffc107;
}

.submission-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 8px;
}

.submission-title {
  font-size: 15px;
  font-weight: 700;
  color: #165a28;
  margin-bottom: 4px;
}

.submission-meta {
  font-size: 11px;
  color: #666;
  display: flex;
  gap: 12px;
  margin-bottom: 6px;
}

/* Teacher Remarks Box */
.teacher-remarks {
  margin-top: 10px;
  padding: 10px;
  background: #e8f5e9;
  border-radius: 6px;
  border-left: 4px solid #28a745;
}

.teacher-remarks strong {
  color: #2e7d32;
  font-weight: 600;
  font-size: 12px;
}

.teacher-remarks p {
  color: #555;
  font-size: 12px;
  margin-top: 4px;
  line-height: 1.4;
}

/* Submit Assignment Modal Styles */
.submit-modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  animation: fadeIn 0.3s ease;
}

.submit-modal-content {
  background-color: white;
  margin: 5% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease;
}

.submit-modal-header {
  padding: 20px 25px;
  background: linear-gradient(135deg, #165a28 0%, #0d3d1a 100%);
  color: white;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.submit-modal-header h2 {
  font-family: 'Crimson Text', serif;
  font-size: 22px;
  margin: 0;
}

.submit-modal-body {
  padding: 25px;
}

/* File Upload Input Styles */
.file-upload-area {
  border: 2px dashed #e0e0e0;
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  background: #f8f9fa;
  transition: all 0.3s ease;
  cursor: pointer;
}

.file-upload-area:hover {
  border-color: #165a28;
  background: #e8f5e9;
}

.file-upload-area.active {
  border-color: #165a28;
  background: #e8f5e9;
}

.file-upload-icon {
  font-size: 48px;
  margin-bottom: 10px;
  color: #165a28;
}

.file-upload-text {
  font-size: 14px;
  color: #666;
  margin-bottom: 5px;
}

.file-upload-hint {
  font-size: 11px;
  color: #999;
}

.file-selected-info {
  margin-top: 15px;
  padding: 12px;
  background: #e8f5e9;
  border-radius: 6px;
  border-left: 4px solid #28a745;
}

.file-selected-info strong {
  color: #2e7d32;
  font-size: 13px;
}

.file-selected-info p {
  font-size: 12px;
  color: #555;
  margin-top: 4px;
}

/* Empty States */
.empty-materials {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-materials-icon {
  font-size: 64px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.empty-materials h3 {
  font-family: 'Crimson Text', serif;
  font-size: 24px;
  color: #165a28;
  margin-bottom: 10px;
}

.empty-materials p {
  font-size: 14px;
  line-height: 1.6;
}

/* Materials Filter/Sort Bar */
.materials-filter-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  gap: 15px;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  gap: 10px;
  align-items: center;
}

.filter-label {
  font-size: 12px;
  font-weight: 600;
  color: #666;
}

.filter-select {
  padding: 8px 12px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 13px;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

.filter-select:hover {
  border-color: #165a28;
}

.filter-select:focus {
  outline: none;
  border-color: #165a28;
  box-shadow: 0 0 0 3px rgba(22,90,40,0.1);
}

/* Subject Badge */
.subject-badge {
  display: inline-block;
  padding: 4px 10px;
  background: #165a28;
  color: white;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

/* File Type Icon */
.file-type-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 6px;
  background: #e8f5e9;
  color: #165a28;
  font-size: 18px;
  margin-right: 10px;
}

.file-type-icon.video {
  background: #e3f2fd;
  color: #1976d2;
}

.file-type-icon.document {
  background: #fff3e0;
  color: #f57c00;
}

.file-type-icon.image {
  background: #fce4ec;
  color: #c2185b;
}

/* Progress Indicator for Submissions */
.submission-progress {
  margin-top: 15px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 6px;
}

.progress-label {
  font-size: 12px;
  color: #666;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
  transition: width 0.3s ease;
}

/* Due Date Warning */
.due-date-warning {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: #fff3e0;
  color: #e65100;
  border-radius: 15px;
  font-size: 11px;
  font-weight: 600;
}

.due-date-warning.urgent {
  background: #ffebee;
  color: #c62828;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Responsive Styles for Materials */
@media (max-width: 768px) {
  .materials-filter-bar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .filter-group {
    width: 100%;
  }
  
  .filter-select {
    width: 100%;
  }
  
  .material-actions {
    flex-direction: column;
  }
  
  .material-download-btn,
  .material-submit-btn {
    width: 100%;
    justify-content: center;
  }
  
  .material-info-grid {
    grid-template-columns: 1fr;
  }
}

/* Loading State */
.materials-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: #999;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #e0e0e0;
  border-top-color: #165a28;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 15px;
  font-size: 14px;
  color: #666;
}

/* Success Message */
.submission-success {
  padding: 15px;
  background: #e8f5e9;
  border-left: 4px solid #28a745;
  border-radius: 6px;
  margin-bottom: 20px;
}

.submission-success strong {
  color: #2e7d32;
  font-size: 14px;
}

.submission-success p {
  color: #555;
  font-size: 13px;
  margin-top: 5px;
}

/* Error Message */
.submission-error {
  padding: 15px;
  background: #ffebee;
  border-left: 4px solid #dc3545;
  border-radius: 6px;
  margin-bottom: 20px;
}

.submission-error strong {
  color: #c62828;
  font-size: 14px;
}

.submission-error p {
  color: #555;
  font-size: 13px;
  margin-top: 5px;
}
  </style>
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>

<body>

<!-- University Header -->
<div class="university-header">
  <div class="header-content">
    <div class="university-branding">
      <div class="university-logo">UM</div>
      <div class="university-name">
        <div class="university-title">The University of Manila</div>
        <div class="university-subtitle">Student Portal System</div>
      </div>
    </div>
    
  
      
      <div class="notification-container">
        <button class="notification-bell" onclick="toggleNotifications()">
          üîî
          <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
        </button>
        
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-header">
            üì¨ Notifications
          </div>
          <div id="notificationList">
            <div class="notification-empty">
              Loading notifications...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="main-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Compact Profile Section -->
   <div class="profile-section">
  <div class="profile-header" onclick="showProfileSettings(event)" style="cursor: pointer;">
    <div class="profile-avatar">üë§</div>
    <div class="profile-info">
      <div class="profile-name" id="profileName">Loading...</div>
      <div class="profile-id" id="profileStudentId">ID: -------</div>
      <div class="profile-status" id="profileYearLevel">Year: --</div>
    </div>
  </div>
</div>

    <div class="nav-section">
      <div class="nav-section-title">Main Menu</div>
      <a href="#" class="active" onclick="showDashboard(event)">
        <span class="icon">üè†</span> Dashboard
      </a>
      <a href="#" onclick="showBilling(event)">
        <span class="icon">üí≥</span> Student Billing
      </a>
      <a href="#" onclick="showSchedule(event)">
        <span class="icon">üìÖ</span> Class Schedule
      </a>

         <a href="#" onclick="showMaterials(event)">
        <span class="icon">üìö</span> Lesson Materials
      </a>
      
      <a href="#" onclick="showDocuments(event)">
        <span class="icon">üìÑ</span> Document Request
      </a>
      <a href="#" onclick="showGrades(event)">
        <span class="icon">üìä</span> My Grades
      </a>

      <a href="#" onclick="showEnrollment(event)">
  <span class="icon">üìù</span> Re-Enrollment
</a>
    </div>

    <div class="nav-section">
  <div class="nav-section-title">Account</div>
  <a href="#" onclick="showProfileSettings(event)">
    <span class="icon">üë§</span> Profile
  </a>
  <a href="#" onclick="showSettings(event)">
    <span class="icon">‚öôÔ∏è</span> Settings
  </a>
  <a href="#" onclick="handleLogout(event)">
    <span class="icon">üö™</span> Logout
  </a>
</div>
  </div>
<!-- Main Content -->
  <div class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <h1 id="pageTitle">Dashboard</h1>
      <div class="breadcrumb">
        <a href="#" onclick="showDashboard(event)">Home</a> / <span id="breadcrumbCurrent">Dashboard</span>
      </div>
    </div>

    <!-- Content Wrapper -->
    <div class="content-wrapper">

      <!-- Dashboard View -->
      <div id="dashboardView">
        <div class="dashboard-grid">
          <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-label">Enrolled Subjects</div>
            <div class="stat-value" id="statSubjects">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-label">Total Units</div>
            <div class="stat-value" id="statUnits">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-label">Balance Due</div>
            <div class="stat-value" id="statBalance">‚Ç±0</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-label">Payment Status</div>
            <div class="stat-value" id="statStatus" style="font-size: 20px;">-</div>
          </div>
        </div>

        <div class="section-header">
          <h2>üì¢ Latest Announcements</h2>
          <div class="filter-dropdown-container">
            <button class="filter-dropdown-btn" onclick="toggleAnnouncementFilter(event)">
              <span id="currentFilterLabel">All Announcements</span>
              <span style="font-size: 10px;">‚ñº</span>
            </button>
            <div class="filter-dropdown-menu" id="announcementFilterMenu">
              <div class="filter-dropdown-item active" onclick="filterAnnouncements('all')" data-filter="all">
                <span>üì¢</span> All Announcements
              </div>
              <div class="filter-dropdown-item" onclick="filterAnnouncements('teacher')" data-filter="teacher">
                <span>üë®‚Äçüè´</span> Teacher
              </div>
              <div class="filter-dropdown-item" onclick="filterAnnouncements('registrar')" data-filter="registrar">
                <span>üì¢</span> Registrar
              </div>
              <div class="filter-dropdown-item" onclick="filterAnnouncements('records')" data-filter="records">
                <span>üìã</span> Records
              </div>
            </div>
          </div>
        </div>

        <div id="announcementsContainer">
          <div style="text-align:center; padding:40px; color:#999;">
            Loading announcements...
          </div>
        </div>
      </div>

      <!-- Billing View -->
      <div id="billingView" style="display:none;">
        <div id="message"></div>
        <div id="result"></div>
      </div>

      <!-- Schedule View -->
      <div id="scheduleView" style="display:none;">
        <div class="calendar-container">
          <div class="calendar-header">
            <h2 class="calendar-title">üìÖ My Class Schedule</h2>
            <div class="view-toggle">
              <button class="active" onclick="toggleView('calendar')">üìÖ Calendar View</button>
              <button onclick="toggleView('list')">üìã List View</button>
            </div>
          </div>
          <div id="calendarView" class="calendar-view">
            <div class="calendar-grid" id="calendarGrid">
              <div class="calendar-day-header" style="background:#f8f9fa;"></div>
              <div class="calendar-day-header">Monday</div>
              <div class="calendar-day-header">Tuesday</div>
              <div class="calendar-day-header">Wednesday</div>
              <div class="calendar-day-header">Thursday</div>
              <div class="calendar-day-header">Friday</div>
              <div class="calendar-day-header">Saturday</div>
            </div>
          </div>
          <div id="listView" class="schedule-list">
            <div id="scheduleListContent"></div>
          </div>
        </div>
      </div>

      <!-- Document Request View -->
      <div id="documentsView" style="display:none;">
        <div class="document-request-form">
          <h2 class="request-form-title">üìÑ Request a Document</h2>
          <div class="info-box">
            <strong>üìå Request Instructions:</strong><br>
            Select the document type you need, specify your purpose, and choose the number of copies.
            All requests will be reviewed by the Registrar's Office within 2-3 business days.
          </div>
          <form id="documentRequestForm">
            <div class="form-group">
              <label class="form-label">Select Document Type</label>
              <div class="document-type-grid">
                <div class="document-type-option" onclick="selectDocumentType('Certificate of Enrollment')">
                  <div class="document-type-icon">üìã</div>
                  <div class="document-type-name">Certificate of Enrollment</div>
                </div>
                <div class="document-type-option" onclick="selectDocumentType('Certificate of Grades')">
                  <div class="document-type-icon">üìä</div>
                  <div class="document-type-name">Certificate of Grades</div>
                </div>
                <div class="document-type-option" onclick="selectDocumentType('Transcript of Records')">
                  <div class="document-type-icon">üìú</div>
                  <div class="document-type-name">Transcript of Records</div>
                </div>
                <div class="document-type-option" onclick="selectDocumentType('Certificate of Good Moral')">
                  <div class="document-type-icon">‚≠ê</div>
                  <div class="document-type-name">Good Moral Certificate</div>
                </div>
                <div class="document-type-option" onclick="selectDocumentType('Honorable Dismissal')">
                  <div class="document-type-icon">üéì</div>
                  <div class="document-type-name">Honorable Dismissal</div>
                </div>
                <div class="document-type-option" onclick="selectDocumentType('CAV (Certification, Authentication, Verification)')">
                  <div class="document-type-icon">‚úÖ</div>
                  <div class="document-type-name">CAV Certificate</div>
                </div>
              </div>
              <input type="hidden" id="selectedDocumentType" />
            </div>
            <div class="form-group">
              <label class="form-label">Number of Copies</label>
              <div class="copies-selector">
                <button type="button" class="copies-btn" onclick="decrementCopies()">‚àí</button>
                <div class="copies-display" id="copiesDisplay">1</div>
                <button type="button" class="copies-btn" onclick="incrementCopies()">+</button>
                <span style="color:#666; font-size:12px; margin-left:10px;">(Maximum: 10 copies)</span>
              </div>
            </div>
            <div class="form-group" id="purposeGroup" style="display:none;">
              <label class="form-label">Purpose of Request *</label>
              <select id="purposeDropdown" class="form-input" required>
                <option value="">-- Select Purpose --</option>
              </select>
              <div style="margin-top:8px; font-size:12px; color:#666;">
                üí° If your purpose is not listed, select "Other" and specify below
              </div>
            </div>
            <div class="form-group" id="otherPurposeGroup" style="display:none;">
              <label class="form-label">Please Specify Purpose *</label>
              <textarea
                id="otherPurposeInput"
                class="form-input"
                placeholder="Please provide details about your specific purpose..."
                rows="3"
                style="resize: vertical;"
              ></textarea>
            </div>
            <div class="quick-actions">
              <button type="submit" class="action-btn primary">
                <span>üì§</span> Submit Request
              </button>
              <button type="button" class="action-btn secondary" onclick="resetDocumentForm()">
                <span>üîÑ</span> Clear Form
              </button>
            </div>
          </form>
        </div>
        <div class="requests-history">
          <div class="section-header">
            <h2>üìã My Document Requests</h2>
            <button class="view-all-btn" onclick="loadDocumentRequests()">üîÑ Refresh</button>
          </div>
          <div id="requestsContainer">
            <div style="text-align:center; padding:40px; color:#999;">
              Loading requests...
            </div>
          </div>
        </div>
      </div>

      <!-- Grades View -->
      <div id="gradesView" style="display:none;">
        <div id="gradesMessage"></div>
        <div id="gradesResult">
          <div style="text-align:center;padding:60px;color:#999;">
            Loading your grades...
          </div>
        </div>
      </div>

      <!-- Lesson Materials View -->
      <div id="materialsView" style="display:none;">
        <div id="materialsMessage"></div>
        <div class="announcements-section">
          <div class="section-header">
            <h2>üìö Available Lesson Materials</h2>
            <button class="view-all-btn" onclick="loadLessonMaterials()">üîÑ Refresh</button>
          </div>
          <div id="materialsContainer">
            <div style="text-align:center;padding:40px;color:#999;">
              Loading materials...
            </div>
          </div>
        </div>
        <div class="announcements-section" style="margin-top:25px;">
          <div class="section-header">
            <h2>üì§ My Submissions</h2>
            <button class="view-all-btn" onclick="loadMySubmissions()">üîÑ Refresh</button>
          </div>
          <div id="submissionsContainer">
            <div style="text-align:center;padding:40px;color:#999;">
              Loading submissions...
            </div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ ENROLLMENT VIEW ‚Äî INSIDE content-wrapper (FIXED) -->
      <div id="enrollmentView" style="display:none;">
     
      
        <!-- Application Form -->
        <div class="announcements-section" style="margin-bottom:20px;">
          <div class="section-header">
            <h2>üìù Re-Enrollment Application</h2>
            <button class="view-all-btn" onclick="document.getElementById('enrollmentForm').reset(); resetEnrollForm();">üîÑ Clear Form</button>
          </div>

          <!-- Alert Box ‚Äî matches registration -->
          <div style="background:#e8f5e9; border-left:4px solid #165a28; padding:14px 16px; border-radius:8px; margin-bottom:20px; display:flex; align-items:flex-start; gap:12px;">
            <span style="font-size:18px; margin-top:1px;">üìã</span>
            <div>
              <div style="font-size:13px; font-weight:700; color:#165a28; margin-bottom:3px;">Application Guidelines</div>
              <div style="font-size:12px; color:#555;">All fields marked with <span style="color:#dc2626; font-weight:700;">*</span> are required. Please ensure all information is accurate before submission.</div>
            </div>
          </div>

          <!-- Progress Bar ‚Äî matches registration -->
          <div id="enrollProgressIndicator" style="display:none; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#555; margin-bottom:6px;">
              <span>Application Progress</span>
              <span id="enrollProgressPercent">0%</span>
            </div>
            <div style="background:#e0e0e0; border-radius:99px; height:8px; overflow:hidden;">
              <div id="enrollProgressFill" style="background:linear-gradient(90deg,#165a28,#40916c); height:100%; border-radius:99px; width:0%; transition:width 0.4s ease;"></div>
            </div>
          </div>

          <div id="enrollmentMessage" style="margin-bottom:16px;"></div>

          <form id="enrollmentForm" onsubmit="submitEnrollment(event)">

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERSONAL INFORMATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
           <div style="background:#f9f9f9; border:1px solid #e8e8e8; border-radius:10px; padding:24px; margin-bottom:20px;">
  <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px; padding-bottom:14px; border-bottom:2px solid #e8e8e8;">
    <div style="width:38px; height:38px; background:linear-gradient(135deg,#165a28,#40916c); border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0;">üë§</div>
    <h3 style="margin:0; font-size:16px; font-weight:700; color:#165a28;">Personal Information</h3>
  </div>

  <!-- ‚úÖ Student ID Number (half width, read-only) -->
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
    <div>
      <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Student ID Number <span style="color:#dc2626;">*</span></label>
      <div style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; background:#f0f0f0; color:#555; font-weight:700; box-sizing:border-box; min-height:44px; display:flex; align-items:center; justify-content:space-between;">
        <span id="enroll_student_id_display">‚Äî</span>
        <span style="font-size:10px; color:#aaa; white-space:nowrap;">üîí Auto-filled</span>
      </div>
    </div>
  </div>

    <!-- First / Middle / Last Name -->
  <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
    <div>
      <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">First Name <span style="color:#dc2626;">*</span></label>
      <input type="text" id="enroll_first_name" placeholder="First name"
        style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;"
        oninput="updateEnrollProgress()" required>
    </div>
    <div>
      <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Middle Name</label>
      <input type="text" id="enroll_middle_name" placeholder="Middle name (optional)"
        style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
    </div>
    <div>
      <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Last Name <span style="color:#dc2626;">*</span></label>
      <input type="text" id="enroll_last_name" placeholder="Last name"
        style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;"
        oninput="updateEnrollProgress()" required>
    </div>
  </div>

              <!-- Age / Contact / Email -->
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Age <span style="color:#dc2626;">*</span></label>
                  <input type="number" id="enroll_age" placeholder="Age" min="15" max="100"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;"
                    oninput="updateEnrollProgress()" required>
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Contact Number <span style="color:#dc2626;">*</span></label>
                  <input type="tel" id="enroll_contact" placeholder="09XX XXX XXXX"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;"
                    oninput="updateEnrollProgress()" required>
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Email Address <span style="color:#dc2626;">*</span></label>
                  <input type="email" id="enroll_email" placeholder="student@email.com"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;"
                    oninput="updateEnrollProgress()" required>
                </div>
              </div>

              <!-- Complete Address -->
              <div>
                <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Complete Address <span style="color:#dc2626;">*</span></label>
                <textarea id="enroll_address" placeholder="House/Unit No., Street, Barangay, City/Municipality, Province"
                  style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; min-height:70px; resize:vertical; box-sizing:border-box;"
                  oninput="updateEnrollProgress()" required></textarea>
              </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FATHER'S INFORMATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background:#f9f9f9; border:1px solid #e8e8e8; border-radius:10px; padding:24px; margin-bottom:20px;">
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px; padding-bottom:14px; border-bottom:2px solid #e8e8e8;">
                <div style="width:38px; height:38px; background:linear-gradient(135deg,#165a28,#40916c); border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0;">üë®</div>
                <h3 style="margin:0; font-size:16px; font-weight:700; color:#165a28;">Father's Information</h3>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">First Name</label>
                  <input type="text" id="enroll_father_first_name" placeholder="First name"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Middle Name</label>
                  <input type="text" id="enroll_father_middle_name" placeholder="Middle name"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Last Name</label>
                  <input type="text" id="enroll_father_last_name" placeholder="Last name"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Occupation</label>
                  <input type="text" id="enroll_father_occupation" placeholder="Occupation"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Contact Number</label>
                  <input type="tel" id="enroll_father_contact" placeholder="Contact number"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
              </div>

              <div>
                <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Address</label>
                <textarea id="enroll_father_address" placeholder="Complete address"
                  style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; min-height:70px; resize:vertical; box-sizing:border-box;"></textarea>
              </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOTHER'S INFORMATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background:#f9f9f9; border:1px solid #e8e8e8; border-radius:10px; padding:24px; margin-bottom:20px;">
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px; padding-bottom:14px; border-bottom:2px solid #e8e8e8;">
                <div style="width:38px; height:38px; background:linear-gradient(135deg,#165a28,#40916c); border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0;">üë©</div>
                <h3 style="margin:0; font-size:16px; font-weight:700; color:#165a28;">Mother's Information</h3>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">First Name</label>
                  <input type="text" id="enroll_mother_first_name" placeholder="First name"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Middle Name</label>
                  <input type="text" id="enroll_mother_middle_name" placeholder="Middle name"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Last Name</label>
                  <input type="text" id="enroll_mother_last_name" placeholder="Last name"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Occupation</label>
                  <input type="text" id="enroll_mother_occupation" placeholder="Occupation"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Contact Number</label>
                  <input type="tel" id="enroll_mother_contact" placeholder="Contact number"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;">
                </div>
              </div>

              <div>
                <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Address</label>
                <textarea id="enroll_mother_address" placeholder="Complete address"
                  style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; min-height:70px; resize:vertical; box-sizing:border-box;"></textarea>
              </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACADEMIC INFORMATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background:#f9f9f9; border:1px solid #e8e8e8; border-radius:10px; padding:24px; margin-bottom:20px;">
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px; padding-bottom:14px; border-bottom:2px solid #e8e8e8;">
                <div style="width:38px; height:38px; background:linear-gradient(135deg,#165a28,#40916c); border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0;">üéì</div>
                <h3 style="margin:0; font-size:16px; font-weight:700; color:#165a28;">Academic Information</h3>
              </div>

              <!-- Last School + School Year -->
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Last School Attended <span style="color:#dc2626;">*</span></label>
                  <input type="text" id="enroll_last_school" placeholder="Name of previous school"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;"
                    oninput="updateEnrollProgress()" required>
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">School Year <span style="color:#dc2626;">*</span></label>
                  <input type="text" id="enroll_last_school_year" placeholder="e.g., 2023-2024"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; box-sizing:border-box;"
                    oninput="updateEnrollProgress()" required>
                </div>
              </div>

              <!-- Course + Year Level -->
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Course/Program <span style="color:#dc2626;">*</span></label>
                  <select id="enroll_course"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; background:white; cursor:pointer; box-sizing:border-box;"
                    onchange="updateEnrollProgress(); loadEnrollmentSubjects();" required>
                    <option value="">Select a course</option>
                  </select>
                </div>
                <div>
                  <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Year Level <span style="color:#dc2626;">*</span></label>
                  <select id="enroll_year_level"
                    style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; background:white; cursor:pointer; box-sizing:border-box;"
                    onchange="updateEnrollProgress(); loadEnrollmentSubjects();" required>
                    <option value="">Select year level</option>
                    <option value="1">First Year</option>
                    <option value="2">Second Year</option>
                    <option value="3">Third Year</option>
                    <option value="4">Fourth Year</option>
                  </select>
                </div>
              </div>

              <!-- Scholarship Status -->
              <div style="margin-bottom:16px;">
                <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Scholarship Status <span style="color:#dc2626;">*</span></label>
                <select id="enroll_scholarship"
                  style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; background:white; cursor:pointer; box-sizing:border-box;"
                  onchange="updateEnrollProgress()" required>
                  <option value="">Select scholarship status</option>
                  <option value="scholar">Scholar</option>
                  <option value="non-scholar">Non-Scholar</option>
                </select>
                <div style="font-size:12px; color:#888; margin-top:5px;">üí° Select if you are a scholar or non-scholar student.</div>
              </div>

              <!-- Academic Year -->
              <div style="margin-bottom:16px;">
                <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Academic Year <span style="color:#dc2626;">*</span></label>
                <select id="enroll_academic_year"
                  style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; background:white; cursor:pointer; box-sizing:border-box;"
                  onchange="updateEnrollProgress()" required>
                  <option value="">Select academic year</option>
                  <option value="2024-2025">2024-2025</option>
                  <option value="2025-2026">2025-2026</option>
                  <option value="2026-2027">2026-2027</option>
                </select>
              </div>

              <!-- Semester -->
              <div style="margin-bottom:20px;">
                <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Semester <span style="color:#dc2626;">*</span></label>
                <select id="enroll_semester"
                  style="width:100%; padding:10px 12px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; background:white; cursor:pointer; box-sizing:border-box;"
                  onchange="updateEnrollProgress(); loadEnrollmentSubjects();" required>
                  <option value="">Select semester</option>
                  <option value="1st">1st Semester</option>
                  <option value="2nd">2nd Semester</option>
                  <option value="summer">Summer</option>
                </select>
                <div style="font-size:12px; color:#888; margin-top:5px;">üìÖ Subjects below will update based on your selected semester.</div>
              </div>

              <!-- Subjects -->
              <div style="margin-bottom:8px;">
                <label style="display:block; font-size:13px; font-weight:600; color:#333; margin-bottom:6px;">Select Subjects <span style="color:#dc2626;">*</span></label>

                <!-- Prompt (before selections made) -->
                <div id="enroll_subjects_prompt"
                  style="text-align:center; padding:28px 20px; border:2px dashed #ccc; border-radius:8px; color:#999; background:#fafafa; font-size:13px; margin-bottom:8px;">
                  <div style="font-size:28px; margin-bottom:8px;">üìö</div>
                  <div>Please select your <strong>Course</strong>, <strong>Year Level</strong>, and <strong>Semester</strong> first to load available subjects.</div>
                </div>

                <!-- Multi-select (shown after loading) -->
                <select id="enroll_subjects"
                  style="display:none; width:100%; padding:8px; border:1.5px solid #ddd; border-radius:7px; font-size:13px; font-family:inherit; min-height:180px; box-sizing:border-box;"
                  multiple onchange="updateEnrollSelectedSubjects(); updateEnrollProgress();"></select>

                <div style="font-size:12px; color:#888; margin-top:6px;">
                  üí° Click to select/deselect. You can choose multiple subjects.
                </div>
              </div>

              <!-- Selected Subject Tags -->
              <div id="enroll_selected_display"
                style="display:none; background:#e8f5e9; padding:12px 14px; border-radius:8px; margin-top:10px; border:1px solid #a5d6a7;">
                <div style="font-size:13px; font-weight:700; color:#2e7d32; margin-bottom:8px;">
                  ‚úÖ Selected Subjects (<span id="enroll_selected_count">0</span>):
                </div>
                <div id="enroll_selected_list" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
              </div>
            </div>

            <!-- Submit Button ‚Äî matches registration -->
            <button type="submit"
              style="width:100%; padding:14px; background:linear-gradient(135deg,#165a28,#0d3d1a); color:white; border:none; border-radius:8px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; letter-spacing:0.3px; transition:opacity 0.2s;"
              onmouseover="this.style.opacity='0.88'" onmouseout="this.style.opacity='1'">
              Submit Application
            </button>

          </form>
        </div>

        <!-- Enrollment History -->
        <div class="announcements-section">
          <div class="section-header">
            <h2>üìã My Enrollment Applications</h2>
            <button class="view-all-btn" onclick="loadEnrollmentHistory()">üîÑ Refresh</button>
          </div>
          <div id="enrollmentHistoryContainer">
            <div style="text-align:center; padding:40px; color:#999;">Loading...</div>
          </div>
        </div>

      </div>
      <!-- ‚úÖ END ENROLLMENT VIEW -->

    </div><!-- end content-wrapper -->
  </div><!-- end main-content -->
</div><!-- end main-container -->


<!-- University Footer -->
<div class="university-footer">
  <div class="footer-content">
    <div class="footer-section">
      <h3>University of Manila</h3>
      <p>
        <strong>Main Campus:</strong><br>
        Mehan Garden, Ermita, Manila 1000<br>
        Philippines
      </p>
      <p>
        <strong>Phone:</strong> (02) 8241-1234<br>
        <strong>Email:</strong> info@um.edu.ph
      </p>
    </div>
    <div class="footer-section">
      <h3>Quick Links</h3>
      <ul>
        <li><a href="#">University Website</a></li>
        <li><a href="#">Library Portal</a></li>
        <li><a href="#">Email Access</a></li>
        <li><a href="#">Academic Calendar</a></li>
        <li><a href="#">Student Handbook</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>Support</h3>
      <ul>
        <li><a href="#">Help Center</a></li>
        <li><a href="#">Technical Support</a></li>
        <li><a href="#">Registrar's Office</a></li>
        <li><a href="#">Finance Office</a></li>
        <li><a href="#">Student Affairs</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <p>&copy; 2026 University of Manila. All rights reserved. | <a href="#" style="color:#d4af37;">Privacy Policy</a> | <a href="#" style="color:#d4af37;">Terms of Service</a></p>
  </div>
</div>

<!-- Breakdown Modal -->
<div id="breakdownModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>üìö Tuition Fee Breakdown</h2>
    </div>
    <div class="modal-body" id="modalBody">
      <div style="text-align:center; padding:40px;">
        Loading...
      </div>
    </div>
  </div>
</div>

<!-- Document Viewer Modal -->
<div id="documentViewerModal" class="document-viewer-modal" onclick="handleModalClick(event)">
  <div class="document-viewer-content" onclick="event.stopPropagation()">
    <div class="document-viewer-header">
      <h2 id="documentViewerTitle">üìÑ Document Preview</h2>
      <button class="document-viewer-close" onclick="closeDocumentViewer()">&times;</button>
    </div>
    <div class="document-viewer-body">
      <div class="document-image-container" id="documentImageContainer">
        <img id="documentImage" class="document-image" alt="Document Preview" />
      </div>
    </div>
    <div class="document-actions">
      <a id="downloadDocumentBtn" class="download-btn" target="_blank">
        <span>üì•</span> Download Document
      </a>
    </div>
  </div>
</div>

<script>
let allPayments = [];
let scheduleData = [];
let currentView = 'calendar';
let userData = null;
let announcementsData = [];
let currentProfilePicture = null;
let _allGradesData   = null;
let _activeSemFilter = 'all';


// Load user profile
async function loadUserProfile() {
  try {
    console.log("üîç Loading user profile...");
    
    const res = await fetch("/student/payments/me", {
      credentials: "include"
    });

    console.log("üì° Response status:", res.status);

    if (!res.ok) {
      const storedStudentId = localStorage.getItem("student_id");
      
      if (storedStudentId) {
        console.log("‚ö†Ô∏è API failed but found stored student ID:", storedStudentId);
        document.getElementById("profileName").textContent = "Student";
        document.getElementById("headerUserName").textContent = "Student";
        document.getElementById("profileStudentId").textContent = `ID: ${storedStudentId}`;
        document.getElementById("headerUserId").textContent = `ID: ${storedStudentId}`;
        document.getElementById("profileYearLevel").textContent = "Loading...";
      } else {
        console.error("‚ùå No session found - redirecting to login");
        alert("Your session has expired. Please login again.");
        window.location.href = "/login.html";
      }
      return;
    }

    const data = await res.json();
    console.log("‚úÖ Received data:", data);
    
    userData = data;

    if (data.student_name) {
      document.getElementById("profileName").textContent = data.student_name;
      document.getElementById("headerUserName").textContent = data.student_name;
      console.log("‚úÖ Name set:", data.student_name);
    } else {
      console.warn("‚ö†Ô∏è No student_name in response");
      document.getElementById("profileName").textContent = "Student";
      document.getElementById("headerUserName").textContent = "Student";
    }
    
    if (data.student_id) {
      document.getElementById("profileStudentId").textContent = `ID: ${data.student_id}`;
      document.getElementById("headerUserId").textContent = `ID: ${data.student_id}`;
      localStorage.setItem("student_id", data.student_id);
    }
    
    if (data.year_level) {
      document.getElementById("profileYearLevel").textContent = `Year: ${data.year_level}`;
    }

    // ‚¨ÖÔ∏è NEW: Handle profile picture
    if (data.profile_picture && data.profile_picture.trim() !== '') {
      currentProfilePicture = data.profile_picture;
      updateProfilePictureDisplay(`/${data.profile_picture}`);
    } else {
      currentProfilePicture = null;
      updateProfilePictureDisplay(null);
    }

    // ‚¨ÖÔ∏è NEW: Load full profile data for edit forms
    try {
      const profileRes = await fetch("/student/profile", {
        credentials: "include"
      });
      
      if (profileRes.ok) {
        const profileData = await profileRes.json();
        console.log("‚úÖ Full profile data loaded:", profileData);
        // Merge profile data with payment data
        userData = { 
          ...userData, 
          ...profileData,
          email: profileData.email || userData.email,
          contact_number: profileData.contact_number,
          address: profileData.address,
          first_name: profileData.first_name,
          last_name: profileData.last_name
        };
      }
    } catch (profileErr) {
      console.log("‚ö†Ô∏è Could not load full profile data:", profileErr);
    }

  } catch (err) {
    console.error("üí• Error loading profile:", err);
    
    const storedStudentId = localStorage.getItem("student_id");
    if (storedStudentId) {
      document.getElementById("profileName").textContent = "Student";
      document.getElementById("headerUserName").textContent = "Student";
      document.getElementById("profileStudentId").textContent = `ID: ${storedStudentId}`;
      document.getElementById("headerUserId").textContent = `ID: ${storedStudentId}`;
      document.getElementById("profileYearLevel").textContent = "Unable to load";
    } else {
      document.getElementById("profileName").textContent = "Connection Error";
      document.getElementById("headerUserName").textContent = "Connection Error";
      document.getElementById("profileStudentId").textContent = "Please try again";
      document.getElementById("headerUserId").textContent = "Please try again";
    }
  }
}

// Global variable to store current filter
let currentAnnouncementFilter = 'all';

// Toggle dropdown visibility
function toggleAnnouncementFilter(event) {
  event.stopPropagation();
  const menu = document.getElementById('announcementFilterMenu');
  menu.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const container = document.querySelector('.filter-dropdown-container');
  const menu = document.getElementById('announcementFilterMenu');
  
  if (container && !container.contains(event.target)) {
    menu.classList.remove('show');
  }
});

// Filter announcements by source
function filterAnnouncements(source) {
  currentAnnouncementFilter = source;
  
  // Update active state in dropdown
  document.querySelectorAll('.filter-dropdown-item').forEach(item => {
    item.classList.remove('active');
    if (item.getAttribute('data-filter') === source) {
      item.classList.add('active');
    }
  });
  
  // Update button label
  const labels = {
    'all': 'All Announcements',
    'teacher': 'Teacher',
    'registrar': 'Registrar',
    'records': 'Records'
  };
  document.getElementById('currentFilterLabel').textContent = labels[source];
  
  // Close dropdown
  document.getElementById('announcementFilterMenu').classList.remove('show');
  
  // Filter and display
  displayFilteredAnnouncements(source);
}

// Display filtered announcements
function displayFilteredAnnouncements(source) {
  const container = document.getElementById("announcementsContainer");
  
  if (!Array.isArray(announcementsData) || announcementsData.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:40px; color:#999;">
        No announcements available.
      </div>
    `;
    return;
  }
  
  // Filter based on source
  const filtered = source === 'all' 
    ? announcementsData 
    : announcementsData.filter(a => a.source === source);
  
  if (filtered.length === 0) {
    const sourceLabels = {
      'teacher': 'Teacher',
      'registrar': 'Registrar',
      'records': 'Records'
    };
    
    container.innerHTML = `
      <div style="text-align:center; padding:40px; color:#999;">
        <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
        <h3 style="color: #165a28; margin-bottom: 10px;">No ${sourceLabels[source]} Announcements</h3>
        <p>There are currently no announcements from ${sourceLabels[source]}.</p>
      </div>
    `;
    return;
  }
  
  // Display filtered announcements (same code as loadAnnouncements)
  let html = '';
  filtered.forEach((announcement, index) => {
    // Find original index for modal
    const originalIndex = announcementsData.indexOf(announcement);
    
    const formattedDate = announcement.created_at 
      ? new Date(announcement.created_at).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        })
      : 'N/A';
    
    let authorBadge = '';
    let borderColor = '';
    
    if (announcement.source === 'registrar') {
      authorBadge = `<span style="background:#dc3545; color:white; padding:3px 8px; border-radius:10px; font-size:10px; font-weight:700;">üì¢ REGISTRAR</span>`;
      borderColor = 'border-left-color:#dc3545;';
    } else if (announcement.source === 'records') {
      authorBadge = `<span style="background:#17a2b8; color:white; padding:3px 8px; border-radius:10px; font-size:10px; font-weight:700;">üìã RECORDS</span>`;
      borderColor = 'border-left-color:#17a2b8;';
      
      if (announcement.priority) {
        const priorityColors = {
          'urgent': 'background:#dc3545; color:white;',
          'high': 'background:#ffc107; color:#333;',
          'normal': 'background:#28a745; color:white;',
          'low': 'background:#6c757d; color:white;'
        };
        const priorityStyle = priorityColors[announcement.priority] || priorityColors['normal'];
        authorBadge += ` <span style="${priorityStyle} padding:3px 8px; border-radius:10px; font-size:9px; font-weight:700; margin-left:5px;">
          ${announcement.priority.toUpperCase()}
        </span>`;
      }
    } else {
      authorBadge = `<span style="background:#165a28; color:white; padding:3px 8px; border-radius:10px; font-size:10px; font-weight:700;">üë®‚Äçüè´ TEACHER</span>`;
      borderColor = 'border-left-color:#165a28;';
    }
    
    const previewContent = announcement.content && announcement.content.length > 150 
      ? announcement.content.substring(0, 150) + '...' 
      : announcement.content || 'No details available.';
    
    html += `
      <div class="announcement-card" style="${borderColor} cursor: pointer;" onclick="openAnnouncementModal(${originalIndex})">
        <div class="announcement-header">
          <div>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
              <div class="announcement-title">${announcement.title || 'Untitled Announcement'}</div>
              ${authorBadge}
            </div>
            <div class="announcement-meta">
              <span>üìÖ ${formattedDate}</span>
              <span>üìù ${announcement.author || 'University Administration'}</span>
              ${announcement.source === 'teacher' && announcement.subject ? 
                `<span>üìö ${announcement.subject} ${announcement.subject_code ? '(' + announcement.subject_code + ')' : ''}</span>` 
                : ''
              }
              ${announcement.source === 'registrar' && announcement.target_audience ? 
                `<span>üéØ ${formatTargetAudience(announcement.target_audience)}</span>` 
                : ''
              }
              ${announcement.source === 'records' && announcement.target_audience ? 
                `<span>üéØ ${formatRecordsTargetAudience(announcement.target_audience)}</span>` 
                : ''
              }
            </div>
          </div>
        </div>
        <div class="announcement-body">
          ${previewContent}
        </div>
        ${announcement.content && announcement.content.length > 150 ? `
          <div style="margin-top: 8px; color: #165a28; font-weight: 600; font-size: 12px;">
            Click to read more ‚Üí
          </div>
        ` : ''}
      </div>
    `;
  });
  
  container.innerHTML = html;
}
// Load announcements from API
async function loadAnnouncements() {
  const container = document.getElementById("announcementsContainer");
  
  try {
    const res = await fetch("/student/announcements", {
      credentials: "include"
    });

    if (!res.ok) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#999;">
          Unable to load announcements at this time.
        </div>
      `;
      return;
    }

    const data = await res.json();
    
    if (!Array.isArray(data.announcements) || data.announcements.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#999;">
          No announcements available.
        </div>
      `;
      return;
    }

    announcementsData = data.announcements;
    
    // ‚úÖ USE THE NEW FILTER FUNCTION
    displayFilteredAnnouncements(currentAnnouncementFilter);

  } catch (err) {
    console.error("Error loading announcements:", err);
    container.innerHTML = `
      <div style="text-align:center; padding:40px; color:#999;">
        Unable to load announcements at this time.
      </div>
    `;
  }
}

// Open announcement modal
function openAnnouncementModal(index) {
  const announcement = announcementsData[index];
  if (!announcement) return;
  
  const formattedDate = announcement.created_at 
    ? new Date(announcement.created_at).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    : 'N/A';
  
  // Determine header class based on source
  let headerClass = '';
  let sourceIcon = '';
  if (announcement.source === 'registrar') {
    headerClass = 'registrar';
    sourceIcon = 'üì¢';
  } else if (announcement.source === 'records') {
    headerClass = 'records';
    sourceIcon = 'üìã';
  } else {
    sourceIcon = 'üë®‚Äçüè´';
  }
  
  const modalHTML = `
    <div id="announcementModal" class="announcement-modal">
      <div class="announcement-modal-content">
        <div class="announcement-modal-header ${headerClass}">
          <h2 class="announcement-modal-title">${sourceIcon} ${announcement.title || 'Announcement'}</h2>
          <button class="announcement-modal-close" onclick="closeAnnouncementModal()">&times;</button>
        </div>
        
        <div class="announcement-modal-body">
          <div class="announcement-modal-meta">
            <div class="announcement-modal-meta-item">
              <strong>üìÖ Posted:</strong> ${formattedDate}
            </div>
            <div class="announcement-modal-meta-item">
              <strong>üìù By:</strong> ${announcement.author || 'University Administration'}
            </div>
            ${announcement.source === 'teacher' && announcement.subject ? `
              <div class="announcement-modal-meta-item">
                <strong>üìö Subject:</strong> ${announcement.subject} (${announcement.subject_code || 'N/A'})
              </div>
            ` : ''}
            ${announcement.source === 'registrar' && announcement.target_audience ? `
              <div class="announcement-modal-meta-item">
                <strong>üéØ Audience:</strong> ${formatTargetAudience(announcement.target_audience)}
              </div>
            ` : ''}
            ${announcement.source === 'records' && announcement.target_audience ? `
              <div class="announcement-modal-meta-item">
                <strong>üéØ Audience:</strong> ${formatRecordsTargetAudience(announcement.target_audience)}
              </div>
            ` : ''}
            ${announcement.source === 'records' && announcement.priority ? `
              <div class="announcement-modal-meta-item">
                <strong>‚ö†Ô∏è Priority:</strong> <span style="text-transform: uppercase; font-weight: 700;">${announcement.priority}</span>
              </div>
            ` : ''}
          </div>
          
          <div class="announcement-modal-content-text">
            ${announcement.content || 'No content available.'}
          </div>
          
          ${announcement.image_url ? `
            <img src="${announcement.image_url}" alt="Announcement Image" class="announcement-modal-image" />
          ` : ''}
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.getElementById('announcementModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  document.getElementById('announcementModal').style.display = 'block';
}

// Close announcement modal
function closeAnnouncementModal() {
  const modal = document.getElementById('announcementModal');
  if (modal) {
    modal.style.display = 'none';
    setTimeout(() => modal.remove(), 300);
  }
}

// Click outside modal to close
window.addEventListener('click', function(event) {
  const modal = document.getElementById('announcementModal');
  if (event.target === modal) {
    closeAnnouncementModal();
  }
});

// ESC key to close modal
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' || event.key === 'Esc') {
    const modal = document.getElementById('announcementModal');
    if (modal && modal.style.display === 'block') {
      closeAnnouncementModal();
    }
  }
});

// Helper function to format registrar target audience
function formatTargetAudience(audience) {
  const labels = {
    'all': 'All Students',
    'pending': 'Pending Students',
    'approved': 'Approved Students',
    'enrolled': 'Enrolled Students'
  };
  return labels[audience] || audience;
}

// Helper function to format records target audience
function formatRecordsTargetAudience(audience) {
  const labels = {
    'all': 'All Users',
    'students': 'Students Only',
    'teachers': 'Teachers Only'
  };
  return labels[audience] || audience;
}
// Navigation Functions
function showDashboard(event) {
  if (event) event.preventDefault();
  
  document.getElementById("dashboardView").style.display = "block";
  document.getElementById("billingView").style.display = "none";
  document.getElementById("scheduleView").style.display = "none";
  document.getElementById("documentsView").style.display = "none";
  document.getElementById("gradesView").style.display = "none";
  document.getElementById("materialsView").style.display = "none"; // ‚¨ÖÔ∏è ADD THIS
  document.getElementById("enrollmentView").style.display = "none";

  document.getElementById("pageTitle").textContent = "Dashboard";
  document.getElementById("breadcrumbCurrent").textContent = "Dashboard";
  
  updateActiveNav(0);
  loadDashboardStats();
  loadAnnouncements();
}

function showBilling(event) {
  if (event) event.preventDefault();
  
  document.getElementById("dashboardView").style.display = "none";
  document.getElementById("billingView").style.display = "block";
  document.getElementById("scheduleView").style.display = "none";
  document.getElementById("documentsView").style.display = "none";
  document.getElementById("gradesView").style.display = "none";
  document.getElementById("materialsView").style.display = "none"; // ‚¨ÖÔ∏è ADD THIS
  document.getElementById("enrollmentView").style.display = "none";

  document.getElementById("pageTitle").textContent = "Student Billing Statement";
  document.getElementById("breadcrumbCurrent").textContent = "Billing";
  
  updateActiveNav(1);
  getPayments();
}

function showSchedule(event) {
  if (event) event.preventDefault();

  document.getElementById("dashboardView").style.display = "none";
  document.getElementById("billingView").style.display = "none";
  document.getElementById("scheduleView").style.display = "block";
  document.getElementById("documentsView").style.display = "none";
  document.getElementById("gradesView").style.display = "none";
  document.getElementById("materialsView").style.display = "none"; // ‚¨ÖÔ∏è ADD THIS
  document.getElementById("enrollmentView").style.display = "none";

  document.getElementById("pageTitle").textContent = "My Class Schedule";
  document.getElementById("breadcrumbCurrent").textContent = "Schedule";
  
  updateActiveNav(2);
  loadSchedule();
}





function updateActiveNav(index) {
  const links = document.querySelectorAll('.sidebar a');
  links.forEach(link => link.classList.remove('active'));
  if (links[index]) {
    links[index].classList.add('active');
  }
}

// Dashboard Stats
async function loadDashboardStats() {
  try {
    const res = await fetch("/student/payments/me", {
      credentials: "include"
    });

    if (!res.ok) return;

    const data = await res.json();

    if (!userData) {
      userData = data;
      if (data.student_name) {
        document.getElementById("profileName").textContent = data.student_name;
        document.getElementById("headerUserName").textContent = data.student_name;
      }
      if (data.student_id) {
        document.getElementById("profileStudentId").textContent = `ID: ${data.student_id}`;
        document.getElementById("headerUserId").textContent = `ID: ${data.student_id}`;
      }
      if (data.year_level) {
        document.getElementById("profileYearLevel").textContent = `Year: ${data.year_level}`;
      }
    }

    if (Array.isArray(data.payments) && data.payments.length > 0) {
      const payment = data.payments[0];
      
      document.getElementById("statSubjects").textContent = data.subjects?.length || 0;
      document.getElementById("statUnits").textContent = data.total_units || 0;
      document.getElementById("statBalance").textContent = `‚Ç±${(payment.remaining || 0).toLocaleString()}`;
      document.getElementById("statStatus").textContent = (payment.status || 'N/A').toUpperCase();
    }
  } catch (err) {
    console.error("Failed to load dashboard stats:", err);
  }
}

// Schedule Functions
function toggleView(view) {
  currentView = view;
  
  const calendarView = document.getElementById('calendarView');
  const listView = document.getElementById('listView');
  const buttons = document.querySelectorAll('.view-toggle button');
  
  buttons.forEach(btn => btn.classList.remove('active'));
  
  if (view === 'calendar') {
    calendarView.style.display = 'block';
    listView.classList.remove('active');
    buttons[0].classList.add('active');
  } else {
    calendarView.style.display = 'none';
    listView.classList.add('active');
    buttons[1].classList.add('active');
  }
}

async function loadSchedule() {
  try {
    const res = await fetch("/student/schedule", {
      credentials: "include"
    });

    const data = await res.json();

    if (!data.schedule || data.schedule.length === 0) {
      renderEmptySchedule();
      return;
    }

    scheduleData = data.schedule;
    renderCalendarView();
    renderListView();

  } catch (err) {
    renderEmptySchedule();
  }
}

function renderEmptySchedule() {
  const calendarGrid = document.getElementById('calendarGrid');
  const listContent = document.getElementById('scheduleListContent');
  
  const emptyMessage = `
    <div class="empty-schedule">
      <h3>No Schedule Assigned</h3>
      <p>Your class schedule will appear here once it's been finalized by the registrar.</p>
    </div>
  `;
  
  calendarGrid.innerHTML = emptyMessage;
  listContent.innerHTML = emptyMessage;
}

function renderCalendarView() {
  const calendarGrid = document.getElementById('calendarGrid');
  
  const timeSlots = [
    '7:00 AM', '8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM',
    '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM',
    '5:00 PM', '6:00 PM', '7:00 PM'
  ];
  
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  
  function timeToMinutes(timeStr) {
    const [time, period] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    
    if (period === 'PM' && hours !== 12) hours += 12;
    if (period === 'AM' && hours === 12) hours = 0;
    
    return hours * 60 + minutes;
  }
  
  function getSlotRange(slot) {
    const slotMinutes = timeToMinutes(slot);
    return { start: slotMinutes, end: slotMinutes + 60 };
  }
  
  let html = `
    <div class="calendar-day-header" style="background:#f8f9fa;"></div>
    <div class="calendar-day-header">Monday</div>
    <div class="calendar-day-header">Tuesday</div>
    <div class="calendar-day-header">Wednesday</div>
    <div class="calendar-day-header">Thursday</div>
    <div class="calendar-day-header">Friday</div>
    <div class="calendar-day-header">Saturday</div>
  `;
  
  timeSlots.forEach((timeSlot, slotIndex) => {
    html += `<div class="calendar-time-label">${timeSlot}</div>`;
    
    const slotRange = getSlotRange(timeSlot);
    
    days.forEach(day => {
      const classesInSlot = scheduleData.filter(s => {
        if (s.day !== day) return false;
        
        const startTimeStr = s.time.split(' - ')[0];
        const startMinutes = timeToMinutes(startTimeStr);
        
        return startMinutes >= slotRange.start && startMinutes < slotRange.end;
      });
      
      if (classesInSlot.length > 0) {
        const classItem = classesInSlot[0];
        
        html += `
          <div class="calendar-cell">
            <div class="class-block">
              <div class="class-subject">${classItem.subject}</div>
              <div class="class-time">‚è∞ ${classItem.time}</div>
              <div class="class-room">üìç ${classItem.room}</div>
              <div class="class-instructor">üë®‚Äçüè´ ${classItem.instructor}</div>
            </div>
          </div>
        `;
      } else {
        html += `<div class="calendar-cell"></div>`;
      }
    });
  });
  
  calendarGrid.innerHTML = html;
}

function renderListView() {
  const listContent = document.getElementById('scheduleListContent');
  
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  let html = '';
  
  days.forEach(day => {
    const dayClasses = scheduleData.filter(s => s.day === day);
    
    if (dayClasses.length > 0) {
      html += `
        <div class="schedule-day-section">
          <div class="day-section-header">${day}</div>
          <div class="day-classes-list">
      `;
      
      dayClasses.forEach(classItem => {
        html += `
          <div class="class-list-item">
            <div class="class-list-header">
              <div class="class-list-subject">${classItem.subject}</div>
              <div class="class-list-time-badge">${classItem.time}</div>
            </div>
            <div class="class-list-details">
              <div class="class-detail-item">
                <span class="class-detail-icon">üìç</span>
                <span><strong>Room:</strong> ${classItem.room}</span>
              </div>
              <div class="class-detail-item">
                <span class="class-detail-icon">üë®‚Äçüè´</span>
                <span><strong>Instructor:</strong> ${classItem.instructor}</span>
              </div>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    }
  });
  
  if (!html) {
    html = `
      <div class="empty-schedule">
        <h3>No Classes Scheduled</h3>
        <p>You don't have any classes scheduled yet.</p>
      </div>
    `;
  }
  
  listContent.innerHTML = html;
}

// Payment Functions
async function getPayments() {
  const resultDiv = document.getElementById("result");
  const msgDiv = document.getElementById("message");

  resultDiv.innerHTML = "<p>Loading payments...</p>";
  msgDiv.innerHTML = "";

  try {
    const res = await fetch("/student/payments/me", {
      credentials: "include"
    });

    if (!res.ok) throw new Error("Fetch failed");

    const data = await res.json();

    if (!Array.isArray(data.payments) || data.payments.length === 0) {
      resultDiv.innerHTML = "<p>No billing records found.</p>";
      return;
    }

    allPayments = data.payments;  // ‚úÖ Set this FIRST
    
    loadNotifications();  // ‚úÖ Then call this
    
    // ... rest of your code

    let html = "";

    data.payments.forEach(payment => {
      const semester    = payment.semester || "N/A";
      const schoolYear  = payment.school_year || "N/A";
      const totalAmount = payment.total_amount ?? 0;
      const amountPaid  = payment.amount_paid ?? 0;
      const remaining   = payment.remaining ?? 0;
      const statusClass = (payment.status || "").toLowerCase();

      const otherFeesTotal = payment.other_fees
        ? payment.other_fees.reduce((sum, f) => sum + (f.amount ?? 0), 0)
        : 0;

      const progressPercent = totalAmount > 0 ? Math.round((amountPaid / totalAmount) * 100) : 0;

      html += `
        <div class="billing-header-card">
          <h2>üí≥ Billing Statement</h2>
          <div class="billing-semester-info">
            <div class="billing-info-item">
              <span class="billing-info-label">Payment ID</span>
              <span class="billing-info-value">${payment.payment_id}</span>
            </div>
            <div class="billing-info-item">
              <span class="billing-info-label">Semester</span>
              <span class="billing-info-value">${semester}</span>
            </div>
            <div class="billing-info-item">
              <span class="billing-info-label">School Year</span>
              <span class="billing-info-value">${schoolYear}</span>
            </div>
            <div class="billing-info-item">
              <span class="billing-info-label">Year Level</span>
              <span class="billing-info-value">${data.year_level || 'N/A'}</span>
            </div>
            <div class="billing-info-item">
              <span class="billing-info-label">Status</span>
              <span class="status ${statusClass}">${payment.status}</span>
            </div>
          </div>
        </div>

        <div class="billing-content-grid">
          <div class="billing-main-card">
            <h3 class="billing-section-title">üìö Enrolled Subjects</h3>
            <ul class="subjects-list">
              ${
                Array.isArray(data.subjects) && data.subjects.length
                  ? data.subjects.map(s => `
                      <li class="subject-item">
                        <span class="subject-name">${s.subject_name}</span>
                        <span class="subject-units">${s.units || 3} units</span>
                      </li>
                    `).join("")
                  : `<li style="color:#999; padding:15px;">No subjects found</li>`
              }
            </ul>

            <div style="margin-top:30px;">
              <h3 class="billing-section-title">üíµ Other Fees Breakdown</h3>
              <table class="fees-breakdown-table">
                <thead>
                  <tr>
                    <th>Fee Description</th>
                    <th style="text-align:right;">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    payment.other_fees && payment.other_fees.length
                      ? payment.other_fees.map(fee => `
                          <tr>
                            <td>${fee.fee_name}</td>
                            <td class="fee-amount">‚Ç±${fee.amount.toLocaleString()}</td>
                          </tr>
                        `).join("")
                      : `<tr><td colspan="2" style="text-align:center; color:#999;">No other fees</td></tr>`
                  }
                  ${
                    payment.other_fees && payment.other_fees.length
                      ? `<tr style="background:#f8f9fa; font-weight:700;">
                          <td>Total Other Fees</td>
                          <td class="fee-amount" style="color:#165a28;">‚Ç±${otherFeesTotal.toLocaleString()}</td>
                        </tr>`
                      : ''
                  }
                </tbody>
              </table>
            </div>

            ${
              remaining > 0 && payment.status !== 'pending' ? `
                <div style="margin-top:30px;">
                  <h3 class="billing-section-title">üí≥ Make a Payment</h3>
                  
                  <div class="info-box">
                    <strong>üìå Payment Instructions:</strong><br>
                    Select your preferred payment method and enter the amount you wish to pay. 
                    All payments require cashier approval and will be processed within 24-48 hours.
                  </div>

                  <div class="payment-form-enhanced">
                    <div class="form-group">
                      <label class="form-label">Select Payment Method</label>
                      <div class="payment-methods-grid">
                        <div class="payment-method-card" onclick="selectPaymentMethod(${payment.payment_id}, 'cash')">
                          <div class="payment-method-icon">üíµ</div>
                          <div class="payment-method-name">Cash</div>
                        </div>
                        <div class="payment-method-card" onclick="selectPaymentMethod(${payment.payment_id}, 'gcash')">
                          <div class="payment-method-icon">üì±</div>
                          <div class="payment-method-name">GCash</div>
                        </div>
                        <div class="payment-method-card" onclick="selectPaymentMethod(${payment.payment_id}, 'bank')">
                          <div class="payment-method-icon">üè¶</div>
                          <div class="payment-method-name">Bank Transfer</div>
                        </div>
                      </div>
                      <input type="hidden" id="method-${payment.payment_id}" />
                    </div>

                    <div class="form-group">
                      <label class="form-label">Payment Amount</label>
                      <input 
                        type="number"
                        id="amount-${payment.payment_id}"
                        class="form-input"
                        placeholder="Enter amount (max: ‚Ç±${remaining.toLocaleString()})"
                        min="1"
                        max="${remaining}"
                      />
                    </div>

                    <div class="quick-actions">
                      <button class="action-btn primary" onclick="payNow(${payment.payment_id})">
                        <span>üí≥</span> Submit Payment
                      </button>
                      <button class="action-btn secondary" onclick="viewBreakdown(${payment.payment_id})">
                        <span>üìä</span> View Installments
                      </button>
                    </div>
                  </div>
                </div>
              ` : payment.status === 'pending' ? `
                <div class="info-box warning" style="margin-top:30px;">
                  <strong>‚è≥ Payment Pending Approval</strong><br>
                  Your payment has been submitted and is currently being reviewed by the cashier. 
                  You will be notified once it has been approved.
                </div>
                <div class="quick-actions">
                  <button class="action-btn secondary" onclick="viewBreakdown(${payment.payment_id})">
                    <span>üìä</span> View Installments
                  </button>
                </div>
              ` : remaining === 0 ? `
                <div class="info-box success" style="margin-top:30px;">
                  <strong>‚úÖ Account Fully Paid</strong><br>
                  Congratulations! You have successfully completed all payments for this semester.
                </div>
                <div class="quick-actions">
                  <button class="action-btn secondary" onclick="viewBreakdown(${payment.payment_id})">
                    <span>üìä</span> View Payment History
                  </button>
                </div>
              ` : ''
            }
          </div>

          <div class="billing-sidebar-card">
            <h3 class="billing-section-title" style="font-size:20px;">Account Summary</h3>
            
            ${
              data.scholarship_status && data.scholarship_status !== 'None'
                ? `<div style="text-align:center; margin-bottom:20px;">
                    <span class="scholarship-badge">üéì ${data.scholarship_status}</span>
                   </div>`
                : ''
            }

            <div class="financial-summary">
              <div class="summary-item">
                <span class="summary-label">Total Units</span>
                <span class="summary-value">${data.total_units || 0}</span>
              </div>
              
              <div class="summary-item">
                <span class="summary-label">Total Tuition</span>
                <span class="summary-value">‚Ç±${totalAmount.toLocaleString()}</span>
              </div>
              
              <div class="summary-item">
                <span class="summary-label">Amount Paid</span>
                <span class="summary-value" style="color:#28a745;">‚Ç±${amountPaid.toLocaleString()}</span>
              </div>
              
              <div class="summary-item highlight">
                <span class="summary-label" style="font-weight:700; color:#165a28;">Balance Due</span>
                <span class="summary-value large">‚Ç±${remaining.toLocaleString()}</span>
              </div>
            </div>

            <div class="payment-progress">
              <div class="progress-label">
                <span style="font-weight:600; color:#333;">Payment Progress</span>
                <span style="font-weight:700; color:#165a28;">${progressPercent}%</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar-fill" style="width: ${progressPercent}%;">
                  ${progressPercent > 20 ? progressPercent + '%' : ''}
                </div>
              </div>
            </div>

            <div style="margin-top:25px;">
              <button class="action-btn secondary" style="width:100%;" onclick="viewBreakdown(${payment.payment_id})">
                <span>üìä</span> View Full Breakdown
              </button>
            </div>
          </div>
        </div>
      `;
    });

    resultDiv.innerHTML = html;

  } catch (err) {
    console.error(err);
    msgDiv.innerHTML = `
      <div class="info-box warning">
        <strong>‚ö†Ô∏è Error Loading Billing Information</strong><br>
        Unable to retrieve billing data. Please ensure you are logged in and try again.
      </div>
    `;
    resultDiv.innerHTML = "";
  }
}

let selectedMethods = {};

function selectPaymentMethod(paymentId, method) {
  const cards = document.querySelectorAll('.payment-method-card');
  cards.forEach(card => card.classList.remove('selected'));
  
  event.currentTarget.classList.add('selected');
  
  selectedMethods[paymentId] = method;
  document.getElementById(`method-${paymentId}`).value = method;
}

let currentFilter = 'all';
let allNotifications = [];

async function loadNotifications() {
  const badge = document.getElementById("notificationBadge");
  allNotifications = [];
  
  // ===== 1. PAYMENT NOTIFICATIONS =====
  const paymentsWithInstallments = allPayments.filter(p => 
    p.status === 'partial' || p.status === 'pending'
  );
  
  paymentsWithInstallments.forEach(payment => {
    // Use the payment's created_at or updated_at timestamp if available
    const paymentDate = payment.updated_at || payment.created_at || new Date();
    const timeAgo = getTimeAgo(new Date(paymentDate));
    
    if (payment.status === 'pending') {
      allNotifications.push({
        id: `payment-pending-${payment.payment_id}`,
        type: 'payment',
        icon: '‚è≥',
        title: 'Payment Pending Approval',
        message: `Your payment for ${payment.semester} ${payment.school_year} is awaiting cashier approval.`,
        time: timeAgo,
        timestamp: new Date(paymentDate), // ‚úÖ Store actual timestamp for sorting
        read: false,
        badge: 'Payment',
        action: () => handleNotificationClick(payment.payment_id, 'pending')
      });
    } else if (payment.status === 'partial') {
      allNotifications.push({
        id: `payment-installment-${payment.payment_id}`,
        type: 'payment',
        icon: 'üí≥',
        title: 'Installment Payment Available',
        message: `${payment.semester} ${payment.school_year} - Remaining: ‚Ç±${(payment.remaining || 0).toLocaleString()}`,
        time: 'Available now', // ‚úÖ More appropriate for installment reminders
        timestamp: new Date(paymentDate),
        read: false,
        badge: 'Payment',
        action: () => handleNotificationClick(payment.payment_id, 'installment')
      });
    }
  });
  
  // ===== 2. GRADES NOTIFICATIONS =====
  try {
    const gradesRes = await fetch('/student/grades', {
      credentials: 'include'
    });
    
    if (gradesRes.ok) {
      const gradesData = await gradesRes.json();
      
      if (gradesData.grades && gradesData.grades.length > 0) {
        const recentGrades = gradesData.grades.filter(grade => {
          if (!grade.released_at) return false;
          const releaseDate = new Date(grade.released_at);
          const weekAgo = new Date();
          weekAgo.setDate(weekAgo.getDate() - 7);
          return releaseDate > weekAgo;
        });
        
        if (recentGrades.length > 0) {
          // Use the most recent release date
          const mostRecent = recentGrades.reduce((latest, grade) => {
            const gradeDate = new Date(grade.released_at);
            return gradeDate > latest ? gradeDate : latest;
          }, new Date(0));
          
          allNotifications.push({
            id: 'grades-new',
            type: 'academic',
            icon: 'üìä',
            title: 'New Grades Released',
            message: `${recentGrades.length} new grade${recentGrades.length > 1 ? 's' : ''} available to view`,
            time: getTimeAgo(mostRecent),
            timestamp: mostRecent,
            read: false,
            badge: 'Academic',
            action: () => showGrades()
          });
        }
      }
    }
  } catch (err) {
    console.log('Could not check grades:', err);
  }
  
  
 
  
  // ===== 5. LESSON MATERIALS NOTIFICATIONS =====
  try {
    const lessonsRes = await fetch('/student/lessons', {
      credentials: 'include'
    });
    
    if (lessonsRes.ok) {
      const lessonsData = await lessonsRes.json();
      
      if (lessonsData.lessons && lessonsData.lessons.length > 0) {
        const newLessons = lessonsData.lessons.filter(lesson => {
          if (!lesson.uploaded_at) return false;
          const uploadDate = new Date(lesson.uploaded_at);
          const threeDaysAgo = new Date();
          threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
          return uploadDate > threeDaysAgo;
        });
        
        if (newLessons.length > 0) {
          const mostRecent = newLessons.reduce((latest, lesson) => {
            const lessonDate = new Date(lesson.uploaded_at);
            return lessonDate > latest ? lessonDate : latest;
          }, new Date(0));
          
          allNotifications.push({
            id: 'materials-new',
            type: 'academic',
            icon: 'üìö',
            title: 'New Lesson Materials',
            message: `${newLessons.length} new material${newLessons.length > 1 ? 's' : ''} uploaded by your teachers`,
            time: getTimeAgo(mostRecent),
            timestamp: mostRecent,
            read: false,
            badge: 'Academic',
            action: () => showMaterials()
          });
        }
      }
    }
  } catch (err) {
    console.log('Could not check lessons:', err);
  }
  
  // ‚úÖ SORT NOTIFICATIONS BY TIMESTAMP (newest first)
  allNotifications.sort((a, b) => {
    const timeA = a.timestamp || new Date(0);
    const timeB = b.timestamp || new Date(0);
    return timeB - timeA;
  });
  
  // Update badge count
  const unreadCount = allNotifications.filter(n => !n.read).length;
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
  
  // Display notifications
  displayNotifications(allNotifications);
}
function displayNotifications(notifications) {
  const container = document.getElementById('notificationList');
  
  if (!container) {
    console.error('‚ùå notificationList element not found');
    return;
  }
  
  if (!notifications || notifications.length === 0) {
    container.innerHTML = `
      <div class="notification-empty">
        <div style="font-size: 48px; margin-bottom: 15px;">üîî</div>
        <div style="font-weight: 600; margin-bottom: 8px;">No notifications</div>
        <div style="font-size: 12px; color: #999;">You're all caught up!</div>
      </div>
    `;
    return;
  }
  
  let html = '';
  notifications.forEach((notif, index) => {
    const unreadClass = notif.read ? '' : 'unread';
    
    html += `
      <div class="notification-item ${unreadClass}" data-index="${index}">
        <div class="notification-title">${notif.icon} ${notif.title}</div>
        <div class="notification-message">${notif.message}</div>
        <div class="notification-time">${notif.time}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  
  // Add click handlers
  document.querySelectorAll('.notification-item').forEach((item, index) => {
    item.addEventListener('click', () => {
      if (notifications[index].action) {
        notifications[index].action();
        toggleNotifications(); // Close dropdown
      }
    });
  });
}

// Filter notifications
function filterNotifications(type) {
  currentFilter = type;
  
  document.querySelectorAll('.notif-tab').forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');
  
  const filtered = type === 'all' 
    ? allNotifications 
    : allNotifications.filter(n => n.type === type);
  
  displayNotifications(filtered);
}

// Mark all as read
function markAllAsRead() {
  allNotifications.forEach(n => n.read = true);
  displayNotifications(currentFilter === 'all' ? allNotifications : allNotifications.filter(n => n.type === currentFilter));
  
  const badge = document.getElementById("notificationBadge");
  badge.style.display = 'none';
}


// Helper function to get relative time (e.g., "2 hours ago")
function getTimeAgo(date) {
  const now = new Date();
  const diffInSeconds = Math.floor((now - date) / 1000);
  
  if (diffInSeconds < 60) return 'Just now';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
  if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} days ago`;
  if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 604800)} weeks ago`;
  return date.toLocaleDateString();
}
// Enhanced toggle with smooth animation
function toggleNotifications() {
  const dropdown = document.getElementById("notificationDropdown");
  const isShowing = dropdown.classList.contains("show");
  
  if (isShowing) {
    dropdown.classList.remove("show");
  } else {
    dropdown.classList.add("show");
    // Mark notifications as read after opening
    setTimeout(() => {
      const unreadItems = dropdown.querySelectorAll('.notification-item.unread');
      unreadItems.forEach(item => {
        item.classList.remove('unread');
      });
    }, 1000);
  }
}

// Handle notification clicks
function handleNotificationClick(paymentId, type) {
  // Close dropdown
  document.getElementById("notificationDropdown").classList.remove("show");
  
  // Navigate to appropriate action based on type
  if (type === 'pending') {
    // Show a message about pending status
    showPaymentStatusMessage(paymentId);
  } else if (type === 'installment') {
    // Open installment breakdown
    viewBreakdown(paymentId);
  }
}

// Show payment status message
function showPaymentStatusMessage(paymentId) {
  const payment = allPayments.find(p => p.payment_id === paymentId);
  if (!payment) return;
  
  const msgDiv = document.getElementById("message");
  msgDiv.innerHTML = `
    <div class="info-box warning" style="animation: slideIn 0.3s ease;">
      <strong>‚è≥ Payment Pending Approval</strong><br>
      Payment ID: ${paymentId}<br>
      Semester: ${payment.semester || 'N/A'} ${payment.school_year || 'N/A'}<br>
      Amount: ‚Ç±${(payment.amount_paid || 0).toLocaleString()}<br>
      <br>
      Your payment is being reviewed by the cashier. You will be notified once it has been approved.
    </div>
  `;
  
  msgDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    msgDiv.innerHTML = '';
  }, 5000);
}

// Keep the existing click-outside-to-close functionality
window.addEventListener('click', function(event) {
  const container = document.querySelector('.notification-container');
  const dropdown = document.getElementById("notificationDropdown");
  
  if (container && !container.contains(event.target)) {
    dropdown.classList.remove("show");
  }
});

async function viewBreakdownFromNotif(paymentId) {
  document.getElementById("notificationDropdown").classList.remove("show");
  await viewBreakdown(paymentId);
}

async function payNow(paymentId) {
  const amountInput = document.getElementById(`amount-${paymentId}`);
  const methodInput = document.getElementById(`method-${paymentId}`);

  const amount = parseInt(amountInput.value);
  const method = selectedMethods[paymentId] || methodInput.value;

  if (!amount || amount <= 0) {
    alert("‚ö†Ô∏è Please enter a valid amount");
    return;
  }

  if (!method) {
    alert("‚ö†Ô∏è Please select a payment method");
    return;
  }

  if (!confirm(`Confirm payment of ‚Ç±${amount.toLocaleString()} via ${method.toUpperCase()}?`)) return;

  try {
    const res = await fetch("/student/pay", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        payment_id: paymentId,
        amount: amount,
        payment_method: method
      })
    });

    const data = await res.json();

    if (!res.ok) {
      alert("‚ùå " + (data.error || "Payment failed"));
      return;
    }

    const msgDiv = document.getElementById("message");
    msgDiv.innerHTML = `
      <div class="info-box success">
        <strong>‚úÖ Payment Submitted Successfully!</strong><br>
        Your payment of ‚Ç±${amount.toLocaleString()} has been submitted and is pending cashier approval.
        You will be notified once it has been processed.
      </div>
    `;
    
    msgDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    setTimeout(() => {
      getPayments();
    }, 2000);

  } catch (err) {
    console.error(err);
    alert("‚ùå Server error occurred. Please try again.");
  }
}

async function viewBreakdown(paymentId) {
  const modal = document.getElementById("breakdownModal");
  const modalBody = document.getElementById("modalBody");
  
  modal.style.display = "block";
  modalBody.innerHTML = '<div style="text-align:center; padding:40px;">Loading...</div>';

  try {
    const res = await fetch(
      `/student/installments?payment_id=${paymentId}`,
      { credentials: "include" }
    );

    const data = await res.json();

    if (!res.ok) {
      modalBody.innerHTML = `
        <div class="no-installments">
          <p>${data.error || "Failed to load breakdown"}</p>
        </div>`;
      return;
    }

    if (!Array.isArray(data.installments) || data.installments.length === 0) {
      modalBody.innerHTML = `
        <div class="no-installments">
          <h3>No installments yet</h3>
          <p>Installments will be created after the cashier approves your downpayment.</p>
        </div>`;
      return;
    }

    const subjectsText = Array.isArray(data.subjects) && data.subjects.length
      ? data.subjects.map(s => s.subject_name).join(", ")
      : "Subjects not finalized";

    let totalUnitsText = "‚Äî";
    if (data.total_units !== null && data.total_units !== undefined) {
      const units = Number(data.total_units);
      if (!isNaN(units) && units > 0) {
        totalUnitsText = units;
      }
    }

    const totalAmount = Number(data.total_amount || 0);
    const amountPaid  = Number(data.amount_paid || 0);
    const remaining   = Number(data.remaining || 0);

    const termIcons = {
      prelim: "üîµ",
      midterm: "üü¢",
      finals: "üî¥"
    };

    const termLabels = {
      prelim: "Prelim Period",
      midterm: "Midterm Period",
      finals: "Finals Period"
    };

    const termDueDates = {
      prelim: "Due: Before Prelim Exams",
      midterm: "Due: Before Midterm Exams",
      finals: "Due: Before Final Exams"
    };

    let html = `
      <div class="summary-card">
        <div class="summary-row">
          <span class="label">Subjects Enrolled:</span>
          <span class="value" style="font-size:13px; text-align:right;">
            ${subjectsText}
          </span>
        </div>

        <div class="summary-row">
          <span class="label">Total Units:</span>
          <span class="value">${totalUnitsText}</span>
        </div>

        <div class="summary-row">
          <span class="label">Total Tuition Fee:</span>
          <span class="value">‚Ç±${totalAmount.toLocaleString()}</span>
        </div>

        <div class="summary-row">
          <span class="label">Downpayment Paid:</span>
          <span class="value" style="color:#28a745;">
            ‚Ç±${amountPaid.toLocaleString()}
            <span class="downpayment-badge">PAID</span>
          </span>
        </div>

        <div class="summary-row">
          <span class="label">Remaining Balance:</span>
          <span class="value">‚Ç±${remaining.toLocaleString()}</span>
        </div>
      </div>

      <h2 style="color:#165a28; margin-bottom:15px; font-family: 'Crimson Text', serif;">
        Payment Schedule (Installments)
      </h2>
    `;

    data.installments.forEach(inst => {
      const isPaid = inst.status === "paid";
      const installmentAmount = Number(inst.amount);

      html += `
        <div class="installment-card ${isPaid ? "paid" : "pending"}" 
             ${!isPaid ? `onclick="fillPaymentAmount(${paymentId}, ${installmentAmount}, '${inst.term}')" style="cursor: pointer;"` : ''}>
          <div>
            <div class="term-label">
              ${termIcons[inst.term] || "üìå"} ${termLabels[inst.term] || inst.term}
            </div>
            <div style="font-size:12px; color:#666; margin-top:5px;">
              ${termDueDates[inst.term] || ""}
            </div>
            ${!isPaid ? `
              <div style="font-size:11px; color:#165a28; margin-top:3px; font-weight:600;">
                üí° Click to pay this installment
              </div>
            ` : ''}
            ${inst.paid_at ? `
              <div style="font-size:11px; color:#28a745; margin-top:3px;">
                Paid: ${new Date(inst.paid_at).toLocaleDateString()}
              </div>
            ` : ''}
          </div>
          <div style="text-align:right;">
            <div class="term-amount">
              ‚Ç±${installmentAmount.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })}
            </div>
            <span class="status-badge ${isPaid ? "status-paid" : "status-pending"}">
              ${isPaid ? "PAID" : "PENDING"}
            </span>
          </div>
        </div>
      `;
    });

    html += `
      <div class="alert">
        <strong>‚ö†Ô∏è Important Note:</strong><br>
        All installments must be paid before their respective examination periods.
        Failure to pay on time may result in exam permit denial.
      </div>
    `;

    modalBody.innerHTML = html;

  } catch (err) {
    console.error(err);
    modalBody.innerHTML = `
      <div class="no-installments">
        <p>Error loading breakdown</p>
      </div>`;
  }
}

// Fill payment amount when clicking on installment
function fillPaymentAmount(paymentId, amount, term) {
  // Close the breakdown modal
  closeModal();
  
  // Scroll to payment section
  const billingView = document.getElementById('billingView');
  if (billingView) {
    billingView.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  
  // Wait for scroll to complete
  setTimeout(() => {
    // Find and fill the amount input
    const amountInput = document.getElementById(`amount-${paymentId}`);
    if (amountInput) {
      amountInput.value = Math.round(amount);
      amountInput.focus();
      
      // Highlight the input briefly
      amountInput.style.border = '3px solid #28a745';
      amountInput.style.background = '#e8f5e9';
      
      setTimeout(() => {
        amountInput.style.border = '';
        amountInput.style.background = '';
      }, 2000);
      
      // Show confirmation message
      const msgDiv = document.getElementById("message");
      msgDiv.innerHTML = `
        <div class="info-box success" style="animation: slideIn 0.3s ease;">
          <strong>‚úÖ ${term.charAt(0).toUpperCase() + term.slice(1)} Payment Amount Loaded</strong><br>
          Amount: ‚Ç±${Math.round(amount).toLocaleString()}<br>
          <br>
          Please select your payment method and click "Submit Payment" to proceed.
        </div>
      `;
      
      msgDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        msgDiv.innerHTML = '';
      }, 5000);
    } else {
      alert('‚ö†Ô∏è Please ensure you are on the billing page to make a payment.');
    }
  }, 500);
}
function closeModal() {
  document.getElementById("breakdownModal").style.display = "none";
}

window.onclick = function(event) {
  const modal = document.getElementById("breakdownModal");
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

// ==================== DOCUMENT REQUEST FUNCTIONS ====================
let selectedDocument = '';
let copiesCount = 1;

// Navigation function
function showDocuments(event) {
  if (event) event.preventDefault();
  
  document.getElementById("dashboardView").style.display = "none";
  document.getElementById("billingView").style.display = "none";
  document.getElementById("scheduleView").style.display = "none";
  document.getElementById("documentsView").style.display = "block";
  document.getElementById("gradesView").style.display = "none";
  document.getElementById("materialsView").style.display = "none"; // ‚¨ÖÔ∏è ADD THIS
  document.getElementById("enrollmentView").style.display = "none";

  document.getElementById("pageTitle").textContent = "Document Request";
  document.getElementById("breadcrumbCurrent").textContent = "Document Request";
  
  updateActiveNav(4); // Adjust based on position
  loadDocumentRequests();
}
// Purpose options for each document type
const documentPurposes = {
  'Certificate of Enrollment': [
    'Scholarship Application',
    'Student Discount/Privilege',
    'Bank Account Opening',
    'Loan Application',
    'Employment Requirement',
    'Visa Application',
    'Government Transaction',
    'Insurance Purposes',
    'Travel Purposes',
    'Other'
  ],
  'Certificate of Grades': [
    'Scholarship Application',
    'Transfer to Another School',
    'Employment Requirement',
    'Graduate School Application',
    'Internship/OJT Requirement',
    'Board Exam Application',
    'Licensure Examination',
    'Other'
  ],
  'Transcript of Records': [
    'Transfer to Another School',
    'Graduate School Application',
    'Employment Abroad',
    'Employment (Local)',
    'Board Exam Application',
    'Professional License Application',
    'Scholarship Application',
    'Visa Application',
    'Immigration Purposes',
    'Other'
  ],
  'Certificate of Good Moral': [
    'Employment Requirement',
    'Scholarship Application',
    'Transfer to Another School',
    'Visa Application',
    'Government Clearance',
    'Character Reference',
    'Volunteer Work',
    'Organization Membership',
    'Other'
  ],
  'Honorable Dismissal': [
    'Transfer to Another School',
    'Shift to Another Course',
    'Shift to Another Campus',
    'Personal Reasons',
    'Work Abroad',
    'Family Relocation',
    'Financial Constraints',
    'Other'
  ],
  'CAV (Certification, Authentication, Verification)': [
    'Employment Abroad',
    'Immigration',
    'Foreign University Application',
    'Embassy Requirement',
    'Visa Processing',
    'Professional License (Abroad)',
    'Authentication by DFA',
    'Other'
  ]
};

// Document type selection
function selectDocumentType(type) {
  const options = document.querySelectorAll('.document-type-option');
  options.forEach(opt => opt.classList.remove('selected'));
  
  event.currentTarget.classList.add('selected');
  selectedDocument = type;
  document.getElementById('selectedDocumentType').value = type;
  
  // Update purpose dropdown
  updatePurposeDropdown(type);
  
  // Show purpose group
  document.getElementById('purposeGroup').style.display = 'block';
  
  // Hide other purpose by default
  document.getElementById('otherPurposeGroup').style.display = 'none';
  document.getElementById('otherPurposeInput').value = '';
}

// Update purpose dropdown based on document type
function updatePurposeDropdown(documentType) {
  const dropdown = document.getElementById('purposeDropdown');
  const purposes = documentPurposes[documentType] || [];
  
  // Clear existing options
  dropdown.innerHTML = '<option value="">-- Select Purpose --</option>';
  
  // Add new options
  purposes.forEach(purpose => {
    const option = document.createElement('option');
    option.value = purpose;
    option.textContent = purpose;
    dropdown.appendChild(option);
  });
  
  // Reset selection
  dropdown.value = '';
}

// Handle purpose dropdown change
document.addEventListener('DOMContentLoaded', function() {
  const purposeDropdown = document.getElementById('purposeDropdown');
  if (purposeDropdown) {
    purposeDropdown.addEventListener('change', function() {
      const otherPurposeGroup = document.getElementById('otherPurposeGroup');
      const otherPurposeInput = document.getElementById('otherPurposeInput');
      
      if (this.value === 'Other') {
        otherPurposeGroup.style.display = 'block';
        otherPurposeInput.required = true;
      } else {
        otherPurposeGroup.style.display = 'none';
        otherPurposeInput.required = false;
        otherPurposeInput.value = '';
      }
    });
  }
});

// Copies management
function incrementCopies() {
  if (copiesCount < 10) {
    copiesCount++;
    document.getElementById('copiesDisplay').textContent = copiesCount;
  }
}

function decrementCopies() {
  if (copiesCount > 1) {
    copiesCount--;
    document.getElementById('copiesDisplay').textContent = copiesCount;
  }
}

// Reset form
function resetDocumentForm() {
  selectedDocument = '';
  copiesCount = 1;
  document.getElementById('copiesDisplay').textContent = '1';
  document.getElementById('selectedDocumentType').value = '';
  document.getElementById('purposeDropdown').value = '';
  document.getElementById('otherPurposeInput').value = '';
  
  const options = document.querySelectorAll('.document-type-option');
  options.forEach(opt => opt.classList.remove('selected'));
  
  document.getElementById('purposeGroup').style.display = 'none';
  document.getElementById('otherPurposeGroup').style.display = 'none';
}

// Submit request
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('documentRequestForm');
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const documentType = selectedDocument;
      const purposeDropdown = document.getElementById('purposeDropdown').value;
      const otherPurpose = document.getElementById('otherPurposeInput').value.trim();
      const copies = copiesCount;
      
      if (!documentType) {
        alert('‚ö†Ô∏è Please select a document type');
        return;
      }
      
      if (!purposeDropdown) {
        alert('‚ö†Ô∏è Please select the purpose of your request');
        return;
      }
      
      // Determine final purpose
      let finalPurpose = purposeDropdown;
      if (purposeDropdown === 'Other') {
        if (!otherPurpose) {
          alert('‚ö†Ô∏è Please specify your purpose');
          return;
        }
        finalPurpose = `Other: ${otherPurpose}`;
      }
      
      if (!confirm(`Submit request for ${copies} cop${copies > 1 ? 'ies' : 'y'} of ${documentType}?\n\nPurpose: ${finalPurpose}`)) {
        return;
      }
      
      try {
        const res = await fetch('/student/documents/request', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            document_type: documentType,
            purpose: finalPurpose,
            copies: copies
          })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          alert('‚ùå ' + (data.error || 'Request failed'));
          return;
        }
        
        alert('‚úÖ Document request submitted successfully!\n\nRequest ID: ' + data.request_id + '\nStatus: Pending Review');
        
        resetDocumentForm();
        loadDocumentRequests();
        
      } catch (err) {
        console.error(err);
        alert('‚ùå Server error occurred. Please try again.');
      }
    });
  }
});

function viewDocument(documentUrl, documentType) {
  console.log('üìÑ viewDocument called:', documentUrl, documentType);
  
  // Create modal if it doesn't exist
  let modal = document.getElementById('documentViewerModal');
  
  if (!modal) {
    console.log('üî® Creating modal...');
    const modalHTML = `
      <div id="documentViewerModal" class="document-viewer-modal" onclick="handleModalClick(event)">
        <div class="document-viewer-content" onclick="event.stopPropagation()">
          <div class="document-viewer-header">
            <h2 id="documentViewerTitle">üìÑ Document Preview</h2>
            <button class="document-viewer-close" onclick="closeDocumentViewer()">&times;</button>
          </div>
          <div class="document-viewer-body">
            <div class="document-image-container" id="documentImageContainer">
              <!-- Content will be loaded here -->
            </div>
          </div>
          <div class="document-actions">
            <a id="downloadDocumentBtn" class="download-btn" target="_blank">
              <span>üì•</span> Download Document
            </a>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    modal = document.getElementById('documentViewerModal');
    console.log('‚úÖ Modal created');
  }
  
  // Update modal content
  console.log('üìù Updating modal content...');
  document.getElementById('documentViewerTitle').textContent = `üìÑ ${documentType}`;
  
  const container = document.getElementById('documentImageContainer');
  
  // Check if it's a PDF
  if (documentUrl.toLowerCase().endsWith('.pdf')) {
  console.log('üìï Loading PDF...');
  container.innerHTML = `
    <embed 
      src="${documentUrl}#toolbar=0&navpanes=0&scrollbar=0" 
      type="application/pdf" 
      width="100%" 
      height="100%"
      style="border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-radius: 8px;"
    />
    <div style="text-align: center; margin-top: 15px; color: #666; font-size: 13px;">
      üí° Can't see the PDF? <a href="${documentUrl}" target="_blank" style="color: #165a28; font-weight: 600;">Open in new tab</a>
    </div>
  `;
  } else {
    // It's an image
    console.log('üñºÔ∏è Loading image...');
    container.innerHTML = `<img id="documentImage" class="document-image" alt="Document Preview" />`;
    
    const imgElement = document.getElementById('documentImage');
    imgElement.src = documentUrl;
    imgElement.onerror = function() {
      console.error('‚ùå Failed to load image:', documentUrl);
      container.innerHTML = `
        <div style="text-align: center; padding: 60px; color: #999;">
          <div style="font-size: 64px; margin-bottom: 15px;">‚ùå</div>
          <h3 style="color: #dc3545; margin-bottom: 10px;">Failed to Load Document</h3>
          <p>The document file could not be loaded.</p>
          <p style="margin-top: 15px;">
            <a href="${documentUrl}" target="_blank" style="color: #165a28; font-weight: 600;">
              Try opening directly
            </a>
          </p>
        </div>
      `;
    };
    imgElement.onload = function() {
      console.log('‚úÖ Image loaded successfully');
    };
  }
  
  const downloadBtn = document.getElementById('downloadDocumentBtn');
  downloadBtn.href = documentUrl;
  downloadBtn.download = `${documentType.replace(/\s+/g, '_')}.pdf`;
  
  // Show modal
  modal.style.display = 'block';
  console.log('‚úÖ Modal displayed');
}

// Function to close document viewer
function closeDocumentViewer() {
  console.log('‚ùå Closing modal...');
  const modal = document.getElementById('documentViewerModal');
  if (modal) {
    modal.style.display = 'none';
    console.log('‚úÖ Modal closed');
  }
}

// Handle modal background click
function handleModalClick(event) {
  if (event.target.id === 'documentViewerModal') {
    closeDocumentViewer();
  }
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
  const modal = document.getElementById('documentViewerModal');
  if (event.target === modal) {
    closeDocumentViewer();
  }
});
// Load document requests
async function loadDocumentRequests() {
  console.log('üìã Loading document requests...');
  const container = document.getElementById('requestsContainer');
  
  try {
    const res = await fetch('/student/documents/requests', {
      credentials: 'include'
    });
    
    console.log('Response status:', res.status);
    
    if (!res.ok) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#999;">
          Unable to load requests at this time.
        </div>
      `;
      return;
    }
    
    const data = await res.json();
    console.log('üì¶ Received data:', data);
    
    if (!Array.isArray(data.requests) || data.requests.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#999;">
          No document requests found.<br>
          Submit your first request above!
        </div>
      `;
      return;
    }
    
    let html = '';
    
    data.requests.forEach(req => {
      const statusClass = 'request-status-badge status-' + req.status;
      const statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
      
      // Check if document is available
      const hasDocument = req.document_path && req.document_path.trim() !== '';
      const documentUrl = hasDocument ? `/${req.document_path}` : '';
      
      // Determine file type
      const isPDF = documentUrl.toLowerCase().endsWith('.pdf');
      const viewButtonText = isPDF ? 'View PDF' : 'View Document';
      const downloadFileName = req.document_type.replace(/\s+/g, '_') + (isPDF ? '.pdf' : '');
      
      console.log(`Request #${req.request_id}:`, {
        status: req.status,
        hasDocument,
        documentPath: req.document_path,
        documentUrl,
        isPDF
      });
      
      html += `
        <div class="request-item">
          <div class="request-item-header">
            <div>
              <div class="request-item-title">${req.document_type}</div>
              <div class="request-item-meta">
                <span>üÜî Request #${req.request_id}</span>
                <span>üìÖ ${new Date(req.requested_at).toLocaleDateString()}</span>
                <span>üìã ${req.copies} cop${req.copies > 1 ? 'ies' : 'y'}</span>
              </div>
            </div>
            <span class="${statusClass}">${statusText}</span>
          </div>
          <div class="request-item-details">
            <strong>Purpose:</strong> ${req.purpose}
            ${req.notes ? '<br><strong>Notes from Records:</strong> ' + req.notes : ''}
            ${req.processed_at ? '<br><strong>Processed:</strong> ' + new Date(req.processed_at).toLocaleString() : ''}
            ${hasDocument ? `
              <br><br>
              <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 4px solid #28a745; margin-top: 10px;">
                <div style="color: #2e7d32; font-weight: 600; margin-bottom: 8px;">
                  ‚úÖ Your ${isPDF ? 'PDF document' : 'document'} is ready!
                </div>
                <button 
                  type="button"
                  class="action-btn primary" 
                  style="padding: 10px 18px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; margin-right: 10px;"
                  onclick="event.preventDefault(); event.stopPropagation(); viewDocument('${documentUrl}', '${req.document_type.replace(/'/g, "\\'")}'); return false;"
                >
                  <span>${isPDF ? 'üìï' : 'üëÅÔ∏è'}</span> ${viewButtonText}
                </button>
                <a 
                  href="${documentUrl}" 
                  target="_blank"
                  download="${downloadFileName}"
                  class="action-btn secondary" 
                  style="padding: 10px 18px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; text-decoration: none;"
                >
                  <span>üì•</span> Download ${isPDF ? 'PDF' : 'File'}
                </a>
                ${isPDF ? `
                  <a 
                    href="${documentUrl}" 
                    target="_blank"
                    class="action-btn secondary" 
                    style="padding: 10px 18px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; margin-top: 8px;"
                  >
                    <span>üîó</span> Open in New Tab
                  </a>
                ` : ''}
              </div>
            ` : req.status === 'approved' ? `
              <br><br>
              <div style="background: #fff3e0; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 10px;">
                <div style="color: #e65100; font-weight: 600;">
                  ‚è≥ Document approved - Generating...
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
    console.log('‚úÖ Requests rendered:', data.requests.length);
    
  } catch (err) {
    console.error('‚ùå Error loading document requests:', err);
    container.innerHTML = `
      <div style="text-align:center; padding:40px; color:#999;">
        Unable to load requests at this time.
      </div>
    `;
  }
}

// ==================== KEYBOARD SUPPORT ====================
// Add ESC key to close modal
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' || event.key === 'Esc') {
    const modal = document.getElementById('documentViewerModal');
    if (modal && modal.style.display === 'block') {
      closeDocumentViewer();
    }
  }
});
// === PATCH: apply this fix to your student portal HTML ===
// Find the showGrades function and replace it with this:

function showGrades(event) {
  if (event) event.preventDefault();
  
  document.getElementById("dashboardView").style.display = "none";
  document.getElementById("billingView").style.display = "none";
  document.getElementById("scheduleView").style.display = "none";
  document.getElementById("documentsView").style.display = "none";
  document.getElementById("gradesView").style.display = "block";
  document.getElementById("materialsView").style.display = "none";
  document.getElementById("enrollmentView").style.display = "none"; // ‚Üê THIS LINE FIXES THE BUG
  
  document.getElementById("pageTitle").textContent = "My Grades";
  document.getElementById("breadcrumbCurrent").textContent = "Grades";
  
  updateActiveNav(5);
  loadStudentGrades();
}

// Load student grades
async function loadStudentGrades() {
  const resultDiv = document.getElementById("gradesResult");
  const messageDiv = document.getElementById("gradesMessage");
  
  resultDiv.innerHTML = '<div style="text-align:center; padding:60px; color:#999;">Loading your grades...</div>';
  messageDiv.innerHTML = '';
  
  try {
    const res = await fetch('/student/grades', {
      credentials: 'include'
    });
    
    if (!res.ok) {
      throw new Error('Failed to fetch grades');
    }
    
    const data = await res.json();
    
    console.log('üìä Grades data:', data);
    
    // Display grades
    displayGrades(data);
    
  } catch (err) {
    console.error('Error loading grades:', err);
    resultDiv.innerHTML = `
      <div class="info-box warning">
        <strong>‚ö†Ô∏è Unable to Load Grades</strong><br>
        There was an error loading your grades. Please try again later or contact support if the problem persists.
      </div>
    `;
  }
}
function displayGrades(data) {
  _allGradesData = data;
  _activeSemFilter = 'all';
  const resultDiv = document.getElementById("gradesResult");

  if (!data.grades || data.grades.length === 0) {
    resultDiv.innerHTML = `
      <div class="grades-container">
        <div class="no-grades-message">
          <h3>üìã No Grades Available Yet</h3>
          <p>Your grades will appear here once they have been released by the Records Office.</p>
        </div>
      </div>`;
    return;
  }

  const student     = data.student || {};
  const grades      = data.grades  || [];
  const gwa         = recalcGWA(grades);
  const semKeys     = buildSemesterKeys(grades);

  function gwaLabel(g) {
    if (g === null) return '';
    const v = parseFloat(g);
    if (v <= 1.50) return 'üèÜ Excellent';
    if (v <= 2.00) return '‚≠ê Very Good';
    if (v <= 2.50) return 'üëç Good';
    if (v <= 3.00) return '‚úÖ Satisfactory (Passing)';
    if (v <= 4.00) return '‚ö†Ô∏è Conditional';
    return '‚ùå Failed';
  }

  // Filter buttons
  let filterHtml = `<div class="semester-filter-bar">
    <span style="font-size:12px;font-weight:700;color:#666;margin-right:4px;">Filter:</span>
    <button class="sem-filter-btn active" onclick="filterGradesBySemester('all', this)">All</button>`;
  semKeys.forEach(k => {
    const { sem, sy } = parseSemKey(k);
    filterHtml += `<button class="sem-filter-btn" onclick="filterGradesBySemester('${k}', this)">${sem} ‚Äî ${sy}</button>`;
  });
  filterHtml += '</div>';

  let html = `
    <div class="grades-header-card">
      <h2>üìä Academic Performance Report</h2>
      <div class="grades-student-info">
        <div class="grades-info-item"><span class="grades-info-label">Student Name</span><span class="grades-info-value">${student.name||'N/A'}</span></div>
        <div class="grades-info-item"><span class="grades-info-label">Student ID</span><span class="grades-info-value">${student.student_id||'N/A'}</span></div>
        <div class="grades-info-item"><span class="grades-info-label">Course</span><span class="grades-info-value">${student.course||'N/A'} (${student.course_code||'N/A'})</span></div>
        <div class="grades-info-item"><span class="grades-info-label">Year Level</span><span class="grades-info-value">Year ${student.year_level||'N/A'}</span></div>
      </div>
    </div>

    ${gwa !== null ? `
    <div class="gpa-card">
      <div class="gpa-label">Overall General Weighted Average (GWA)</div>
      <div class="gpa-value">${gwa}</div>
      <div class="gpa-total">${gwaLabel(gwa)} &nbsp;¬∑&nbsp; Based on ${grades.length} subject${grades.length!==1?'s':''}</div>
    </div>` : ''}

    <div class="grades-container">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="font-family:'Crimson Text',serif;font-size:22px;color:#165a28;margin:0;">üìö Released Grades</h3>
        <button class="download-grades-btn" onclick="downloadGradesReport()"><span>üì•</span> Download Report</button>
      </div>
      ${filterHtml}
      <div id="semesterGroupsContainer">${buildGroupedGradesHTML(grades, 'all')}</div>
    </div>`;

  resultDiv.innerHTML = html;
}

function filterGradesBySemester(semKey, btn) {
  _activeSemFilter = semKey;
  document.querySelectorAll('.sem-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('semesterGroupsContainer').innerHTML =
    buildGroupedGradesHTML(_allGradesData.grades, semKey);
}

function buildSemesterKeys(grades) {
  const seen = new Set();
  grades.forEach(g => {
    const k = `${g.semester||'N/A'}|||${g.school_year||'N/A'}`;
    seen.add(k);
  });
  return Array.from(seen);
}

function parseSemKey(key) {
  const [sem, sy] = key.split('|||');
  return { sem, sy };
}

function buildGroupedGradesHTML(grades, semKey) {
  // Filter by selected semester
  const filtered = semKey === 'all'
    ? grades
    : grades.filter(g => `${g.semester||'N/A'}|||${g.school_year||'N/A'}` === semKey);

  // Group by semester key
  const groups = {};
  filtered.forEach(g => {
    const k = `${g.semester||'N/A'}|||${g.school_year||'N/A'}`;
    if (!groups[k]) groups[k] = [];
    groups[k].push(g);
  });

  if (Object.keys(groups).length === 0) {
    return '<div style="text-align:center;padding:40px;color:#999;">No grades found.</div>';
  }

  let html = '';
  Object.entries(groups).forEach(([key, gradeList]) => {
    const { sem, sy } = parseSemKey(key);
    const semGwa = recalcGWA(gradeList);

    html += `
      <div class="semester-group">
        <div class="semester-group-header">
          <span class="semester-group-title">üìÖ ${sem} Semester ‚Äî A.Y. ${sy}</span>
          ${semGwa !== null ? `<span class="semester-gwa-badge">Semester GWA: ${semGwa}</span>` : ''}
        </div>
        <div class="grades-table-container" style="border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px;">
          <table class="grades-table">
            <thead>
              <tr>
                <th>Subject Code</th>
                <th>Subject Name</th>
                <th>Professor</th>
                <th>Prelim</th>
                <th>Midterm</th>
                <th>Finals</th>
                <th>GWA</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${gradeList.map(g => buildGradeRow(g)).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
  });

  return html;
}

function buildGradeRow(grade) {
  const fmt = v => (v !== null && v !== undefined) ? parseFloat(v).toFixed(2) : '--';
  const prelim  = fmt(grade.prelim);
  const midterm = fmt(grade.midterm);
  const finals  = fmt(grade.finals);
  const average = fmt(grade.average);
  const badgeClass  = getGradeClass(grade.average);
  const statusBadge = getGradeLabel(grade.average);

  return `
    <tr>
      <td><strong>${grade.subject_code}</strong></td>
      <td>${grade.subject}</td>
      <td style="font-size:12px;">üë®‚Äçüè´ ${grade.teacher_name||'N/A'}</td>
      <td class="grade-value">${prelim}</td>
      <td class="grade-value">${midterm}</td>
      <td class="grade-value">${finals}</td>
      <td><span class="grade-badge ${badgeClass}">${average}</span></td>
      <td>${statusBadge}</td>
    </tr>`;
}


function getGradeClass(average) {
  if (average === null || average === undefined) return 'grade-incomplete';
  const g = parseFloat(average);
  if (isNaN(g))   return 'grade-incomplete';
  if (g <= 1.50)  return 'grade-excellent';  // 1.0 = Excellent
  if (g <= 2.50)  return 'grade-good';        // 1.25‚Äì2.50 = Very Good / Good
  if (g <= 3.00)  return 'grade-fair';        // 2.75‚Äì3.0  = Satisfactory (PASSING)
  return 'grade-poor';                         // 4.0 / 5.0 = Conditional / Failed
}

function getGradeLabel(average) {
  if (average === null || average === undefined)
    return '<span style="color:#999;">Incomplete</span>';
  const g = parseFloat(average);
  if (isNaN(g))
    return '<span style="color:#999;">Incomplete</span>';
  if (g <= 3.0)
    return '<span style="background:#28a745;color:white;padding:4px 12px;border-radius:12px;font-weight:700;font-size:12px;">PASSED</span>';
  return '<span style="background:#dc3545;color:white;padding:4px 12px;border-radius:12px;font-weight:700;font-size:12px;">FAILED</span>';
}

function recalcGWA(grades) {
  const valid = grades.filter(g => g.average !== null && g.average !== undefined);
  if (valid.length === 0) return null;
  const sum = valid.reduce((acc, g) => acc + parseFloat(g.average), 0);
  return (sum / valid.length).toFixed(2);
}

async function downloadGradesReport() {
  try {
    const res = await fetch('/student/grades', {
      credentials: 'include'
    });
    
    if (!res.ok) {
      alert('‚ùå Failed to fetch grades data');
      return;
    }
    
    const data = await res.json();
    
    if (!data.grades || data.grades.length === 0) {
      alert('‚ùå No grades available to download');
      return;
    }
    
    // ‚úÖ Filter grades based on active semester filter
    let gradesToPrint = data.grades;
    let filterLabel   = 'All Semesters';

    if (_activeSemFilter && _activeSemFilter !== 'all') {
      gradesToPrint = data.grades.filter(g =>
        `${g.semester||'N/A'}|||${g.school_year||'N/A'}` === _activeSemFilter
      );
      const { sem, sy } = parseSemKey(_activeSemFilter);
      filterLabel = `${sem} Semester ‚Äî A.Y. ${sy}`;
    }

    if (gradesToPrint.length === 0) {
      alert('‚ùå No grades found for the selected semester');
      return;
    }

    // Pass filtered data
    const filteredData = { ...data, grades: gradesToPrint };
    generatePDFReport(filteredData, filterLabel);
    
  } catch (err) {
    console.error('Error downloading report:', err);
    alert('‚ùå Failed to generate report card');
  }
}
async function generatePDFReport(gradesData) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');

  const student = gradesData.student || {};
  const grades  = gradesData.grades  || [];
  const gwa     = recalcGWA(grades);

  function gwaDesc(g) {
    if (g === null) return 'N/A';
    const v = parseFloat(g);
    if (v <= 1.50) return 'Excellent';
    if (v <= 2.00) return 'Very Good';
    if (v <= 2.50) return 'Good';
    if (v <= 3.00) return 'Satisfactory';
    if (v <= 4.00) return 'Conditional';
    return 'Failed';
  }

  // Group grades by semester
  const groups = {};
  grades.forEach(g => {
    const k = `${g.semester||'N/A'}|||${g.school_year||'N/A'}`;
    if (!groups[k]) groups[k] = [];
    groups[k].push(g);
  });

  let yPos = 20;

  // ‚îÄ‚îÄ University header ‚îÄ‚îÄ
  pdf.setFontSize(20);
  pdf.setFont(undefined, 'bold');
  pdf.setTextColor(22, 90, 40);
  pdf.text('THE UNIVERSITY OF MANILA', 105, yPos, { align: 'center' });

  yPos += 6;
  pdf.setFontSize(8);
  pdf.setFont(undefined, 'normal');
  pdf.setTextColor(100, 100, 100);
  pdf.text('Mehan Garden, Ermita, Manila 1000, Philippines', 105, yPos, { align: 'center' });

  yPos += 4;
  pdf.text('Tel: (02) 8241-1234  |  Email: registrar@um.edu.ph', 105, yPos, { align: 'center' });

  yPos += 8;
  pdf.setFontSize(14);
  pdf.setFont(undefined, 'bold');
  pdf.setTextColor(22, 90, 40);
  pdf.text('OFFICIAL REPORT CARD', 105, yPos, { align: 'center' });

  yPos += 3;
  pdf.setDrawColor(22, 90, 40);
  pdf.setLineWidth(0.5);
  pdf.line(20, yPos, 190, yPos);

  yPos += 8;

  // ‚îÄ‚îÄ Student info box ‚îÄ‚îÄ
  pdf.setFillColor(248, 249, 250);
  pdf.setDrawColor(22, 90, 40);
  pdf.rect(20, yPos, 170, 35, 'FD');

  yPos += 6;
  pdf.setFontSize(9);
  pdf.setTextColor(0, 0, 0);

  const infoRows = [
    ['Student Name:',   student.name        || 'N/A'],
    ['Student ID:',     student.student_id  || 'N/A'],
    ['Course:',         `${student.course || 'N/A'} (${student.course_code || 'N/A'})`],
    ['Year Level:',     `Year ${student.year_level || 'N/A'}`],
    ['Date Generated:', new Date().toLocaleDateString('en-US')],
  ];

  infoRows.forEach(([label, value]) => {
    pdf.setFont(undefined, 'bold');
    pdf.text(label, 25, yPos);
    pdf.setFont(undefined, 'normal');
    pdf.text(String(value), 140, yPos, { align: 'right' });
    yPos += 5;
  });

  yPos += 5;

  // ‚îÄ‚îÄ Overall GWA box ‚îÄ‚îÄ
  if (gwa !== null) {
    pdf.setFillColor(212, 175, 55);
    pdf.setDrawColor(180, 140, 20);
    pdf.rect(20, yPos, 170, 14, 'FD');

    pdf.setFontSize(10);
    pdf.setFont(undefined, 'bold');
    pdf.setTextColor(50, 30, 0);
    pdf.text('Overall General Weighted Average (GWA):', 25, yPos + 5);
    pdf.setFontSize(12);
    pdf.text(`${gwa}  ‚Äî  ${gwaDesc(gwa)}`, 188, yPos + 5, { align: 'right' });

    pdf.setFontSize(7.5);
    pdf.setFont(undefined, 'normal');
    pdf.text('Scale: 1.0 = Excellent  |  3.0 = Passing threshold  |  5.0 = Failed', 105, yPos + 11, { align: 'center' });

    yPos += 20;
  }

  // ‚îÄ‚îÄ Per-semester sections ‚îÄ‚îÄ
  Object.entries(groups).forEach(([key, gradeList], groupIndex) => {
    const [sem, sy] = key.split('|||');
    const semGwa    = recalcGWA(gradeList);

    // Check if we need a new page (leave room for header + at least 2 rows)
    if (yPos > 220) {
      pdf.addPage();
      yPos = 20;
    }

    // Semester header bar (green)
    pdf.setFillColor(22, 90, 40);
    pdf.setDrawColor(13, 61, 26);
    pdf.rect(20, yPos, 170, 10, 'FD');

    pdf.setFontSize(10);
    pdf.setFont(undefined, 'bold');
    pdf.setTextColor(255, 255, 255);
    pdf.text(`${sem} Semester  ‚Äî  A.Y. ${sy}`, 25, yPos + 7);

    if (semGwa !== null) {
      pdf.setFontSize(9);
      pdf.text(`Semester GWA: ${semGwa}  (${gwaDesc(semGwa)})`, 188, yPos + 7, { align: 'right' });
    }

    yPos += 10;

    // Column header row
    pdf.setFillColor(230, 244, 234);
    pdf.setDrawColor(200, 220, 200);
    pdf.rect(20, yPos, 170, 7, 'FD');

    pdf.setFontSize(7.5);
    pdf.setFont(undefined, 'bold');
    pdf.setTextColor(22, 90, 40);
    pdf.text('Subject Code', 22,  yPos + 5);
    pdf.text('Subject Name', 50,  yPos + 5);
    pdf.text('Professor',    98,  yPos + 5);
    pdf.text('Pre',          131, yPos + 5);
    pdf.text('Mid',          142, yPos + 5);
    pdf.text('Fin',          153, yPos + 5);
    pdf.text('GWA',          163, yPos + 5);
    pdf.text('Result',       176, yPos + 5);

    yPos += 7;

    // Grade rows
    gradeList.forEach((grade, index) => {
      // New page if needed
      if (yPos > 270) {
        pdf.addPage();
        yPos = 20;
      }

      const fmt = v => (v !== null && v !== undefined) ? parseFloat(v).toFixed(2) : '--';
      const prelim  = fmt(grade.prelim);
      const midterm = fmt(grade.midterm);
      const finals  = fmt(grade.finals);
      const average = fmt(grade.average);
      const remarks = average !== '--'
        ? (parseFloat(average) <= 3.0 ? 'PASSED' : 'FAILED')
        : 'INC';

      if (index % 2 === 0) {
        pdf.setFillColor(248, 249, 250);
        pdf.rect(20, yPos, 170, 6, 'F');
      }

      pdf.setFontSize(7);
      pdf.setFont(undefined, 'bold');
      pdf.setTextColor(0, 0, 0);
      pdf.text(grade.subject_code || '', 22, yPos + 4);

      pdf.setFont(undefined, 'normal');
      const subName = (grade.subject || '').length > 24
        ? grade.subject.substring(0, 24) + '‚Ä¶'
        : (grade.subject || '');
      pdf.text(subName, 50, yPos + 4);

      const profName = (grade.teacher_name || 'N/A').length > 18
        ? grade.teacher_name.substring(0, 18) + '‚Ä¶'
        : (grade.teacher_name || 'N/A');
      pdf.text(profName, 98, yPos + 4);

      pdf.setFont(undefined, 'bold');
      pdf.setTextColor(22, 90, 40);
      pdf.text(prelim,  134, yPos + 4, { align: 'center' });
      pdf.text(midterm, 145, yPos + 4, { align: 'center' });
      pdf.text(finals,  156, yPos + 4, { align: 'center' });
      pdf.text(average, 166, yPos + 4, { align: 'center' });

      if (remarks === 'PASSED')      pdf.setTextColor(34, 139, 34);
      else if (remarks === 'FAILED') pdf.setTextColor(180, 0, 0);
      else                           pdf.setTextColor(100, 100, 100);
      pdf.text(remarks, 182, yPos + 4, { align: 'center' });
      pdf.setTextColor(0, 0, 0);

      pdf.setDrawColor(220, 220, 220);
      pdf.setLineWidth(0.1);
      pdf.line(20, yPos + 6, 190, yPos + 6);

      yPos += 6;
    });

    // Semester GWA summary row
    if (semGwa !== null) {
      pdf.setFillColor(232, 245, 233);
      pdf.rect(20, yPos, 170, 6, 'F');
      pdf.setFontSize(7.5);
      pdf.setFont(undefined, 'bold');
      pdf.setTextColor(22, 90, 40);
      pdf.text(`Semester GWA: ${semGwa}  (${gwaDesc(semGwa)})`, 188, yPos + 4, { align: 'right' });
      yPos += 6;
    }

    yPos += 6; // spacing between groups
  });

  // New page if too close to bottom for legend + signatures
  if (yPos > 220) {
    pdf.addPage();
    yPos = 20;
  }

  // ‚îÄ‚îÄ Grading scale legend ‚îÄ‚îÄ
  pdf.setFillColor(248, 249, 250);
  pdf.setDrawColor(220, 220, 220);
  pdf.rect(20, yPos, 170, 24, 'FD');

  yPos += 5;
  pdf.setFontSize(8);
  pdf.setFont(undefined, 'bold');
  pdf.setTextColor(22, 90, 40);
  pdf.text('Filipino GWA Grading System:', 25, yPos);

  yPos += 5;
  pdf.setFontSize(7.5);
  pdf.setFont(undefined, 'normal');
  pdf.setTextColor(0, 0, 0);
  pdf.text('1.0 = Excellent    1.25 = Very Good    1.5 = Very Good    1.75 = Very Good', 25, yPos);

  yPos += 4;
  pdf.text('2.0 = Good    2.25 = Good    2.5 = Good    2.75 = Satisfactory    3.0 = Satisfactory', 25, yPos);

  yPos += 4;
  pdf.setFont(undefined, 'bold');
  pdf.setTextColor(180, 0, 0);
  pdf.text('4.0 = Conditional  |  5.0 = Failed  |  Passing threshold: 3.0 and below', 25, yPos);
  pdf.setTextColor(0, 0, 0);

  yPos += 10;

  // ‚îÄ‚îÄ Signature lines ‚îÄ‚îÄ
  pdf.setDrawColor(0, 0, 0);
  pdf.setLineWidth(0.3);
  pdf.line(30, yPos, 85, yPos);
  pdf.line(110, yPos, 165, yPos);

  yPos += 4;
  pdf.setFontSize(8);
  pdf.setFont(undefined, 'normal');
  pdf.text('Records Officer', 57, yPos, { align: 'center' });
  pdf.text('Registrar', 137, yPos, { align: 'center' });

  yPos += 10;

  // ‚îÄ‚îÄ Footer ‚îÄ‚îÄ
  pdf.setDrawColor(22, 90, 40);
  pdf.setLineWidth(0.5);
  pdf.line(20, yPos, 190, yPos);

  yPos += 4;
  pdf.setFontSize(7.5);
  pdf.setFont(undefined, 'bold');
  pdf.setTextColor(0, 0, 0);
  pdf.text('This is an official document of The University of Manila', 105, yPos, { align: 'center' });

  yPos += 3;
  pdf.setFontSize(6.5);
  pdf.setFont(undefined, 'normal');
  pdf.setTextColor(100, 100, 100);
  const docId = `RC-${student.student_id}-${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}`;
  pdf.text(`Document ID: ${docId}`, 105, yPos, { align: 'center' });

  yPos += 3;
  pdf.text('Generated electronically. No signature required for digital records.', 105, yPos, { align: 'center' });

  // ‚îÄ‚îÄ Save ‚îÄ‚îÄ
  const filename = `Report_Card_${student.student_id}_${new Date().getFullYear()}.pdf`;
  pdf.save(filename);

  setTimeout(() => {
    alert(
      '‚úÖ PDF downloaded!\n\n' +
      'üìÅ File: ' + filename + '\n' +
      'üìã Includes per-semester grouping with individual GWA per semester.\n' +
      'üí° Passing threshold: 3.0 and below (Filipino GWA scale).'
    );
  }, 500);
}
// Update loadUserProfile function to include profile picture
async function loadUserProfile() {
  try {
    console.log("üîç Loading user profile...");
    
    const res = await fetch("/student/payments/me", {
      credentials: "include"
    });

    console.log("üì° Response status:", res.status);

    if (!res.ok) {
      const storedStudentId = localStorage.getItem("student_id");
      
      if (storedStudentId) {
        console.log("‚ö†Ô∏è API failed but found stored student ID:", storedStudentId);
        document.getElementById("profileName").textContent = "Student";
        document.getElementById("profileStudentId").textContent = `ID: ${storedStudentId}`;
        document.getElementById("profileYearLevel").textContent = "Loading...";
      } else {
        console.error("‚ùå No session found - redirecting to login");
        alert("Your session has expired. Please login again.");
        window.location.href = "/login.html";
      }
      return;
    }

    const data = await res.json();
    console.log("‚úÖ Received data:", data);
    
    userData = data;

    if (data.student_name) {
      document.getElementById("profileName").textContent = data.student_name;
      console.log("‚úÖ Name set:", data.student_name);
    } else {
      console.warn("‚ö†Ô∏è No student_name in response");
      document.getElementById("profileName").textContent = "Student";
    }
    
    if (data.student_id) {
      document.getElementById("profileStudentId").textContent = `ID: ${data.student_id}`;
      localStorage.setItem("student_id", data.student_id);
    }
    
    if (data.year_level) {
      document.getElementById("profileYearLevel").textContent = `Year: ${data.year_level}`;
    }

    // ‚¨ÖÔ∏è NEW: Handle profile picture
    if (data.profile_picture && data.profile_picture.trim() !== '') {
      currentProfilePicture = data.profile_picture;
      updateProfilePictureDisplay(`/${data.profile_picture}`);
    } else {
      currentProfilePicture = null;
      updateProfilePictureDisplay(null);
    }

  } catch (err) {
    console.error("üí• Error loading profile:", err);
    
    const storedStudentId = localStorage.getItem("student_id");
    if (storedStudentId) {
      document.getElementById("profileName").textContent = "Student";
      document.getElementById("profileStudentId").textContent = `ID: ${storedStudentId}`;
      document.getElementById("profileYearLevel").textContent = "Unable to load";
    } else {
      document.getElementById("profileName").textContent = "Connection Error";
      document.getElementById("profileStudentId").textContent = "Please try again";
    }
  }
}

// Update profile picture display
function updateProfilePictureDisplay(imageUrl) {
  const sidebarAvatar = document.querySelector('.profile-avatar');
  
  if (imageUrl) {
    if (sidebarAvatar) {
      sidebarAvatar.innerHTML = `<img src="${imageUrl}" alt="Profile Picture" />`;
    }
  } else {
    if (sidebarAvatar) {
      sidebarAvatar.innerHTML = 'üë§';
    }
  }
}

// Show profile settings modal
async function showProfileSettings(event) {
  if (event) event.preventDefault();
  
  try {
    const res = await fetch('/student/profile', {
      credentials: 'include'
    });
    
    if (!res.ok) throw new Error('Failed to load profile');
    
    const profile = await res.json();
    
    // Create profile modal HTML
    const profileHTML = `
      <div id="profileModal" class="profile-modal">
        <div class="profile-modal-content">
          <div class="profile-modal-header">
            <h2>üë§ Profile Settings</h2>
            <span class="close" onclick="closeProfileModal()" style="color: white; cursor: pointer; font-size: 32px; line-height: 1;">&times;</span>
          </div>
          
          <div class="profile-modal-body">
            <!-- Profile Picture Section -->
            <div class="profile-picture-section">
              <h3 style="font-size: 16px; font-weight: 700; color: #165a28; margin-bottom: 15px;">Profile Picture</h3>
              
              <div class="profile-picture-preview" id="profilePicturePreview" onclick="triggerFileInput()">
                ${profile.profile_picture 
                  ? `<img src="/${profile.profile_picture}" alt="Profile Picture" />`
                  : '<span style="font-size: 48px;">üë§</span>'
                }
                <div class="profile-picture-overlay">
                  Click to change
                </div>
              </div>
              
              <div style="margin-top: 15px;">
                <div class="upload-btn-wrapper">
                  <button type="button" class="upload-picture-btn" onclick="triggerFileInput()">
                    <span>üì∏</span> Upload Picture
                  </button>
                  <input type="file" id="profilePictureInput" accept="image/jpeg,image/jpg,image/png,image/gif" onchange="handleProfilePictureUpload(event)" style="display: none;" />
                </div>
                ${profile.profile_picture ? `
                  <button type="button" class="remove-picture-btn" onclick="removeProfilePicture()">
                    üóëÔ∏è Remove
                  </button>
                ` : ''}
              </div>
              
              <div class="upload-hint">
                üìå Accepted: JPG, PNG, GIF ‚Ä¢ Max size: 5MB
              </div>
            </div>
            
            <!-- Personal Information -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="font-size: 16px; color: #165a28; margin: 0 0 15px 0; font-weight: 700;">Personal Information</h3>
              <div style="display: grid; gap: 10px; font-size: 13px;">
                <div><strong>Student ID:</strong> ${profile.student_id}</div>
                <div><strong>Full Name:</strong> ${profile.student_name}</div>
                <div><strong>Email:</strong> ${profile.email || 'Not set'}</div>
                <div><strong>Contact:</strong> ${profile.contact_number || 'Not set'}</div>
                <div><strong>Address:</strong> ${profile.address || 'Not set'}</div>
              </div>
            </div>
            
            <!-- Academic Information -->
            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="font-size: 16px; color: #165a28; margin: 0 0 15px 0; font-weight: 700;">Academic Information</h3>
              <div style="display: grid; gap: 10px; font-size: 13px;">
                <div><strong>Course:</strong> ${profile.course}</div>
                <div><strong>Course Code:</strong> ${profile.course_code}</div>
                <div><strong>Year Level:</strong> ${profile.year_level}</div>
              </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 12px;">
              <button type="button" class="action-btn secondary" style="flex: 1;" onclick="showEditProfile(event)">
                <span>‚úèÔ∏è</span> Edit Profile
              </button>
              <button type="button" class="action-btn secondary" style="flex: 1;" onclick="showChangePassword(event)">
                <span>üîí</span> Change Password
              </button>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
              <button type="button" onclick="closeProfileModal()" style="background: #6c757d; color: white; border: none; padding: 10px 30px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('profileModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // Insert new modal
    document.body.insertAdjacentHTML('beforeend', profileHTML);
    
    // Show modal
    document.getElementById('profileModal').style.display = 'block';
    
  } catch (err) {
    console.error(err);
    alert('‚ùå Failed to load profile information');
  }
}

// Add this new function to trigger file input
function triggerFileInput() {
  const fileInput = document.getElementById('profilePictureInput');
  if (fileInput) {
    fileInput.click();
  }
}

// Handle profile picture upload
async function handleProfilePictureUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Validate file size (5MB)
  if (file.size > 5 * 1024 * 1024) {
    alert('‚ùå File is too large. Maximum size is 5MB.');
    return;
  }
  
  // Validate file type
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
  if (!allowedTypes.includes(file.type)) {
    alert('‚ùå Invalid file type. Please upload JPG, PNG, or GIF.');
    return;
  }
  
  // Show preview immediately
  const reader = new FileReader();
  reader.onload = function(e) {
    const preview = document.getElementById('profilePicturePreview');
    if (preview) {
      preview.innerHTML = `
        <img src="${e.target.result}" alt="Profile Picture" />
        <div class="profile-picture-overlay">Click to change</div>
      `;
    }
  };
  reader.readAsDataURL(file);
  
  // Upload to server
  const formData = new FormData();
  formData.append('profile_picture', file);
  
  try {
    const res = await fetch('/student/profile/upload-picture', {
      method: 'POST',
      credentials: 'include',
      body: formData
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      alert('‚ùå ' + (data.error || 'Upload failed'));
      // Reload profile to restore previous picture
      showProfileSettings();
      return;
    }
    
    console.log('‚úÖ Profile picture uploaded:', data.profile_picture);
    
    // Update profile picture everywhere
    const imageUrl = `/${data.profile_picture}`;
    updateProfilePictureDisplay(imageUrl);
    currentProfilePicture = data.profile_picture;
    
    // Add remove button if not exists
    const uploadSection = document.querySelector('.profile-picture-section');
    if (uploadSection && !uploadSection.querySelector('.remove-picture-btn')) {
      const uploadWrapper = uploadSection.querySelector('.upload-btn-wrapper');
      if (uploadWrapper) {
        uploadWrapper.insertAdjacentHTML('afterend', `
          <button class="remove-picture-btn" onclick="removeProfilePicture()">
            üóëÔ∏è Remove
          </button>
        `);
      }
    }
    
    alert('‚úÖ Profile picture updated successfully!');
    
  } catch (err) {
    console.error(err);
    alert('‚ùå Server error occurred. Please try again.');
  }
}

// Remove profile picture
async function removeProfilePicture() {
  if (!confirm('Are you sure you want to remove your profile picture?')) {
    return;
  }
  
  // For now, we'll just update the display to default
  // You can add a backend endpoint to actually delete the file
  
  const preview = document.getElementById('profilePicturePreview');
  if (preview) {
    preview.innerHTML = `
      <span style="font-size: 48px;">üë§</span>
      <div class="profile-picture-overlay">Click to change</div>
    `;
  }
  
  updateProfilePictureDisplay(null);
  currentProfilePicture = null;
  
  // Remove the remove button
  const removeBtn = document.querySelector('.remove-picture-btn');
  if (removeBtn) {
    removeBtn.remove();
  }
  
  alert('‚úÖ Profile picture removed. Upload a new one to change it.');
}

window.addEventListener('click', function(event) {
  const modal = document.getElementById('profileModal');
  if (event.target === modal) {
    closeProfileModal();
  }
});
// Close profile modal
function closeProfileModal() {
  const modal = document.getElementById('profileModal');
  if (modal) {
    modal.style.display = 'none';
    setTimeout(() => modal.remove(), 300);
  }
}

// Show edit profile form
// Show edit profile form
function showEditProfile(event) {
  if (event) event.preventDefault();
  
  // Close current modal
  closeProfileModal();
  
  // Get name parts
  let firstName = '';
  let lastName = '';
  
  if (userData?.first_name && userData?.last_name) {
    firstName = userData.first_name;
    lastName = userData.last_name;
  } else if (userData?.student_name) {
    const nameParts = userData.student_name.split(' ');
    firstName = nameParts[0] || '';
    lastName = nameParts.slice(1).join(' ') || '';
  }
  
  // Create edit profile modal
  const editHTML = `
    <div id="editProfileModal" class="profile-modal">
      <div class="profile-modal-content">
        <div class="profile-modal-header">
          <h2>‚úèÔ∏è Edit Profile</h2>
          <span class="close" onclick="closeEditProfileModal()" style="color: white; cursor: pointer; font-size: 32px; line-height: 1;">&times;</span>
        </div>
        
        <div class="profile-modal-body">
          <form id="editProfileForm" onsubmit="handleProfileUpdate(event)">
            <div class="form-group">
              <label class="form-label">First Name *</label>
              <input 
                type="text"
                id="editFirstName"
                class="form-input"
                value="${firstName}"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">Last Name *</label>
              <input 
                type="text"
                id="editLastName"
                class="form-input"
                value="${lastName}"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">Email Address *</label>
              <input 
                type="email"
                id="editEmail"
                class="form-input"
                value="${userData?.email || ''}"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">Contact Number</label>
              <input 
                type="text"
                id="editContact"
                class="form-input"
                value="${userData?.contact_number || ''}"
                placeholder="e.g., 09123456789"
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">Address</label>
              <textarea 
                id="editAddress"
                class="form-input"
                rows="3"
                placeholder="Complete address"
              >${userData?.address || ''}</textarea>
            </div>
            
            <div class="info-box" style="margin-bottom: 20px;">
              <strong>üìå Note:</strong> Academic information (Student ID, Course, Year Level) cannot be modified through this form.
              Please contact the Registrar's Office for any changes.
            </div>
            
            <div style="display: flex; gap: 12px;">
              <button type="submit" class="action-btn primary" style="flex: 1;">
                <span>üíæ</span> Save Changes
              </button>
              <button type="button" class="action-btn secondary" style="flex: 1;" onclick="closeEditProfileModal()">
                <span>‚ùå</span> Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', editHTML);
  document.getElementById('editProfileModal').style.display = 'block';
}

// Close edit profile modal
function closeEditProfileModal() {
  const modal = document.getElementById('editProfileModal');
  if (modal) {
    modal.style.display = 'none';
    setTimeout(() => modal.remove(), 300);
  }
}

// Handle profile update
async function handleProfileUpdate(event) {
  event.preventDefault();
  
  const firstName = document.getElementById('editFirstName').value.trim();
  const lastName = document.getElementById('editLastName').value.trim();
  const email = document.getElementById('editEmail').value.trim();
  const contactNumber = document.getElementById('editContact').value.trim();
  const address = document.getElementById('editAddress').value.trim();
  
  if (!firstName || !lastName || !email) {
    alert('‚ö†Ô∏è Please fill in all required fields (First Name, Last Name, Email)');
    return;
  }
  
  if (!confirm('Save changes to your profile?')) return;
  
  try {
    const res = await fetch('/student/profile/update', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        first_name: firstName,
        last_name: lastName,
        email: email,
        contact_number: contactNumber,
        address: address
      })
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      alert('‚ùå ' + (data.error || 'Update failed'));
      return;
    }
    
    alert('‚úÖ Profile updated successfully!');
    
    // Update displayed name
    const fullName = firstName + ' ' + lastName;
    document.getElementById("profileName").textContent = fullName;
    document.getElementById("headerUserName").textContent = fullName;
    
    // Reload user data
    await loadUserProfile();
    
    // Close modal
    closeEditProfileModal();
    
  } catch (err) {
    console.error(err);
    alert('‚ùå Server error occurred. Please try again.');
  }
}

// Show change password form
function showChangePassword(event) {
  if (event) event.preventDefault();
  
  // Close current modal
  closeProfileModal();
  
  // Create change password modal
  const passwordHTML = `
    <div id="changePasswordModal" class="profile-modal">
      <div class="profile-modal-content">
        <div class="profile-modal-header">
          <h2>üîí Change Password</h2>
          <span class="close" onclick="closeChangePasswordModal()" style="color: white; cursor: pointer; font-size: 32px; line-height: 1;">&times;</span>
        </div>
        
        <div class="profile-modal-body">
          <div class="info-box warning" style="margin-bottom: 20px;">
            <strong>‚ö†Ô∏è Security Notice:</strong><br>
            Make sure your new password is strong and unique. Don't share it with anyone.
          </div>
          
          <form id="changePasswordForm" onsubmit="handlePasswordChange(event)">
            <div class="form-group">
              <label class="form-label">Current Password</label>
              <input 
                type="password"
                id="currentPassword"
                class="form-input"
                required
                placeholder="Enter your current password"
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">New Password</label>
              <input 
                type="password"
                id="newPassword"
                class="form-input"
                required
                minlength="6"
                placeholder="Enter new password (min. 6 characters)"
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">Confirm New Password</label>
              <input 
                type="password"
                id="confirmPassword"
                class="form-input"
                required
                minlength="6"
                placeholder="Re-enter new password"
              />
            </div>
            
            <div class="info-box" style="margin-bottom: 20px;">
              <strong>üìå Password Requirements:</strong><br>
              ‚Ä¢ Minimum 6 characters<br>
              ‚Ä¢ Mix of letters and numbers recommended<br>
              ‚Ä¢ Avoid common passwords
            </div>
            
            <div style="display: flex; gap: 12px;">
              <button type="submit" class="action-btn primary" style="flex: 1;">
                <span>üîê</span> Change Password
              </button>
              <button type="button" class="action-btn secondary" style="flex: 1;" onclick="closeChangePasswordModal()">
                <span>‚ùå</span> Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', passwordHTML);
  document.getElementById('changePasswordModal').style.display = 'block';
}

// Close change password modal
function closeChangePasswordModal() {
  const modal = document.getElementById('changePasswordModal');
  if (modal) {
    modal.style.display = 'none';
    setTimeout(() => modal.remove(), 300);
  }
}

// Handle password change
async function handlePasswordChange(event) {
  event.preventDefault();
  
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (newPassword !== confirmPassword) {
    alert('‚ö†Ô∏è New passwords do not match!');
    return;
  }
  
  if (newPassword.length < 6) {
    alert('‚ö†Ô∏è Password must be at least 6 characters long');
    return;
  }
  
  if (!confirm('Are you sure you want to change your password?')) return;
  
  try {
    const res = await fetch('/student/change-password', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        current_password: currentPassword,
        new_password: newPassword
      })
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      alert('‚ùå ' + (data.error || 'Password change failed'));
      return;
    }
    
    alert('‚úÖ Password changed successfully!\n\nPlease use your new password for future logins.');
    
    // Close modal
    closeChangePasswordModal();
    
    // Clear form
    document.getElementById('changePasswordForm').reset();
    
  } catch (err) {
    console.error(err);
    alert('‚ùå Server error occurred. Please try again.');
  }
}


// Click outside to close modals
window.addEventListener('click', function(event) {
  // Profile modal
  const profileModal = document.getElementById('profileModal');
  if (event.target === profileModal) {
    closeProfileModal();
  }
  
  // Edit profile modal
  const editModal = document.getElementById('editProfileModal');
  if (event.target === editModal) {
    closeEditProfileModal();
  }
  
  // Change password modal
  const passwordModal = document.getElementById('changePasswordModal');
  if (event.target === passwordModal) {
    closeChangePasswordModal();
  }
  
  // Settings modal
  const settingsModal = document.getElementById('settingsModal');
  if (event.target === settingsModal) {
    closeSettingsModal();
  }
});

function showMaterials(event) {
  if (event) event.preventDefault();
  
  document.getElementById("dashboardView").style.display = "none";
  document.getElementById("billingView").style.display = "none";
  document.getElementById("scheduleView").style.display = "none";
  document.getElementById("documentsView").style.display = "none";
  document.getElementById("gradesView").style.display = "none";
  document.getElementById("materialsView").style.display = "block";
    document.getElementById("enrollmentView").style.display = "none";

  document.getElementById("pageTitle").textContent = "Lesson Materials";
  document.getElementById("breadcrumbCurrent").textContent = "Lesson Materials";
  
  updateActiveNav(3); // Adjust index based on position
  loadLessonMaterials();
  loadMySubmissions();
}
// ==================== LESSON MATERIALS FUNCTIONS ====================

let currentLessons = [];
let currentSubmissions = [];
let selectedLessonForSubmit = null;

// Load lesson materials
async function loadLessonMaterials() {
  const container = document.getElementById('materialsContainer');
  const messageDiv = document.getElementById('materialsMessage');
  
  container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Loading materials...</div>';
  messageDiv.innerHTML = '';
  
  try {
    const res = await fetch('/student/lessons', {
      credentials: 'include'
    });
    
    if (!res.ok) {
      throw new Error('Failed to fetch lessons');
    }
    
    const data = await res.json();
    console.log('üìö Lessons data:', data);
    
    if (!data.lessons || data.lessons.length === 0) {
      container.innerHTML = `
        <div class="empty-materials">
          <div class="empty-materials-icon">üìö</div>
          <h3>No Materials Available Yet</h3>
          <p>Your teachers haven't uploaded any lesson materials yet.<br>Check back later for updates.</p>
        </div>
      `;
      return;
    }
    
    currentLessons = data.lessons;
    displayLessonMaterials(data.lessons);
    
  } catch (err) {
    console.error('Error loading materials:', err);
    container.innerHTML = `
      <div class="info-box warning">
        <strong>‚ö†Ô∏è Unable to Load Materials</strong><br>
        There was an error loading lesson materials. Please try again later.
      </div>
    `;
  }
}

// Display lesson materials
function displayLessonMaterials(lessons) {
  const container = document.getElementById('materialsContainer');
  
  let html = '';
  
  lessons.forEach(lesson => {
    const fileIcon = getFileIcon(lesson.file_type);
    const uploadDate = new Date(lesson.uploaded_at).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
    
    html += `
      <div class="materials-card">
        <div class="material-header">
          <div style="flex: 1;">
            <div class="material-title">
              ${fileIcon} ${lesson.title}
            </div>
            <div class="material-meta">
              <span>üìö ${lesson.subject} (${lesson.subject_code})</span>
              <span>üë®‚Äçüè´ ${lesson.teacher_name}</span>
              <span>üìÖ ${uploadDate}</span>
            </div>
          </div>
        </div>
        
        ${lesson.description ? `
          <div class="material-description">
            ${lesson.description}
          </div>
        ` : ''}
        
        <div class="material-actions">
          ${lesson.file_path ? `
            <a 
              href="/${lesson.file_path}" 
              target="_blank"
              class="material-download-btn"
            >
              <span>üì•</span> Download Material
            </a>
          ` : ''}
          
          <button 
            class="material-submit-btn" 
            onclick="openSubmitModal(${lesson.lesson_id}, '${lesson.title.replace(/'/g, "\\'")}', '${lesson.subject.replace(/'/g, "\\'")}')"
          >
            <span>üì§</span> Submit Assignment
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Get file icon based on type
function getFileIcon(fileType) {
  const icons = {
    'pdf': 'üìï',
    'document': 'üìÑ',
    'presentation': 'üìä',
    'spreadsheet': 'üìà',
    'image': 'üñºÔ∏è',
    'video': 'üé•',
    'text': 'üìù'
  };
  
  return icons[fileType] || 'üìé';
}

// Open submit modal
function openSubmitModal(lessonId, lessonTitle, subjectName) {
  console.log('üîì Opening submit modal with lesson_id:', lessonId); // ‚úÖ DEBUG
  
 if (!lessonId) {
  alert("‚ùå Invalid lesson ID");
  return;
}

selectedLessonForSubmit = lessonId.toString();
  
  const modalHTML = `
    <div id="submitModal" class="submit-modal">
      <div class="submit-modal-content">
        <div class="submit-modal-header">
          <h2>üì§ Submit Assignment</h2>
          <span class="close" onclick="closeSubmitModal()" style="color: white; cursor: pointer; font-size: 28px; line-height: 1;">&times;</span>
        </div>
        
        <div class="submit-modal-body">
          <div class="info-box" style="margin-bottom: 20px;">
            <strong>üìö Lesson:</strong> ${lessonTitle}<br>
            <strong>üìñ Subject:</strong> ${subjectName}<br>
            <strong>üÜî Lesson ID:</strong> ${lessonId}
          </div>
          
          <!-- ‚úÖ ADD HIDDEN INPUT AS BACKUP -->
          <input type="hidden" id="hiddenLessonId" value="${lessonId}" />
          
          <form id="submitAssignmentForm" onsubmit="handleSubmission(event)">
            <div class="form-group">
              <label class="form-label">Submission Title *</label>
              <input 
                type="text"
                id="submissionTitle"
                class="form-input"
                placeholder="e.g., Chapter 1 Activity Answer Sheet"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">Description (Optional)</label>
              <textarea 
                id="submissionDescription"
                class="form-input"
                rows="3"
                placeholder="Add any notes or comments about your submission..."
              ></textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label">Upload File *</label>
              <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('submissionFile').click()">
                <div class="file-upload-icon">üìÅ</div>
                <div class="file-upload-text">Click to select a file</div>
                <div class="file-upload-hint">
                  Accepted: PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX, JPG, PNG, TXT (Max: 10MB)
                </div>
              </div>
              <input 
                type="file"
                id="submissionFile"
                accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.jpg,.jpeg,.png,.txt"
                style="display: none;"
                onchange="handleFileSelect(event)"
                required
              />
              <div id="fileSelectedInfo" class="file-selected-info" style="display: none;">
                <strong>Selected File:</strong>
                <p id="selectedFileName"></p>
              </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button type="submit" class="action-btn primary" style="flex: 1;">
                <span>üì§</span> Submit Assignment
              </button>
              <button type="button" class="action-btn secondary" style="flex: 1;" onclick="closeSubmitModal()">
                <span>‚ùå</span> Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.getElementById('submitModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  document.getElementById('submitModal').style.display = 'block';
  
  console.log('‚úÖ Modal opened, selectedLessonForSubmit =', selectedLessonForSubmit);
}

// Close submit modal
function closeSubmitModal() {
  const modal = document.getElementById('submitModal');
  if (modal) {
    modal.style.display = 'none';
    setTimeout(() => modal.remove(), 300);
  }
  selectedLessonForSubmit = null;
}

// Handle file select
function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Validate file size (10MB)
  if (file.size > 10 * 1024 * 1024) {
    alert('‚ùå File is too large. Maximum size is 10MB.');
    event.target.value = '';
    return;
  }
  
  // Show selected file info
  const fileInfo = document.getElementById('fileSelectedInfo');
  const fileName = document.getElementById('selectedFileName');
  
  if (fileInfo && fileName) {
    fileName.textContent = file.name + ' (' + formatFileSize(file.size) + ')';
    fileInfo.style.display = 'block';
  }
  
  // Update upload area styling
  const uploadArea = document.getElementById('fileUploadArea');
  if (uploadArea) {
    uploadArea.classList.add('active');
  }
}

// Format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Handle submission
async function handleSubmission(event) {
  event.preventDefault();

  const title = document.getElementById('submissionTitle').value.trim();
  const description = document.getElementById('submissionDescription').value.trim();
  const fileInput = document.getElementById('submissionFile');
  const file = fileInput.files[0];

  if (!title || !file) {
    alert('‚ö†Ô∏è Please fill in all required fields');
    return;
  }

  // ‚úÖ ALWAYS GET lesson_id from hidden input first
  const hiddenLesson = document.getElementById('hiddenLessonId')?.value;

  // fallback to global variable
  const lessonId = hiddenLesson || selectedLessonForSubmit;

  console.log("DEBUG lesson_id:", lessonId);

  if (!lessonId) {
    alert('‚ùå Lesson ID missing. Please reopen submission form.');
    return;
  }

  if (!confirm(`Submit "${title}" for this assignment?`)) return;

  const formData = new FormData();

  formData.append('lesson_id', String(lessonId));
  formData.append('title', title);
  formData.append('description', description);
  formData.append('file', file);

  try {
    const res = await fetch('/student/submissions/upload', {
      method: 'POST',
      credentials: 'include',
      body: formData
    });

    const data = await res.json();

    if (!res.ok) {
      alert('‚ùå ' + (data.error || 'Submission failed'));
      return;
    }

    alert("‚úÖ Submission uploaded!");

    closeSubmitModal();
    loadMySubmissions();

  } catch (err) {
    console.error(err);
    alert('‚ùå Server error');
  }
}


// Load my submissions
async function loadMySubmissions() {
  const container = document.getElementById('submissionsContainer');
  
  container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Loading submissions...</div>';
  
  try {
    const res = await fetch('/student/submissions', {
      credentials: 'include'
    });
    
    if (!res.ok) {
      throw new Error('Failed to fetch submissions');
    }
    
    const data = await res.json();
    console.log('üì§ Submissions data:', data);
    
    if (!data.submissions || data.submissions.length === 0) {
      container.innerHTML = `
        <div class="empty-materials">
          <div class="empty-materials-icon">üì§</div>
          <h3>No Submissions Yet</h3>
          <p>You haven't submitted any assignments yet.<br>Submit your work using the buttons above.</p>
        </div>
      `;
      return;
    }
    
    currentSubmissions = data.submissions;
    displaySubmissions(data.submissions);
    
  } catch (err) {
    console.error('Error loading submissions:', err);
    container.innerHTML = `
      <div class="info-box warning">
        <strong>‚ö†Ô∏è Unable to Load Submissions</strong><br>
        There was an error loading your submissions. Please try again later.
      </div>
    `;
  }
}

// Display submissions
function displaySubmissions(submissions) {
  const container = document.getElementById('submissionsContainer');
  
  let html = '';
  
  submissions.forEach(sub => {
    const fileIcon = getFileIcon(sub.file_type);
    const submitDate = new Date(sub.submitted_at).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    const hasGrade = sub.grade && sub.grade > 0;
    const hasFeedback = sub.feedback && sub.feedback.trim() !== '';
    
    html += `
      <div class="submission-card">
        <div class="submission-header">
          <div style="flex: 1;">
            <div class="submission-title">
              ${fileIcon} ${sub.title}
            </div>
            <div class="submission-meta">
              <span>üìö ${sub.subject}</span>
              <span>üìù ${sub.lesson_title}</span>
              <span>üìÖ ${submitDate}</span>
            </div>
          </div>
          ${hasGrade ? `
            <div style="text-align: right;">
              <div style="font-size: 24px; font-weight: 700; color: #165a28;">
                ${sub.grade}/100
              </div>
              <div style="font-size: 11px; color: #666;">Grade</div>
            </div>
          ` : `
            <span class="status-badge status-pending">Pending Review</span>
          `}
        </div>
        
        ${sub.description ? `
          <div class="material-description" style="margin-top: 8px;">
            <strong>Your Notes:</strong> ${sub.description}
          </div>
        ` : ''}
        
        ${hasFeedback ? `
          <div class="teacher-remarks">
            <strong>üë®‚Äçüè´ Teacher Feedback:</strong>
            <p>${sub.feedback}</p>
          </div>
        ` : ''}
        
        <div class="material-actions" style="margin-top: 12px;">
          <a 
            href="/${sub.file_path}" 
            target="_blank"
            class="material-download-btn"
          >
            <span>üì•</span> View My Submission
          </a>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Click outside to close submit modal
window.addEventListener('click', function(event) {
  const modal = document.getElementById('submitModal');
  if (event.target === modal) {
    closeSubmitModal();
  }
});

// ESC key to close submit modal
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' || event.key === 'Esc') {
    const modal = document.getElementById('submitModal');
    if (modal && modal.style.display === 'block') {
      closeSubmitModal();
    }
  }
});

// ===================== LOGOUT FUNCTION =====================

async function handleLogout(event) {
  if (event) event.preventDefault();
  
  if (!confirm('Are you sure you want to logout?')) {
    return;
  }
  
  try {
    const res = await fetch('/logout', {
      method: 'POST',
      credentials: 'include'
    });
    
    // Clear local storage
    localStorage.clear();
    sessionStorage.clear();
    
    // ‚úÖ Use replace() instead of href to prevent back button
    window.location.replace('/login.html');
    
  } catch (err) {
    console.error('Logout error:', err);
    localStorage.clear();
    sessionStorage.clear();
    window.location.replace('/login.html');
  }
}

// ===================== SETTINGS FUNCTION =====================

function showSettings(event) {
  if (event) event.preventDefault();
  
  // Create settings modal
  const settingsHTML = `
    <div id="settingsModal" class="profile-modal">
      <div class="profile-modal-content">
        <div class="profile-modal-header">
          <h2>‚öôÔ∏è Settings</h2>
          <span class="close" onclick="closeSettingsModal()" style="color: white; cursor: pointer; font-size: 32px; line-height: 1;">&times;</span>
        </div>
        
        <div class="profile-modal-body">
          <!-- Account Settings -->
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="font-size: 16px; color: #165a28; margin: 0 0 15px 0; font-weight: 700;">Account Settings</h3>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <button type="button" class="action-btn secondary" onclick="showEditProfile(event); closeSettingsModal();">
                <span>‚úèÔ∏è</span> Edit Profile Information
              </button>
              
              <button type="button" class="action-btn secondary" onclick="showChangePassword(event); closeSettingsModal();">
                <span>üîí</span> Change Password
              </button>
              
              <button type="button" class="action-btn secondary" onclick="triggerFileInput(); closeSettingsModal(); showProfileSettings(event);">
                <span>üì∏</span> Update Profile Picture
              </button>
            </div>
          </div>
          
          <!-- Notifications Settings -->
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="font-size: 16px; color: #165a28; margin: 0 0 15px 0; font-weight: 700;">Notification Preferences</h3>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="notifPayments" checked style="width: 18px; height: 18px;">
                <span style="font-size: 14px;">Payment notifications</span>
              </label>
              
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="notifGrades" checked style="width: 18px; height: 18px;">
                <span style="font-size: 14px;">Grade release notifications</span>
              </label>
              
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="notifMaterials" checked style="width: 18px; height: 18px;">
                <span style="font-size: 14px;">New lesson materials</span>
              </label>
              
              
            </div>
          </div>
          
          <!-- Privacy & Security -->
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="font-size: 16px; color: #165a28; margin: 0 0 15px 0; font-weight: 700;">Privacy & Security</h3>
            
            <div class="info-box" style="margin-bottom: 15px;">
              <strong>üîê Session Status:</strong> Active<br>
              <strong>üì± Device:</strong> ${navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop'}<br>
              <strong>üåê Browser:</strong> ${navigator.userAgent.includes('Chrome') ? 'Chrome' : navigator.userAgent.includes('Firefox') ? 'Firefox' : 'Other'}
            </div>
            
            <button type="button" class="action-btn secondary" onclick="clearLocalData()" style="width: 100%;">
              <span>üóëÔ∏è</span> Clear Local Cache
            </button>
          </div>
          
          <!-- About -->
          <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="font-size: 16px; color: #165a28; margin: 0 0 15px 0; font-weight: 700;">About</h3>
            <p style="font-size: 13px; color: #555; margin: 0;">
              <strong>Student Portal System</strong><br>
              Version 1.0.0<br>
              The University of Manila<br>
              ¬© 2026 All Rights Reserved
            </p>
          </div>
          
          <!-- Actions -->
          <div style="display: flex; gap: 12px;">
            <button type="button" class="action-btn secondary" onclick="closeSettingsModal()" style="flex: 1;">
              <span>‚ùå</span> Close
            </button>
            
            <button type="button" class="action-btn primary" onclick="handleLogout(event)" style="flex: 1; background: #dc3545;">
              <span>üö™</span> Logout
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.getElementById('settingsModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Insert new modal
  document.body.insertAdjacentHTML('beforeend', settingsHTML);
  
  // Show modal
  document.getElementById('settingsModal').style.display = 'block';
}

// Close settings modal
function closeSettingsModal() {
  const modal = document.getElementById('settingsModal');
  if (modal) {
    modal.style.display = 'none';
    setTimeout(() => modal.remove(), 300);
  }
}

// Clear local data
function clearLocalData() {
  if (!confirm('This will clear all cached data. Continue?')) {
    return;
  }
  
  try {
    localStorage.clear();
    sessionStorage.clear();
    alert('‚úÖ Local cache cleared successfully!');
  } catch (err) {
    console.error('Error clearing cache:', err);
    alert('‚ùå Failed to clear cache');
  }
}


// ==================== END DOCUMENT REQUEST FUNCTIONS ====================
// Initialize
window.onload = function() {
  // ‚úÖ Check auth status immediately on page load
  checkAuthStatus();
  
  loadUserProfile();
  showDashboard();
  getPayments();
  
  // Load notifications every 30 seconds
  setInterval(loadNotifications, 30000);
};

window.addEventListener('pageshow', function(event) {
  // Check if page was loaded from cache (back button)
  if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
    // Check if user is actually logged in
    checkAuthStatus();
  }
});

async function checkAuthStatus() {
  try {
    const res = await fetch("/student/payments/me", {
      credentials: "include"
    });
    
    if (!res.ok) {
      // Not authenticated - redirect to login
      console.log("‚ö†Ô∏è Session expired - redirecting to login");
      window.location.replace('/login.html');
    }
  } catch (err) {
    // Error checking auth - redirect to login
    console.error("‚ùå Auth check failed:", err);
    window.location.replace('/login.html');
  }
}

window.addEventListener('beforeunload', function() {
  // This doesn't fully prevent caching but helps
  document.body.style.display = 'none';
});

// ===== SHOW ENROLLMENT VIEW =====
function showEnrollment(event) {
  if (event) event.preventDefault();

  ['dashboardView','billingView','scheduleView','documentsView',
   'gradesView','materialsView'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  document.getElementById('enrollmentView').style.display = 'block';
  document.getElementById('pageTitle').textContent = 'Re-Enrollment';
  document.getElementById('breadcrumbCurrent').textContent = 'Re-Enrollment';
     
  document.querySelector('.content-wrapper').scrollTop = 0;

 updateActiveNav(6);
loadEnrollmentCourses();
loadEnrollmentHistory();
  
  // ‚úÖ Autofill after a short delay to ensure userData is loaded
  setTimeout(() => {
    prefillEnrollmentFromProfile();
  }, 300);
}

// ===== LOAD COURSES INTO ENROLLMENT DROPDOWN =====
async function loadEnrollmentCourses() {
  try {
    const res     = await fetch('/public/courses');
    const courses = await res.json();
    const sel     = document.getElementById('enroll_course');
    sel.innerHTML = '<option value="">Select a course</option>';
    courses.forEach(c => {
      const opt       = document.createElement('option');
      opt.value       = c.id;
      opt.textContent = c.course_name;
      sel.appendChild(opt);
    });
    
    // ‚úÖ Autofill after courses are loaded
    prefillEnrollmentFromProfile();
    
  } catch (err) { console.error('Failed to load courses:', err); }
}
function prefillEnrollmentFromProfile() {
  if (typeof userData === 'undefined' || !userData) return;

  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el && val) el.value = val;
  };

  // Read-only display boxes
  const idEl   = document.getElementById('enroll_student_id_display');
  const nameEl = document.getElementById('enroll_fullname_display');
  if (idEl   && userData.student_id)   idEl.textContent   = userData.student_id;
  if (nameEl && userData.student_name) nameEl.textContent = userData.student_name;

  // Editable name fields
  if (userData.first_name) set('enroll_first_name', userData.first_name);
  if (userData.last_name)  set('enroll_last_name',  userData.last_name);
  if (!userData.first_name && !userData.last_name && userData.student_name) {
    const parts = userData.student_name.trim().split(' ');
    set('enroll_first_name', parts[0] || '');
    set('enroll_last_name',  parts[parts.length - 1] || '');
    if (parts.length > 2) set('enroll_middle_name', parts.slice(1, -1).join(' '));
  }

  // Contact info
  set('enroll_email',   userData.email);
  set('enroll_contact', userData.contact_number);
  set('enroll_address', userData.address);

  // Scholarship
  if (userData.scholarship_status) {
    const map = {
      'Scholar': 'scholar', 'Non-Scholar': 'non-scholar',
      'scholar': 'scholar', 'non-scholar': 'non-scholar', 'None': 'non-scholar'
    };
    set('enroll_scholarship', map[userData.scholarship_status] || '');
  }

  updateEnrollProgress();
}


// ===== LOAD SUBJECTS BASED ON COURSE + YEAR + SEMESTER =====
async function loadEnrollmentSubjects() {
  const course   = document.getElementById('enroll_course').value;
  const year     = document.getElementById('enroll_year_level').value;
  const semester = document.getElementById('enroll_semester').value;
  const prompt   = document.getElementById('enroll_subjects_prompt');
  const sel      = document.getElementById('enroll_subjects');

  if (!course || !year || !semester) {
    prompt.style.display = 'block';
    prompt.innerHTML = `<div style="font-size:28px;margin-bottom:8px;">üìö</div>
      <div>Please select your <strong>Course</strong>, <strong>Year Level</strong>,
      and <strong>Semester</strong> first to load available subjects.</div>`;
    sel.style.display = 'none';
    document.getElementById('enroll_selected_display').style.display = 'none';
    return;
  }

  prompt.style.display = 'block';
  prompt.innerHTML = '<div style="font-size:24px;margin-bottom:8px;">‚è≥</div><div>Loading subjects...</div>';
  sel.style.display  = 'none';

  try {
    const res      = await fetch(`/public/subjects?course_id=${course}&year_level=${year}&semester=${encodeURIComponent(semester)}`);
    const subjects = await res.json();

    if (!subjects || !subjects.length) {
      prompt.innerHTML = '<div style="font-size:28px;margin-bottom:8px;">üòï</div><div>No subjects found for the selected combination.</div>';
      return;
    }

    sel.innerHTML = '';
    subjects.forEach(s => {
      const opt       = document.createElement('option');
      opt.value       = s.id;
      opt.textContent = `${s.code ? s.code + ' ‚Äî ' : ''}${s.subject_name || s.name || ''}`;
      sel.appendChild(opt);
    });

    prompt.style.display = 'none';
    sel.style.display    = 'block';
    document.getElementById('enroll_selected_display').style.display = 'none';
    updateEnrollProgress();

  } catch (err) {
    prompt.innerHTML = '<div style="font-size:28px;margin-bottom:8px;">‚ö†Ô∏è</div><div>Error loading subjects. Please try again.</div>';
    console.error(err);
  }
}

// ===== UPDATE SELECTED SUBJECTS DISPLAY =====
function updateEnrollSelectedSubjects() {
  const sel      = document.getElementById('enroll_subjects');
  const selected = Array.from(sel.selectedOptions);
  const display  = document.getElementById('enroll_selected_display');
  const list     = document.getElementById('enroll_selected_list');
  const count    = document.getElementById('enroll_selected_count');

  if (selected.length > 0) {
    display.style.display = 'block';
    count.textContent     = selected.length;
    list.innerHTML        = '';
    selected.forEach(opt => {
      const tag = document.createElement('span');
      tag.style.cssText = 'background:#165a28; color:white; padding:4px 10px; border-radius:20px; font-size:12px; display:inline-flex; align-items:center; gap:6px;';
      tag.innerHTML = `${opt.textContent}
        <span style="cursor:pointer; font-size:10px; opacity:0.8;"
              onclick="enrollRemoveSubject('${opt.value}')">‚úï</span>`;
      list.appendChild(tag);
    });
  } else {
    display.style.display = 'none';
  }
}

function enrollRemoveSubject(id) {
  const opt = Array.from(document.getElementById('enroll_subjects').options).find(o => o.value === id);
  if (opt) { opt.selected = false; updateEnrollSelectedSubjects(); updateEnrollProgress(); }
}


// ===== SUBMIT ENROLLMENT =====
async function submitEnrollment(event) {
  event.preventDefault();
  const g  = id => (document.getElementById(id)?.value || '').trim();
  const selectedSubjects = Array.from(
    document.getElementById('enroll_subjects').selectedOptions
  ).map(o => o.value);

  const msgEl = document.getElementById('enrollmentMessage');
  msgEl.innerHTML = '';

  const showMsg = (type, text) => {
    const colors = {
      error:   { bg:'#ffebee', border:'#f44336', color:'#c62828' },
      success: { bg:'#e8f5e9', border:'#4caf50', color:'#2e7d32' },
    };
    const c = colors[type];
    msgEl.style.cssText = `background:${c.bg}; border-left:4px solid ${c.border}; color:${c.color};
      padding:12px 16px; border-radius:6px; font-size:13px; font-weight:600; margin-bottom:16px;`;
    msgEl.innerHTML = text;
    msgEl.scrollIntoView({ behavior:'smooth', block:'center' });
  };

  if (!g('enroll_first_name') || !g('enroll_last_name'))
    return showMsg('error', '‚ö†Ô∏è Please enter your first and last name.');
  if (!g('enroll_contact') || !g('enroll_email') || !g('enroll_address'))
    return showMsg('error', '‚ö†Ô∏è Please fill in contact number, email, and address.');
  if (!g('enroll_last_school') || !g('enroll_last_school_year'))
    return showMsg('error', '‚ö†Ô∏è Please fill in last school attended and school year.');
  if (!g('enroll_academic_year') || !g('enroll_semester') || !g('enroll_year_level') || !g('enroll_course') || !g('enroll_scholarship'))
    return showMsg('error', '‚ö†Ô∏è Please complete all required academic fields.');
  if (!selectedSubjects.length)
    return showMsg('error', '‚ö†Ô∏è Please select at least one subject.');

  const btn  = document.querySelector('#enrollmentForm button[type="submit"]');
  const orig = btn.innerHTML;
  btn.innerHTML = '‚è≥ Submitting Application...';
  btn.disabled  = true;

  try {
    const res = await fetch('/student/enroll', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        academic_year:          g('enroll_academic_year'),
        year_level:             parseInt(g('enroll_year_level')),
        semester:               g('enroll_semester'),
        course_id:              parseInt(g('enroll_course')),
        subjects:               selectedSubjects,
        scholarship_status:     g('enroll_scholarship'),
        first_name:             g('enroll_first_name'),
        middle_name:            g('enroll_middle_name'),
        last_name:              g('enroll_last_name'),
        age:                    parseInt(g('enroll_age')) || 18,
        contact_number:         g('enroll_contact'),
        email:                  g('enroll_email'),
        address:                g('enroll_address'),
        father_first_name:      g('enroll_father_first_name'),
        father_middle_name:     g('enroll_father_middle_name'),
        father_last_name:       g('enroll_father_last_name'),
        father_occupation:      g('enroll_father_occupation'),
        father_contact_number:  g('enroll_father_contact'),
        father_address:         g('enroll_father_address'),
        mother_first_name:      g('enroll_mother_first_name'),
        mother_middle_name:     g('enroll_mother_middle_name'),
        mother_last_name:       g('enroll_mother_last_name'),
        mother_occupation:      g('enroll_mother_occupation'),
        mother_contact_number:  g('enroll_mother_contact'),
        mother_address:         g('enroll_mother_address'),
        last_school_attended:   g('enroll_last_school'),
        last_school_year:       g('enroll_last_school_year'),
      })
    });

    const data = await res.json();

    if (!res.ok) {
      showMsg('error', '‚úó ' + (data.error || 'Submission failed. Please try again.'));
    } else {
      showMsg('success', '‚úì Application submitted successfully! Your re-enrollment is now pending review.');
      setTimeout(() => {
        document.getElementById('enrollmentForm').reset();
        resetEnrollForm();
        if (typeof loadEnrollmentHistory === 'function') loadEnrollmentHistory();
        if (typeof getPayments === 'function') getPayments();
          refreshStudentData();
      }, 3000);
    }

  } catch (err) {
    showMsg('error', '‚ö†Ô∏è Unable to submit application. Please check your connection and try again.');
  } finally {
    btn.innerHTML = orig;
    btn.disabled  = false;
  }
}

// ===== LOAD ENROLLMENT HISTORY =====
async function loadEnrollmentHistory() {
  const container = document.getElementById('enrollmentHistoryContainer');
  if (!container) return;
  container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Loading...</div>';

  try {
    const res  = await fetch('/student/enrollments', { credentials:'include' });
    const data = await res.json();

    if (!data.enrollments || !data.enrollments.length) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">No enrollment applications yet.</div>';
      return;
    }

    const sc = {
      pending:  { bg:'#fff3e0', border:'#fb8c00', color:'#e65100', label:'‚è≥ Pending'  },
      approved: { bg:'#e8f5e9', border:'#43a047', color:'#2e7d32', label:'‚úÖ Approved' },
      rejected: { bg:'#ffebee', border:'#e53935', color:'#c62828', label:'‚ùå Rejected' },
    };

    container.innerHTML = data.enrollments.map(e => {
      const s = sc[e.status] || sc.pending;
      return `
        <div style="padding:16px; border-left:4px solid ${s.border}; background:${s.bg};
                    border-radius:8px; margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
            <div>
              <div style="font-size:15px; font-weight:700; color:#165a28;">
                ${e.semester} Semester ‚Äî A.Y. ${e.academic_year}
              </div>
              <div style="font-size:12px; color:#666; margin-top:3px;">
                üéì ${e.course} &nbsp;|&nbsp; Year ${e.year_level}
                ${e.total_units ? '&nbsp;|&nbsp; ' + e.total_units + ' units' : ''}
                &nbsp;|&nbsp; ${e.scholarship_status}
              </div>
            </div>
            <span style="background:${s.color}; color:white; padding:4px 12px;
                         border-radius:12px; font-size:11px; font-weight:700; white-space:nowrap;">
              ${s.label}
            </span>
          </div>
          <div style="font-size:12px; color:#555;">
            <strong>Subjects:</strong> ${(e.subjects || []).join(', ') || 'N/A'}
          </div>
          ${e.remarks ? `<div style="margin-top:8px; font-size:12px; color:#555;
            background:rgba(255,255,255,0.7); padding:8px 10px; border-radius:5px;">
            <strong>üìã Registrar's Note:</strong> ${e.remarks}
          </div>` : ''}
          <div style="margin-top:6px; font-size:11px; color:#999;">
            Applied: ${new Date(e.applied_at).toLocaleString()}
            ${e.processed_at ? ' &nbsp;|&nbsp; Processed: ' + new Date(e.processed_at).toLocaleString() : ''}
          </div>
        </div>`;
    }).join('');

  } catch (err) {
    container.innerHTML = '<div style="background:#fff3e0;border-left:4px solid #fb8c00;padding:12px 16px;border-radius:6px;font-size:13px;color:#e65100;">‚ö†Ô∏è Unable to load enrollment history.</div>';
  }
}

function resetEnrollForm() {
  const sel    = document.getElementById('enroll_subjects');
  const prompt = document.getElementById('enroll_subjects_prompt');
  sel.style.display     = 'none';
  sel.innerHTML         = '';
  prompt.style.display  = 'block';
  prompt.innerHTML      = `<div style="font-size:28px;margin-bottom:8px;">üìö</div>
    <div>Please select your <strong>Course</strong>, <strong>Year Level</strong>,
    and <strong>Semester</strong> first to load available subjects.</div>`;
  document.getElementById('enroll_selected_display').style.display  = 'none';
  document.getElementById('enrollProgressIndicator').style.display  = 'none';
  const msg = document.getElementById('enrollmentMessage');
  if (msg) { msg.style.cssText = ''; msg.innerHTML = ''; }
}


function updateEnrollProgress() {
  const required = [
    'enroll_first_name','enroll_last_name','enroll_age',
    'enroll_contact','enroll_email','enroll_address',
    'enroll_last_school','enroll_last_school_year',
    'enroll_course','enroll_year_level',
    'enroll_scholarship','enroll_academic_year','enroll_semester'
  ];
  let filled = required.filter(id => {
    const el = document.getElementById(id);
    return el && el.value.trim();
  }).length;
  const subSel = document.getElementById('enroll_subjects');
  if (subSel && Array.from(subSel.selectedOptions).length > 0) filled++;

  const total = required.length + 1;
  const pct   = Math.round((filled / total) * 100);
  const ind   = document.getElementById('enrollProgressIndicator');
  if (filled > 0) {
    ind.style.display = 'block';
    document.getElementById('enrollProgressFill').style.width    = pct + '%';
    document.getElementById('enrollProgressPercent').textContent = pct + '%';
  }

  async function refreshStudentData() {
  console.log('üîÑ Refreshing student data after enrollment...');
  
  try {
    // Reload schedule data in background
    const schedRes = await fetch('/student/schedule', { credentials: 'include' });
    if (schedRes.ok) {
      const schedData = await schedRes.json();
      if (schedData.schedule) {
        scheduleData = schedData.schedule;
        console.log('‚úÖ Schedule data refreshed');
      }
    }
  } catch (err) { console.log('Schedule refresh skipped:', err); }

  try {
    // Reload lesson materials in background
    const lessonRes = await fetch('/student/lessons', { credentials: 'include' });
    if (lessonRes.ok) {
      const lessonData = await lessonRes.json();
      if (lessonData.lessons) {
        currentLessons = lessonData.lessons;
        console.log('‚úÖ Lessons data refreshed');
      }
    }
  } catch (err) { console.log('Lessons refresh skipped:', err); }

  try {
    // Reload grades in background
    const gradesRes = await fetch('/student/grades', { credentials: 'include' });
    if (gradesRes.ok) {
      console.log('‚úÖ Grades data refreshed');
    }
  } catch (err) { console.log('Grades refresh skipped:', err); }

  // Refresh notifications
  if (typeof loadNotifications === 'function') loadNotifications();

  console.log('‚úÖ All student data refreshed after enrollment');
}
}

</script>

</body>
</html>
